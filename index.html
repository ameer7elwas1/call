<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قسم خدمة الزبائن</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f0f0;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-tertiary: #95a5a6;
            --border-color: #801c32;
            --border-light: rgba(128, 28, 50, 0.3);
            --primary-color: #801c32;
            --primary-hover: #9d2338;
            --primary-light: rgba(128, 28, 50, 0.1);
            --shadow-sm: rgba(128, 28, 50, 0.08);
            --shadow-md: rgba(128, 28, 50, 0.18);
            --shadow-lg: rgba(128, 28, 50, 0.28);
            --card-bg: #ffffff;
            --sidebar-bg: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            --nav-bg: rgba(255, 255, 255, 0.7);
            --nav-hover: rgba(128, 28, 50, 0.08);
            --input-bg: #ffffff;
            --input-border: #801c32;
            --input-focus: rgba(128, 28, 50, 0.4);
            --modal-bg: #ffffff;
            --table-bg: #ffffff;
            --table-header: #801c32;
            --table-border: #e0e0e0;
            --success-color: #28a745;
            --success-light: rgba(40, 167, 69, 0.1);
            --error-color: #dc3545;
            --error-light: rgba(220, 53, 69, 0.1);
            --info-color: #17a2b8;
            --info-light: rgba(23, 162, 184, 0.1);
            --warning-color: #ffc107;
            --warning-light: rgba(255, 193, 7, 0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.18);
            --border-light: rgba(255, 255, 255, 0.12);
            --primary-color: #ff4757;
            --primary-hover: #ff6b7a;
            --primary-light: rgba(255, 71, 87, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.4);
            --shadow-md: rgba(0, 0, 0, 0.6);
            --shadow-lg: rgba(0, 0, 0, 0.8);
            --card-bg: #2d2d2d;
            --sidebar-bg: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            --nav-bg: rgba(45, 45, 45, 0.85);
            --nav-hover: rgba(255, 71, 87, 0.18);
            --input-bg: #3a3a3a;
            --input-border: rgba(255, 255, 255, 0.25);
            --input-focus: rgba(255, 71, 87, 0.5);
            --modal-bg: #2d2d2d;
            --table-bg: #2d2d2d;
            --table-header: #ff4757;
            --table-border: #4a4a4a;
            --success-color: #4ade80;
            --success-light: rgba(74, 222, 128, 0.15);
            --error-color: #f87171;
            --error-light: rgba(248, 113, 113, 0.15);
            --info-color: #60a5fa;
            --info-light: rgba(96, 165, 250, 0.15);
            --warning-color: #fbbf24;
            --warning-light: rgba(251, 191, 36, 0.15);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', 'Segoe UI', 'Arial', sans-serif;
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            overflow-x: hidden;
        }
        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-left: 3px solid var(--primary-color);
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-y: visible;
            overflow-x: hidden;
            transition: transform 0.3s ease;
        }
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(0, 0, 0, 0.2) 100%);
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.3);
        }
        .sidebar.hidden {
            transform: translateX(100%);
        }
        .sidebar-header {
            padding: 20px 15px 15px 15px;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.05) 0%, transparent 100%);
            flex-shrink: 0;
        }
        .sidebar-header h1 {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
        }
        .sidebar-user-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .sidebar-user-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1.5px solid var(--border-light);
            display: inline-block;
            min-width: 120px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 8px 8px;
            overflow-y: visible;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex-shrink: 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.8rem;
            background: var(--nav-bg);
            border: 1.5px solid var(--border-light);
            position: relative;
            flex-shrink: 0;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 0 10px 10px 0;
        }
        .nav-item:hover,
        .nav-item.active {
            background: var(--nav-hover);
            border-color: var(--primary-color);
            transform: translateX(-4px);
            color: var(--primary-color);
        }
        .nav-item.active::before {
            transform: scaleY(1);
        }
        .nav-item-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        .sidebar-toggle-btn {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1002;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px var(--shadow-md);
            transition: all 0.3s ease;
        }
        .theme-toggle-top {
            position: fixed;
            right: 20px;
            top: 70px;
            z-index: 1002;
        }
        @media (max-width: 1024px) {
            .sidebar-toggle-btn {
                right: 10px;
                top: 10px;
            }
            .theme-toggle-top {
                right: 10px;
                top: 60px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }
            .main-content {
                margin-right: 0;
                width: 100%;
                max-width: 100%;
                padding: 15px 10px;
            }
            .sidebar.hidden ~ .main-content {
                margin-right: 0;
                width: 100%;
            }
            .top-header {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
            }
            .top-header h2 {
                font-size: 1.2rem;
            }
            .header-info {
                width: 100%;
                justify-content: space-between;
            }
            .shift-display {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
            .card {
                padding: 15px;
            }
            .card h3 {
                font-size: 1rem;
            }
            .btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            .btn-group .btn {
                width: 100%;
                justify-content: center;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
            }
            .toast {
                min-width: 280px;
                max-width: calc(100vw - 40px);
            }
            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            .sidebar {
                width: 100%;
                max-width: 100%;
            }
            .main-content {
                padding: 10px 8px;
            }
            .top-header {
                padding: 12px;
                margin-bottom: 15px;
            }
            .top-header h2 {
                font-size: 1rem;
            }
            .shift-display {
                font-size: 0.75rem;
                padding: 6px 10px;
            }
            .card {
                padding: 12px;
                margin-bottom: 15px;
            }
            .card h3 {
                font-size: 0.95rem;
                margin-bottom: 12px;
            }
            .form-group {
                margin-bottom: 12px;
            }
            .form-group label {
                font-size: 0.85rem;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px 10px;
                font-size: 16px;
            }
            .btn {
                padding: 10px 14px;
                font-size: 0.8rem;
            }
            .sidebar-header h1 {
                font-size: 1rem;
            }
            .nav-item {
                padding: 10px 8px;
                font-size: 0.75rem;
            }
            .nav-item-icon {
                font-size: 1rem;
                width: 20px;
            }
            .sidebar-toggle-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            .theme-toggle {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            .stat-card {
                padding: 12px;
            }
            .stat-value {
                font-size: 1.5rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            table {
                font-size: 0.75rem;
            }
            table th,
            table td {
                padding: 8px 6px;
            }
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px auto;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .modal-header h3 {
                font-size: 1rem;
            }
            .toast {
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                padding: 12px 15px;
            }
            .toast-container {
                left: 10px;
                right: 10px;
            }
            #employeeAwardsList {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .employee-stat-item {
                padding: 8px;
                font-size: 0.7rem;
            }
            .charts-section {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            #profilePictureContainer {
                width: 120px !important;
                height: 120px !important;
                font-size: 2rem !important;
            }
            .chat-window {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            .chat-sidebar {
                width: 100%;
                border-left: none;
                border-bottom: 2px solid var(--border-color);
            }
            .chat-messages-area {
                height: calc(100vh - 200px);
            }
            .chat-input-area {
                padding: 10px;
            }
            .login-container {
                padding: 20px 15px;
            }
            .login-form {
                padding: 20px 15px;
            }
            .bar-label {
                min-width: 80px;
                max-width: 80px;
                font-size: 0.7rem;
            }
            .bar-value {
                min-width: 40px;
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 360px) {
            body {
                font-size: 13px;
            }
            .main-content {
                padding: 8px 5px;
            }
            .card {
                padding: 10px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
            .nav-item {
                padding: 8px 6px;
                font-size: 0.7rem;
            }
            .sidebar-header {
                padding: 15px 10px 10px 10px;
            }
            .top-header {
                padding: 10px;
            }
            .stat-card {
                padding: 10px;
            }
            .stat-value {
                font-size: 1.3rem;
            }
            table {
                font-size: 0.7rem;
            }
            table th,
            table td {
                padding: 6px 4px;
            }
        }
        
        .sidebar-toggle-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        /* Main Content */
        .main-content {
            margin-right: 280px;
            padding: 20px;
            transition: margin-right 0.3s ease, width 0.3s ease;
            min-width: 0;
            width: calc(100% - 280px);
            max-width: calc(100% - 280px);
            position: relative;
            z-index: 1;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .sidebar.hidden ~ .main-content {
            margin-right: 0;
            width: 100%;
            max-width: 100%;
        }
        .top-header {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .top-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 700;
        }
        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .shift-display {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 10px 18px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1.5px solid var(--border-light);
        }
        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Tab Content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: var(--card-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            padding: 18px 20px;
            box-shadow: 0 2px 6px var(--shadow-sm);
            margin-bottom: 20px;
        }
        .card h3 {
            color: var(--primary-color);
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1.5px solid var(--border-light);
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2.5px solid #801c32;
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Tajawal', sans-serif;
            box-shadow: 0 2px 4px rgba(128, 28, 50, 0.1);
            transition: all 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #801c32;
            border-width: 3px;
            box-shadow: 0 0 0 4px rgba(128, 28, 50, 0.15), 0 4px 8px rgba(128, 28, 50, 0.12);
            transform: translateY(-1px);
        }
        .form-group label[for="selectAgent"],
        .form-group label[for="selectDepartment"] {
            color: #801c32;
            font-weight: 800;
            font-size: 1rem;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.08) 0%, rgba(128, 28, 50, 0.05) 100%);
            padding: 10px 14px;
            border-radius: 8px;
            border: 2.5px solid #801c32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group label[for="selectAgent"]::before {
            content: "⭐";
            font-size: 1.2rem;
        }
        .form-group label[for="selectDepartment"]::before {
            content: "⚠️";
            font-size: 1.2rem;
        }
        #selectAgent,
        #selectDepartment {
            border: 3px solid #801c32;
            background: linear-gradient(135deg, #ffffff 0%, rgba(128, 28, 50, 0.02) 100%);
            font-weight: 600;
            color: #801c32;
        }
        #selectAgent:focus,
        #selectDepartment:focus {
            border-color: #801c32;
            border-width: 3.5px;
            box-shadow: 0 0 0 5px rgba(128, 28, 50, 0.2), 0 4px 12px rgba(128, 28, 50, 0.15);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            .employee-stat-item {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-md);
        }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
        }
        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .btn-danger {
            background: var(--error-color);
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        .btn-info {
            background: var(--info-color);
            color: white;
        }
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }
        .btn-warning {
            background: var(--warning-color);
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        .btn-whatsapp:hover {
            background: #20BA5A;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1.5px solid;
        }
        .alert-success {
            background: var(--success-light);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .alert-error {
            background: var(--error-light);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        .alert-info {
            background: var(--info-light);
            border-color: var(--info-color);
            color: var(--info-color);
        }
        [data-theme="dark"] .alert-success {
            background: var(--success-light);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        [data-theme="dark"] .alert-error {
            background: var(--error-light);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        [data-theme="dark"] .alert-info {
            background: var(--info-light);
            border-color: var(--info-color);
            color: var(--info-color);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .toast {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 320px;
            max-width: 450px;
            box-shadow: 0 4px 20px var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 14px;
            animation: slideInLeft 0.3s ease;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .toast.hiding {
            transform: translateX(-100%);
            opacity: 0;
        }
        .toast.success {
            border-color: var(--success-color);
            background: var(--success-light);
        }
        .toast.error {
            border-color: var(--error-color);
            background: var(--error-light);
        }
        .toast.warning {
            border-color: var(--warning-color);
            background: var(--warning-light);
        }
        .toast.info {
            border-color: var(--info-color);
            background: var(--info-light);
        }
        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--error-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        .toast-close:hover {
            background: var(--bg-secondary);
        }
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Real-time Validation */
        .input-error {
            border-color: var(--error-color) !important;
            background: var(--error-light) !important;
        }
        .input-success {
            border-color: var(--success-color) !important;
        }
        .validation-message {
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            padding: 5px 10px;
            border-radius: 6px;
            background: var(--error-light);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        .validation-message.show {
            display: block;
        }
        .validation-message.error {
            color: var(--error-color);
            background: var(--error-light);
            border-color: var(--error-color);
        }
        .validation-message.success {
            color: var(--success-color);
            background: var(--success-light);
            border-color: var(--success-color);
        }
        
        /* تحسين المظهر الليلي - تحسين التباين */
        [data-theme="dark"] .card {
            background: var(--card-bg);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .stat-card-title,
        [data-theme="dark"] .stat-card-change {
            color: var(--text-secondary);
        }
        [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3 {
            color: var(--text-primary);
        }
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--table-bg);
        }
        table th {
            background: var(--table-header);
            color: white;
            padding: 10px 12px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--table-border);
        }
        table td {
            padding: 10px 12px;
            border: 1px solid var(--table-border);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        table tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        table tr:hover {
            background: var(--nav-hover);
        }
        /* Search Results */
        
        .search-results {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
        }
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .search-result-item:hover {
            background: var(--bg-secondary);
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        /* Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }
        .login-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 24px var(--shadow-lg);
            width: 100%;
            max-width: 450px;
        }
        .login-card h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
        }
        .hidden {
            display: none !important;
        }
        /* Agent Management */
        .agent-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .agent-info {
            flex: 1;
        }
        .agent-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .agent-phone {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .agent-actions {
            display: flex;
            gap: 10px;
        }
        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px var(--shadow-sm);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100px;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            z-index: 1;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 8px 24px var(--shadow-md);
        }
        .stat-card:hover::after {
            opacity: 1;
        }
        .stat-card:nth-child(1) {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(59, 130, 246, 0.05) 100%);
        }
        .stat-card:nth-child(1)::before {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        .stat-card:nth-child(2) {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
        .stat-card:nth-child(2)::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        .stat-card:nth-child(3) {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        .stat-card:nth-child(3)::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        .stat-card:nth-child(4) {
            border-color: #06b6d4;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.12) 0%, rgba(6, 182, 212, 0.05) 100%);
        }
        .stat-card:nth-child(4)::before {
            background: linear-gradient(90deg, #06b6d4, #0891b2);
        }
        .stat-card:nth-child(5) {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        .stat-card:nth-child(5)::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        .stat-card:nth-child(6) {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(139, 92, 246, 0.05) 100%);
        }
        .stat-card:nth-child(6)::before {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        .stat-card-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 35px;
            line-height: 1;
        }
        .stat-card:nth-child(1) .stat-card-icon {
            color: #3b82f6;
        }
        .stat-card:nth-child(2) .stat-card-icon {
            color: #ef4444;
        }
        .stat-card:nth-child(3) .stat-card-icon {
            color: #10b981;
        }
        .stat-card:nth-child(4) .stat-card-icon {
            color: #06b6d4;
        }
        .stat-card:nth-child(5) .stat-card-icon {
            color: #f59e0b;
        }
        .stat-card:nth-child(6) .stat-card-icon {
            color: #8b5cf6;
        }
        .stat-card-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: none;
        }
        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 0;
            line-height: 1.1;
            font-family: 'Tajawal', sans-serif;
            letter-spacing: -1px;
        }
        .stat-card:nth-child(1) .stat-card-value {
            color: #3b82f6;
        }
        .stat-card:nth-child(2) .stat-card-value {
            color: #ef4444;
        }
        .stat-card:nth-child(3) .stat-card-value {
            color: #10b981;
        }
        .stat-card:nth-child(4) .stat-card-value {
            color: #06b6d4;
        }
        .stat-card:nth-child(5) .stat-card-value {
            color: #f59e0b;
        }
        .stat-card:nth-child(6) .stat-card-value {
            color: #8b5cf6;
        }
        .stat-card-change {
            font-size: 0.65rem;
            color: var(--text-tertiary);
            margin-top: auto;
            min-height: 0;
        }
        .stat-card-change.positive {
            color: #28a745;
        }
        .stat-card-change.negative {
            color: #dc3545;
        }
        /* Employee of the Week Banner */
        .employee-of-week-banner {
            position: relative;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            border: 2px solid #ffb300;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 18px rgba(255, 179, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            overflow: hidden;
            animation: employeeBannerGlow 3s ease-in-out infinite;
        }
        [data-theme="dark"] .employee-of-week-banner {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-color: #ffd700;
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.3), 0 0 0 1px rgba(255, 215, 0, 0.1) inset;
        }
        @keyframes employeeBannerGlow {
            0%, 100% { box-shadow: 0 8px 24px rgba(255, 179, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) inset; }
            50% { box-shadow: 0 8px 32px rgba(255, 179, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.2) inset; }
        }
        .employee-of-week-content {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 2;
        }
        .employee-of-week-icon {
            font-size: 2.5rem;
            animation: trophyBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2));
        }
        @keyframes trophyBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        .employee-of-week-info {
            flex: 1;
        }
        .employee-of-week-label {
            font-size: 0.75rem;
            color: #8b6914;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        [data-theme="dark"] .employee-of-week-label {
            color: #ffd700;
        }
        .employee-of-week-name {
            font-size: 1.4rem;
            font-weight: 800;
            color: #8b6914;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] .employee-of-week-name {
            color: #ffd700;
            text-shadow: 2px 2px 8px rgba(255, 215, 0, 0.3);
        }
        .employee-of-week-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .employee-stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #8b6914;
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 10px;
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        [data-theme="dark"] .employee-stat-item {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        .stat-icon {
            font-size: 0.9rem;
        }
        .employee-of-week-period {
            font-size: 0.75rem;
            color: #8b6914;
            font-weight: 500;
            margin-top: 3px;
        }
        [data-theme="dark"] .employee-of-week-period {
            color: #ffd700;
        }
        .employee-of-week-badge {
            font-size: 2.2rem;
            animation: crownFloat 2.5s ease-in-out infinite;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2));
        }
        @keyframes crownFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(-5deg); }
        }
        .employee-of-week-shine {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            animation: shine 4s infinite;
            pointer-events: none;
        }
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        /* Chat Window */
        .chat-window {
            display: none !important;
        }
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary-hover);
        }
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .chat-header-info h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .chat-status {
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }
        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        .close-chat:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .chat-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .chat-sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-search {
            padding: 15px;
            border-bottom: 1px solid var(--border-light);
        }
        .chat-search input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .chat-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .chat-users-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-user-item {
            padding: 14px;
            margin-bottom: 6px;
            background: var(--card-bg);
            border: 1.5px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .chat-user-item:hover {
            background: linear-gradient(135deg, var(--nav-hover) 0%, var(--bg-secondary) 100%);
            border-color: var(--primary-color);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .chat-user-item.active {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%);
            border-color: var(--primary-color);
            border-width: 2px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }
        .chat-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .chat-user-info {
            flex: 1;
        }
        .chat-user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        .chat-user-last-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-user-unread {
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            position: absolute;
            left: 10px;
            top: 10px;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-no-selection {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .chat-no-selection-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .chat-messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-messages-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        [data-theme="dark"] .chat-messages-header {
            background: #202c33;
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        [data-theme="dark"] #chat .chat-main {
            background: #0b141a !important;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.02) 10px, rgba(255,255,255,.02) 20px) !important;
        }
        [data-theme="dark"] #chat .chat-messages-header {
            background: #202c33 !important;
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        }
        [data-theme="dark"] #chat .chat-input-area {
            background: #202c33 !important;
            border-top-color: rgba(255, 255, 255, 0.1) !important;
        }
        [data-theme="dark"] #chat .chat-input-area textarea {
            background: #2a3942 !important;
            color: #e9edef !important;
        }
        .chat-messages-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-status {
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 600;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: #efeae2;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,.03) 10px, rgba(0,0,0,.03) 20px);
        }
        [data-theme="dark"] .chat-messages {
            background: #0b141a;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.02) 10px, rgba(255,255,255,.02) 20px);
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }
        .chat-message {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            animation: messageSlide 0.3s ease;
            position: relative;
            width: 100%;
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.sent {
            align-self: flex-end;
            margin-left: auto;
            margin-right: 0;
            flex-direction: row-reverse;
            width: 100%;
        }
        .chat-message.received {
            align-self: flex-start;
            margin-right: auto;
            margin-left: 0;
            flex-direction: row;
            width: 100%;
        }
        .chat-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .chat-message.received .chat-message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chat-message-content {
            position: relative;
            padding: 8px 12px 6px 12px;
            border-radius: 8px;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .chat-message.sent .chat-message-content {
            background: linear-gradient(135deg, #DCF8C6 0%, #C8E6C9 100%);
            border-top-right-radius: 0;
            border-bottom-right-radius: 4px;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] .chat-message.sent .chat-message-content {
            background: linear-gradient(135deg, #056162 0%, #0a7c7c 100%);
            color: #e9edef;
        }
        .chat-message.received .chat-message-content {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            border-top-left-radius: 0;
            border-bottom-left-radius: 4px;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] .chat-message.received .chat-message-content {
            background: linear-gradient(135deg, #202c33 0%, #2a3942 100%);
            color: #e9edef;
        }
        .chat-message-text {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            color: #111b21;
        }
        [data-theme="dark"] .chat-message-text {
            color: #e9edef;
        }
        .chat-message.sent .chat-message-text {
            color: #111b21;
        }
        [data-theme="dark"] .chat-message.sent .chat-message-text {
            color: #e9edef;
        }
        .chat-message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
            color: #667781;
        }
        [data-theme="dark"] .chat-message-time {
            color: #8696a0;
        }
        .chat-message.sent .chat-message-time {
            color: #667781;
        }
        [data-theme="dark"] .chat-message.sent .chat-message-time {
            color: #8696a0;
        }
        .message-status {
            font-size: 0.65rem;
            opacity: 0.7;
            color: #8696a0;
        }
        .message-status.sent {
            color: #8696a0;
        }
        .message-status.delivered {
            color: #8696a0;
        }
        .message-status.read {
            color: #53bdeb;
        }
        .chat-input-area {
            padding: 8px 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            background: #f0f2f5;
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        [data-theme="dark"] .chat-input-area {
            background: #202c33;
            border-top-color: rgba(255, 255, 255, 0.1);
        }
        .chat-input-area textarea {
            flex: 1;
            padding: 9px 12px;
            border: none;
            border-radius: 24px;
            background: #ffffff;
            color: #111b21;
            font-size: 0.95rem;
            resize: none;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.2s ease;
            min-height: 42px;
            max-height: 120px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        [data-theme="dark"] .chat-input-area textarea {
            background: #2a3942;
            color: #e9edef;
        }
        .chat-input-area textarea:focus {
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .chat-input-area textarea::placeholder {
            color: #667781;
        }
        .chat-send-btn {
            padding: 10px 20px;
            white-space: nowrap;
            border-radius: 24px;
            font-weight: 600;
            background: #25D366;
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(37, 211, 102, 0.3);
            transition: all 0.2s ease;
            min-width: 60px;
        }
        .chat-send-btn:hover {
            background: #20ba5a;
            box-shadow: 0 4px 8px rgba(37, 211, 102, 0.4);
            transform: scale(1.02);
        }
        .chat-send-btn:active {
            transform: scale(0.98);
        }
        .unread-badge {
            background: var(--error-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: auto;
        }
        @media (max-width: 768px) {
            .chat-window {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            .chat-sidebar {
                width: 100%;
                border-left: none;
                border-bottom: 2px solid var(--border-color);
            }
            .chat-messages-area {
                height: calc(100vh - 180px);
            }
            .chat-input-area {
                padding: 8px;
            }
            .chat-user-item {
                padding: 10px 8px;
            }
            .chat-message {
                max-width: 85%;
                padding: 8px 12px;
            }
            .chat-message-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            .chat-message-content {
                font-size: 0.85rem;
            }
            .chat-message-time {
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 480px) {
            .chat-message {
                max-width: 90%;
                padding: 6px 10px;
            }
            .chat-message-avatar {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
            }
            .chat-message-content {
                font-size: 0.8rem;
            }
            .chat-messages-header {
                padding: 10px 12px;
            }
            .chat-user-avatar {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            .chat-user-name {
                font-size: 0.85rem;
            }
            .chat-user-last-message {
                font-size: 0.75rem;
            }
            .search-results {
                max-height: 400px;
            }
            .search-result-item {
                padding: 12px;
            }
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 5px auto;
                padding: 12px;
                max-height: 95vh;
            }
            .modal-header {
                padding: 12px;
            }
            .modal-header h3 {
                font-size: 1rem;
            }
            .employee-of-week-banner {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }
            .employee-of-week-info {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
        }
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .top-header {
                flex-direction: column;
                align-items: stretch;
            }
            .header-info {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .shift-display {
                width: 100%;
                text-align: center;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn-group .btn {
                width: 100%;
            }
            .table-container {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            table {
                min-width: 600px;
            }
        }
        .chart-card {
            background: var(--card-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px var(--shadow-sm);
        }
        .chart-card h4 {
            color: var(--primary-color);
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1.5px solid var(--border-light);
        }
        .chart-container {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1.5px solid var(--border-color);
        }
        .bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
        }
        .bar-item:hover {
            transform: translateX(-3px);
            box-shadow: 0 3px 8px var(--shadow-sm);
            border-color: var(--primary-color);
        }
        .bar-label {
            min-width: 100px;
            max-width: 100px;
            font-size: 0.75rem;
            color: var(--text-primary);
            font-weight: 700;
            text-align: right;
        }
        .bar-wrapper {
            flex: 1;
            height: 22px;
            background: var(--bg-tertiary);
            border-radius: 11px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .bar-fill {
            height: 100%;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 8px;
            color: white;
            font-weight: 700;
            font-size: 0.7rem;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .bar-value {
            min-width: 50px;
            text-align: left;
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 800;
            font-family: 'Tajawal', sans-serif;
        }
        /* ألوان مختلفة للرسوم البيانية */
        .chart-card:nth-child(1) .bar-fill {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        .chart-card:nth-child(2) .bar-fill {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        /* Agents Stats Table */
        .agents-stats-table {
            width: 100%;
            margin-top: 20px;
        }
        .agents-stats-table th {
            background: var(--table-header);
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }
        .agents-stats-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-light);
        }
        .agents-stats-table tr:hover {
            background: var(--bg-secondary);
        }
        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px var(--shadow-sm);
        }
        .refresh-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-md);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: 700;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px 10px;
        }
        .close-modal:hover {
            color: var(--primary-color);
        }
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-right: 0;
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .agents-stats-table th,
            .agents-stats-table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            .login-card {
                padding: 20px 15px;
                margin: 10px;
            }
            .login-card h1 {
                font-size: 1.5rem;
            }
            .employee-of-week-banner {
                padding: 12px;
            }
            .employee-of-week-stats {
                flex-direction: column;
                gap: 8px;
            }
            .employee-of-week-stat-item {
                width: 100%;
            }
        }
        
        @media (max-width: 360px) {
            .login-card {
                padding: 15px 10px;
            }
            .login-card h1 {
                font-size: 1.3rem;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px;
            }
        }
        
        @media (orientation: landscape) and (max-height: 500px) {
            .sidebar {
                width: 250px;
            }
            .main-content {
                padding: 10px;
            }
            .top-header {
                padding: 10px;
                margin-bottom: 15px;
            }
            .card {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>قسم خدمة الزبائن</h1>
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="loginUsername">اسم المستخدم</label>
                <input type="text" id="loginUsername" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label for="loginPassword">كلمة المرور</label>
                <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور">
            </div>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%;">تسجيل الدخول</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>قسم خدمة الزبائن</h1>
                <div class="sidebar-user-info" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <div style="position: relative; width: 60px; height: 60px;">
                        <img id="sidebarUserAvatar" class="sidebar-user-avatar" src="" alt="صورة المستخدم" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary-color); display: none; object-fit: cover;">
                        <div id="sidebarUserInitials" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; border: 2px solid var(--primary-color);"></div>
                    </div>
                    <div id="sidebarUser" class="sidebar-user-name" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); text-align: center; letter-spacing: 0.5px; border: 2px solid rgba(255, 255, 255, 0.2);">Ameer Helwas</div>
                </div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="switchTab('dashboard')">
                    <span class="nav-item-icon"></span>
                    <span>الاحصائيات</span>
                </div>
                <div class="nav-item" onclick="switchTab('customer')">
                    <span class="nav-item-icon"></span>
                    <span>إدخال بيانات المشتركين الجدد</span>
                </div>
                <div class="nav-item" onclick="switchTab('call')">
                    <span class="nav-item-icon"></span>
                    <span>تفاصيل المكالمات</span>
                </div>
                <div class="nav-item" onclick="switchTab('agents')">
                    <span class="nav-item-icon"></span>
                    <span>وكلاء عراق سيل</span>
                </div>
                <div class="nav-item" onclick="switchTab('departments')">
                    <span class="nav-item-icon"></span>
                    <span>أقسام الشركة</span>
                </div>
                <div class="nav-item" onclick="switchTab('chat')">
                    <span class="nav-item-icon"></span>
                    <span> محادثة الموظفين</span>
                    <span id="unreadMessagesBadge" class="unread-badge" style="display: none;">0</span>
                </div>
                <div class="nav-item" onclick="switchTab('notes')">
                    <span class="nav-item-icon"></span>
                    <span>ملاحظاتي</span>
                </div>
                <div class="nav-item" onclick="switchTab('reports')">
                    <span class="nav-item-icon"></span>
                    <span>تصدير </span>
                </div>
                <div class="nav-item admin-only" onclick="switchTab('advanced-stats')" style="display: none;">
                    <span class="nav-item-icon"></span>
                    <span>إحصائيات متقدمة</span>
                </div>
                <div class="nav-item admin-only" onclick="switchTab('users')" style="display: none;">
                    <span class="nav-item-icon"></span>
                    <span>إدارة المستخدمين</span>
                </div>
                <div class="nav-item" onclick="switchTab('profile')">
                    <span class="nav-item-icon">👤</span>
                    <span>الملف الشخصي</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-secondary" onclick="switchUser()" style="width: 100%; background: #6c757d; border-color: #6c757d; color: white;" id="switchUserBtn">
                    <span id="switchUserText">تبديل المستخدم</span> <span style="margin-right: 5px;">↻</span>
                </button>
            </div>
        </div>

        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()">☰</button>
        
        <!-- Theme Toggle Button (Top Right) -->
        <button class="theme-toggle theme-toggle-top" onclick="toggleTheme()" id="themeToggle" title="تبديل الوضع">🌙</button>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="top-header">
                <h2 id="pageTitle">الاحصائيات</h2>
                <div class="header-info">
                    <div class="shift-display" id="shiftDisplay">الشفت الصباحي</div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    
                    <!-- Employee of the Week Banner -->
                    <div id="employeeOfTheWeekBanner" class="employee-of-week-banner" style="display: none;">
                        <div class="employee-of-week-content">
                            <div class="employee-of-week-icon">🏆</div>
                            <div class="employee-of-week-info">
                                <div class="employee-of-week-label">الموظف المثالي لهذا الأسبوع</div>
                                <div class="employee-of-week-name" id="employeeOfWeekName">-</div>
                                <div class="employee-of-week-stats">
                                    <span class="employee-stat-item">
                                        <span class="stat-icon">📞</span>
                                        <span id="employeeOfWeekCalls">0</span> مكالمة
                                    </span>
                                    <span class="employee-stat-item">
                                        <span class="stat-icon">👥</span>
                                        <span id="employeeOfWeekCustomers">0</span> مشترك جديد
                                    </span>
                                    <span class="employee-stat-item">
                                        <span class="stat-icon">⭐</span>
                                        <span id="employeeOfWeekScore">0</span> نقطة
                                    </span>
                        </div>
                                <div class="employee-of-week-period" id="employeeOfWeekPeriod"></div>
                            </div>
                            <div class="employee-of-week-badge">👑</div>
                        </div>
                        <div class="employee-of-week-shine"></div>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">المكالمات</div>
                            <div class="stat-card-value" id="totalCalls">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">الشكاوى</div>
                            <div class="stat-card-value" id="totalComplaints">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">المشتركين الجدد</div>
                            <div class="stat-card-value" id="totalCustomers">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">الرسائل المرسلة</div>
                            <div class="stat-card-value" id="totalSent">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">وكلاء عراق سيل</div>
                            <div class="stat-card-value" id="totalAgents">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"></div>
                            <div class="stat-card-title">أقسام الشركة</div>
                            <div class="stat-card-value" id="totalDepartments">0</div>
                            <div class="stat-card-change"></div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-section">
                        <div class="chart-card">
                            <h4>توزيع أنواع المكالمات</h4>
                            <div class="chart-container">
                                <div class="bar-chart" id="callsTypeChart"></div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>المكالمات حسب الموظف</h4>
                            <div class="chart-container">
                                <div class="bar-chart" id="callsByEmployeeChart"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Agents Statistics -->
                    <div class="card">
                        <h3>إحصائيات الوكلاء</h3>
                        <div class="table-container">
                            <table class="agents-stats-table">
                                <thead>
                                    <tr>
                                        <th>اسم الوكيل</th>
                                        <th>عدد المشتركين المرسلين</th>
                                        <th>آخر إرسال</th>
                                        <th>آخر موظف أرسل</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsStatsTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                                            لا توجد بيانات
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card">
                        <h3>النشاطات الأخيرة</h3>
                        <div id="recentActivity" style="padding: 20px; color: var(--text-primary); text-align: center;">
                            جاري تحميل البيانات...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Data Tab -->
            <div id="customer" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">إدخال بيانات المشترك</h3>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportCustomersToExcel()">تصدير Excel</button>
                        </div>
                    </div>
                    <div id="customerAlert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="txtName">اسم المشترك *</label>
                            <input type="text" id="txtName" placeholder="أدخل اسم المشترك">
                        </div>
                        <div class="form-group">
                            <label for="txtRegion">المنطقة *</label>
                            <input type="text" id="txtRegion" placeholder="أدخل المنطقة">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="txtNearestPoint">أقرب نقطة دالة *</label>
                            <input type="text" id="txtNearestPoint" placeholder="أدخل أقرب نقطة دالة">
                        </div>
                        <div class="form-group">
                            <label for="txtPhone">رقم الهاتف *</label>
                            <input type="text" id="txtPhone" placeholder="أدخل رقم الهاتف">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="txtDate">التاريخ</label>
                            <input type="date" id="txtDate">
                        </div>
                        <div class="form-group" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.05) 0%, rgba(128, 28, 50, 0.02) 100%); padding: 15px; border-radius: 12px; border: 2.5px solid #801c32; margin-top: 10px;">
                            <label for="selectAgent">اختر الوكيل *</label>
                            <select id="selectAgent" required style="font-weight: 600;">
                                <option value="">اختر الوكيل</option>
                            </select>
                            <small style="color: #801c32; font-size: 0.9rem; display: block; margin-top: 8px; font-weight: 600;">
                                ⚠️ سيتم إرسال بيانات المشترك تلقائياً للوكيل المحدد عبر واتساب
                            </small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtNotes">الملاحظات</label>
                        <textarea id="txtNotes" placeholder="أدخل الملاحظات"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveCustomerData()">حفظ وإرسال للوكيل</button>
                        <button class="btn btn-secondary" onclick="clearCustomerForm()">مسح الحقول</button>
                    </div>
                    
                    <!-- البحث عن المشتركين -->
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: var(--primary-color);">البحث عن المشتركين</h3>
                            <div class="btn-group">
                                <button class="btn btn-secondary" id="exportSearchBtn" onclick="exportSearchResultsToExcel()" style="display: none;">تصدير Excel</button>
                            </div>
                        </div>
                        <div id="searchAlert"></div>
                        <div class="form-group">
                            <label for="txtSearch">نص البحث</label>
                            <input type="text" id="txtSearch" placeholder="ابحث في المشتركين (اسم، رقم هاتف، منطقة...)" onkeyup="filterCustomers()">
                        </div>
                        <div class="btn-group" style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="loadAllCustomers()">عرض جميع المشتركين</button>
                            <button class="btn btn-secondary" onclick="searchCustomers()">بحث متقدم</button>
                        </div>
                        <div class="table-container">
                            <table id="searchResultsTable" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>المنطقة</th>
                                        <th>أقرب نقطة دالة</th>
                                        <th>الهاتف</th>
                                        <th>التاريخ</th>
                                        <th>الملاحظات</th>
                                        <th>الموظف</th>
                                        <th>الوكيل</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsList">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                            اضغط على "عرض جميع المشتركين" لعرض المشتركين
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Details Tab -->
            <div id="call" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">تفاصيل المكالمة</h3>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportCallsToExcel()">تصدير Excel</button>
                        </div>
                    </div>
                    <div id="callAlert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cmbCallType">نوع المكالمة *</label>
                            <select id="cmbCallType">
                                <option value="">اختر نوع المكالمة</option>
                                <option value="استفسار">استفسار</option>
                                <option value="شكوى">شكوى</option>
                                <option value="ضعف بالخدمة">ضعف بالخدمة</option>
                                <option value="طلب اشتراك">طلب اشتراك</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="txtCallPhone">رقم الهاتف *</label>
                            <input type="text" id="txtCallPhone" placeholder="أدخل رقم الهاتف">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtCallName">اسم المتصل *</label>
                        <input type="text" id="txtCallName" placeholder="أدخل اسم المتصل">
                    </div>
                    <div class="form-group">
                        <label for="txtIssueDetails">تفاصيل المكالمة *</label>
                        <textarea id="txtIssueDetails" placeholder="أدخل تفاصيل المكالمة"></textarea>
                    </div>
                    <div class="form-group" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.05) 0%, rgba(128, 28, 50, 0.02) 100%); padding: 15px; border-radius: 12px; border: 2.5px solid #801c32; margin-top: 10px;">
                        <label for="selectDepartment">اختر القسم (للشكاوى والمشاكل)</label>
                        <select id="selectDepartment" style="font-weight: 600;">
                            <option value="">لا يوجد</option>
                        </select>
                        <small style="color: #801c32; font-size: 0.9rem; display: block; margin-top: 8px; font-weight: 600;">
                            ⚠️ يتم إرسال الشكاوى تلقائياً للقسم المختار عبر واتساب
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveCallDetails()">حفظ تفاصيل المكالمة</button>
                        <button class="btn btn-secondary" onclick="clearCallForm()">مسح الحقول</button>
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="loadAllCalls()">عرض جميع المكالمات</button>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="callSearchInput">بحث في المكالمات</label>
                        <input type="text" id="callSearchInput" placeholder="ابحث في المكالمات (اسم، رقم هاتف، نوع المكالمة...)" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border-color);" onkeyup="searchCalls()">
                    </div>
                    <div id="callsListContainer" style="margin-top: 20px; max-height: 600px; overflow-y: auto; padding: 15px;">
                        <div id="callsListBody" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                                <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">📞</div>
                                <p style="font-size: 1.1rem;">اضغط على "عرض جميع المكالمات" لعرض المكالمات</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Agents Management Tab -->
            <div id="agents" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="margin: 0;">إدارة الوكلاء</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openAddAgentModal()">إضافة وكيل جديد</button>
                        </div>
                    </div>
                    <div id="agentsAlert"></div>
                    <div style="margin-bottom: 20px;">
                        <div style="position: relative;">
                            <input type="text" id="agentsSearchInput" placeholder="🔍 ابحث عن وكيل (بالاسم، رقم الهاتف، العنوان)..." onkeyup="filterAgentsList()" style="width: 100%; padding: 12px 45px 12px 14px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-light)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                            <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 1.1rem; opacity: 0.5;">🔍</span>
                            <button onclick="clearAgentsSearch()" id="clearAgentsSearchBtn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 6px; display: none; transition: all 0.3s ease;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">✕</button>
                        </div>
                    </div>
                    <div id="agentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Departments Management Tab -->
            <div id="departments" class="tab-content">
                <div class="card">
                    <h3>إدارة أقسام الشركة</h3>
                    <div id="departmentsAlert"></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openAddDepartmentModal()">إضافة قسم جديد</button>
                    </div>
                    <div id="departmentsList" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <!-- Export Report Card -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%); border: 2px solid var(--primary-color); box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-light);">
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                📊
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.3rem; color: var(--text-primary); font-weight: 700;"> تقرير </h3>
                                <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">   </p>
                            </div>
                    </div>
                    <div id="reportsAlert"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div class="form-group" style="margin: 0;">
                                <label for="reportStartDate" style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">من تاريخ *</label>
                                <input type="date" id="reportStartDate" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-light)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                            <div class="form-group" style="margin: 0;">
                                <label for="reportEndDate" style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">إلى تاريخ *</label>
                                <input type="date" id="reportEndDate" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-light)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                        </div>
                        <div class="form-group" style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-light);">
                            <label for="reportIncludeAll" style="display: flex; align-items: center; cursor: pointer; font-weight: 600; color: var(--text-primary);">
                                <input type="checkbox" id="reportIncludeAll" onchange="toggleReportDateRange()" style="margin-left: 12px; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                                <span>📋 تقرير  (جميع البيانات بدون تحديد فترة)</span>
                        </label>
                    </div>
                        <div class="form-group" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border-light);">
                            <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 16px; font-size: 1.05rem; display: flex; align-items: center; gap: 8px;">
                                <span>📑</span>
                                <span>محتوى التقرير</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <label for="reportIncludeSummary" style="display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-light); transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--card-bg)'">
                                    <input type="checkbox" id="reportIncludeSummary" checked style="margin-left: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color);">
                                    <span style="font-weight: 600; color: var(--text-primary);">📈 ملخص الإحصائيات</span>
                            </label>
                                <label for="reportIncludeCalls" style="display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-light); transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--card-bg)'">
                                    <input type="checkbox" id="reportIncludeCalls" checked style="margin-left: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color);">
                                    <span style="font-weight: 600; color: var(--text-primary);">📞 تفاصيل المكالمات</span>
                            </label>
                                <label for="reportIncludeCustomers" style="display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-light); transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--card-bg)'">
                                    <input type="checkbox" id="reportIncludeCustomers" checked style="margin-left: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color);">
                                    <span style="font-weight: 600; color: var(--text-primary);">👤 تفاصيل المشتركين</span>
                            </label>
                                <label for="reportIncludeCharts" style="display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-light); transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--card-bg)'">
                                    <input type="checkbox" id="reportIncludeCharts" checked style="margin-left: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color);">
                                    <span style="font-weight: 600; color: var(--text-primary);">📊 الرسوم البيانية</span>
                            </label>
                        </div>
                    </div>
                        <div class="btn-group" style="display: flex; gap: 12px; margin-top: 8px;">
                            <button class="btn btn-primary" onclick="generateReport()" style="flex: 1; padding: 14px 24px; font-size: 1rem; font-weight: 700; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
                                📥 تصدير التقرير
                            </button>
                            <button class="btn btn-secondary" onclick="resetReportForm()" style="padding: 14px 24px; font-size: 1rem; font-weight: 600; border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                🔄 إعادة تعيين
                            </button>
                        </div>
                    </div>

                    <!-- Quick Export Card -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%); border: 2px solid var(--success-color); box-shadow: 0 8px 24px rgba(34, 197, 94, 0.15);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-light);">
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--success-color) 0%, #22c55e 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
                            
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.3rem; color: var(--text-primary); font-weight: 700;">تصدير سريع</h3>
                                <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">تصدير البيانات مباشرة</p>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="btn btn-secondary" onclick="exportCustomersToExcel()" style="width: 100%; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; background: var(--card-bg); border: 2px solid var(--border-color);" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'; this.style.transform='translateX(-4px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--card-bg)'; this.style.transform='translateX(0)'">
                                <span></span>
                                <span>تصدير المشتركين</span>
                            </button>
                            <button class="btn btn-secondary" onclick="exportCallsToExcel()" style="width: 100%; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; background: var(--card-bg); border: 2px solid var(--border-color);" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'; this.style.transform='translateX(-4px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--card-bg)'; this.style.transform='translateX(0)'">
                                <span></span>
                                <span>تصدير المكالمات</span>
                            </button>
                            <button class="btn btn-secondary" onclick="exportAdvancedStatsToExcel()" style="width: 100%; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; background: var(--card-bg); border: 2px solid var(--border-color);" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--primary-light)'; this.style.transform='translateX(-4px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--card-bg)'; this.style.transform='translateX(0)'">
                                <span></span>
                                <span>تصدير الإحصائيات </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile" class="tab-content">
                <div class="card">
                    <h3>الملف الشخصي</h3>
                    <div id="profileAlert"></div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 30px;">
                        <div style="position: relative; display: inline-block;">
                            <div id="profilePictureContainer" style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; font-weight: 700; border: 4px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; position: relative; overflow: hidden;">
                                <img id="profilePicture" src="" alt="صورة الملف الشخصي" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <span id="profileInitials" style="display: block;"></span>
                            </div>
                            <label for="profilePictureInput" style="position: absolute; bottom: 0; right: 0; background: var(--primary-color); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid white;">
                                <span style="font-size: 1.2rem;">📷</span>
                            </label>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                        </div>
                        <div style="width: 100%; max-width: 600px;">
                            <div class="form-group">
                                <label for="profileFullName">الاسم الكامل</label>
                                <input type="text" id="profileFullName" placeholder="الاسم الكامل" readonly style="background: var(--bg-tertiary);">
                            </div>
                            <div class="form-group">
                                <label for="profileUsername">اسم المستخدم</label>
                                <input type="text" id="profileUsername" placeholder="اسم المستخدم" readonly style="background: var(--bg-tertiary);">
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">رقم الهاتف</label>
                                <input type="text" id="profilePhone" placeholder="رقم الهاتف">
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">البريد الإلكتروني</label>
                                <input type="email" id="profileEmail" placeholder="البريد الإلكتروني">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="saveProfile()">حفظ التغييرات</button>
                                <button class="btn btn-secondary" onclick="loadProfile()">إعادة تحميل</button>
                            </div>
                        </div>
                        
                        <div id="employeeAwardsSection" style="width: 100%; max-width: 600px; margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">🏆</span>
                                <span>جوائز الموظف المثالي</span>
                            </h4>
                            <div id="employeeAwardsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                                <p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">جاري تحميل الجوائز...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">📝 ملاحظاتي</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="openAddNoteModal()">إضافة ملاحظة جديدة</button>
                            <button class="btn btn-secondary" onclick="loadNotes()">تحديث</button>
                        </div>
                    </div>
                    <div id="notesAlert"></div>
                    <div id="notesList" style="margin-top: 20px;">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px;">جاري تحميل الملاحظات...</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Statistics Tab (Admin Only) -->
            <div id="advanced-stats" class="tab-content">
                <div class="card" style="min-height: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">إحصائيات متقدمة</h3>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportAdvancedStatsToExcel()">تصدير Excel</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="statsPeriod" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;">اختر الفترة:</label>
                        <select id="statsPeriod" name="statsPeriod" title="اختر الفترة الزمنية للإحصائيات" onchange="loadAdvancedStatistics()" style="padding: 8px 12px; border-radius: 8px; border: 1.5px solid var(--border-color); width: 180px; font-size: 0.9rem;">
                            <option value="daily">يومية</option>
                            <option value="weekly">أسبوعية</option>
                            <option value="monthly">شهرية</option>
                        </select>
                    </div>
                    <div id="advancedStatsContent" style="min-height: auto;">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 0.9rem;">جاري تحميل الإحصائيات...</p>
                    </div>
                </div>
            </div>

            <!-- Users Management Tab (Admin Only) -->
            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div style="display: flex; height: calc(100vh - 120px); gap: 0; border-radius: 12px; overflow: hidden; border: 2px solid var(--border-color); background: var(--card-bg);">
                    <div class="chat-sidebar" style="width: 300px; border-left: 2px solid var(--border-color); background: var(--bg-secondary); display: flex; flex-direction: column; overflow: hidden;">
                        <div class="chat-search" style="padding: 15px; border-bottom: 1px solid var(--border-light);">
                            <input type="text" id="chatSearchInput" placeholder="🔍 ابحث عن موظف..." onkeyup="filterChatUsers()" style="width: 100%; padding: 10px 14px; border: 2px solid var(--input-border); border-radius: 10px; background: var(--input-bg); color: var(--text-primary); font-size: 0.9rem;">
                        </div>
                        <div class="chat-users-list" id="chatUsersList" style="flex: 1; overflow-y: auto; padding: 10px;">
                            <p style="text-align: center; color: var(--text-secondary); padding: 20px;">جاري تحميل عطلات الكول سنتر...</p>
                        </div>
                    </div>
                    <div class="chat-main" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #efeae2; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,.03) 10px, rgba(0,0,0,.03) 20px);">
                        <div id="chatNoSelection" class="chat-no-selection" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 15px; opacity: 0.5;">💬</div>
                            <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">  </p>
                            <p style="font-size: 0.9rem; opacity: 0.7;"></p>
                        </div>
                        <div id="chatMessagesArea" class="chat-messages-area" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                            <div class="chat-messages-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); background: #f0f2f5; display: flex; align-items: center; justify-content: space-between;">
                                <div class="chat-messages-user-info" style="display: flex; align-items: center; gap: 10px;">
                                    <span id="chatCurrentUserName" style="font-weight: 600; color: var(--text-primary);">-</span>
                                    <span id="chatCurrentUserStatus" class="user-status" style="font-size: 0.8rem; color: var(--success-color); font-weight: 600;">نشط</span>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px 12px; display: flex; flex-direction: column; gap: 2px;">
                                <!-- الرسائل ستظهر هنا -->
                            </div>
                            <div class="chat-input-area" style="padding: 8px 12px; border-top: 1px solid rgba(0, 0, 0, 0.08); background: #f0f2f5; display: flex; gap: 8px; align-items: flex-end;">
                                <textarea id="chatMessageInput" placeholder="اكتب رسالتك هنا..." rows="1" onkeydown="handleChatInputKeydown(event)" style="flex: 1; padding: 9px 12px; border: none; border-radius: 20px; background: white; color: var(--text-primary); font-size: 0.95rem; resize: none; max-height: 120px; overflow-y: auto; font-family: inherit;"></textarea>
                                <button class="chat-send-btn" onclick="sendChatMessage()" title="إرسال (Enter)" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                    <span style="font-size: 1.2rem;">➤</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="users" class="tab-content">
                <div class="card" style="min-height: auto;">
                    <h3>إدارة المستخدمين</h3>
                    <div id="usersAlert"></div>
                    <div class="btn-group" style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="openAddUserModal()">إضافة مستخدم جديد</button>
                        <button class="btn btn-secondary" onclick="loadUsers()">تحديث القائمة</button>
                        <button class="btn btn-danger" onclick="deleteUnwantedUsers()">حذف المستخدمين غير المطلوبين</button>
                    </div>
                    <div id="usersList" style="margin-top: 15px; min-height: auto;">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 0.9rem;">جاري تحميل قائمة المستخدمين...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Employee Profile Modal -->
    <div id="employeeProfileModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="employeeProfileModalTitle">الملف الشخصي</h3>
                <button class="close-modal" onclick="closeEmployeeProfileModal()">&times;</button>
            </div>
            <div id="employeeProfileModalContent" style="padding: 20px;">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">👤</div>
                    <p>جاري تحميل البيانات...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Agent Modal -->
    <div id="addAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addAgentModalTitle">إضافة وكيل جديد</h3>
                <button class="close-modal" onclick="closeAddAgentModal()">&times;</button>
            </div>
            <div id="addAgentAlert"></div>
            <input type="hidden" id="editAgentId" value="">
            <div class="form-group">
                <label for="agentName">اسم الوكيل *</label>
                <input type="text" id="agentName" placeholder="أدخل اسم الوكيل">
            </div>
            <div class="form-group">
                <label for="agentPhone">رقم الهاتف (واتساب) *</label>
                <input type="text" id="agentPhone" placeholder="أدخل رقم الهاتف (مثال: 9647501234567)">
            </div>
            <div class="form-group">
                <label for="agentAddress">عنوان مكتب الوكيل</label>
                <input type="text" id="agentAddress" placeholder="أدخل عنوان مكتب الوكيل">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveAgent()">حفظ</button>
                <button class="btn btn-secondary" onclick="closeAddAgentModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Department Modal -->
    <div id="addDepartmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addDepartmentModalTitle">إضافة قسم جديد</h3>
                <button class="close-modal" onclick="closeAddDepartmentModal()">&times;</button>
            </div>
            <div id="addDepartmentAlert"></div>
            <input type="hidden" id="editDepartmentId" value="">
            <div class="form-group">
                <label for="departmentName">اسم القسم *</label>
                <input type="text" id="departmentName" placeholder="أدخل اسم القسم (مثال: قسم التقنية، قسم المبيعات)">
            </div>
            <div class="form-group">
                <label for="departmentPhone">رقم الهاتف (واتساب) *</label>
                <input type="text" id="departmentPhone" placeholder="أدخل رقم الهاتف (مثال: 9647501234567)">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveDepartment()">حفظ</button>
                <button class="btn btn-secondary" onclick="closeAddDepartmentModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Call Details Modal -->
    <div id="callDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>تفاصيل المكالمة</h3>
                <button class="close-modal" onclick="closeCallDetailsModal()">&times;</button>
            </div>
            <div id="callDetailsContent" style="padding: 20px;">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
            <div id="callDetailsAlert" style="padding: 0 20px;"></div>
            <div class="btn-group" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="shareCallTicket('whatsapp')" style="background: #25D366; border-color: #25D366;">
                    📱 مشاركة عبر واتساب
                </button>
                <button class="btn btn-primary" onclick="shareCallTicket('copy')" style="background: var(--primary-color);">
                    📋 نسخ كرسالة
                </button>
                <button class="btn btn-secondary" onclick="closeCallDetailsModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Edit Call Modal -->
    <div id="editCallModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>تعديل تفاصيل المكالمة</h3>
                <button class="close-modal" onclick="closeEditCallModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="editCallAlert"></div>
                <input type="hidden" id="editCallId">
                <div class="form-group">
                    <label for="editCallType">نوع المكالمة *</label>
                    <input type="text" id="editCallType" placeholder="مثال: استفسار، شكوى، طلب">
                </div>
                <div class="form-group">
                    <label for="editCallName">اسم المتصل *</label>
                    <input type="text" id="editCallName" placeholder="اسم المتصل">
                </div>
                <div class="form-group">
                    <label for="editCallPhone">رقم الهاتف *</label>
                    <input type="text" id="editCallPhone" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label for="editCallDetails">التفاصيل</label>
                    <textarea id="editCallDetails" rows="4" placeholder="تفاصيل المكالمة"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCallAgent">الموظف</label>
                    <input type="text" id="editCallAgent" placeholder="اسم الموظف">
                </div>
                <div class="form-group">
                    <label for="editCallDepartment">القسم</label>
                    <input type="text" id="editCallDepartment" placeholder="اسم القسم">
                </div>
                <div class="form-group">
                    <label for="editCallShiftTime">وقت الشفت</label>
                    <input type="text" id="editCallShiftTime" placeholder="وقت الشفت">
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeEditCallModal()">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveEditedCall()">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>تعديل بيانات المشترك</h3>
                <button class="close-modal" onclick="closeEditCustomerModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="editCustomerAlert"></div>
                <input type="hidden" id="editCustomerId">
                <div class="form-group">
                    <label for="editCustomerUsername">الاسم *</label>
                    <input type="text" id="editCustomerUsername" placeholder="اسم المشترك">
                </div>
                <div class="form-group">
                    <label for="editCustomerRegion">المنطقة</label>
                    <input type="text" id="editCustomerRegion" placeholder="المنطقة">
                </div>
                <div class="form-group">
                    <label for="editCustomerClosestPoint">أقرب نقطة دالة</label>
                    <input type="text" id="editCustomerClosestPoint" placeholder="أقرب نقطة دالة">
                </div>
                <div class="form-group">
                    <label for="editCustomerPhone">رقم الهاتف *</label>
                    <input type="text" id="editCustomerPhone" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label for="editCustomerDate">التاريخ</label>
                    <input type="text" id="editCustomerDate" placeholder="التاريخ">
                </div>
                <div class="form-group">
                    <label for="editCustomerNotes">الملاحظات</label>
                    <textarea id="editCustomerNotes" rows="4" placeholder="ملاحظات"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCustomerEmployee">الموظف</label>
                    <input type="text" id="editCustomerEmployee" placeholder="اسم الموظف">
                </div>
                <div class="form-group">
                    <label for="editCustomerAgent">الوكيل</label>
                    <input type="text" id="editCustomerAgent" placeholder="اسم الوكيل">
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeEditCustomerModal()">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveEditedCustomer()">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <div class="chat-header-info">
                <h3>💬 المحادثة المباشرة</h3>
                <span id="chatStatus" class="chat-status">متصل</span>
                </div>
            <button class="close-chat" onclick="closeChatWindow()">&times;</button>
            </div>
        <div class="chat-container">
            <div class="chat-sidebar">
                <div class="chat-search">
                    <input type="text" id="chatSearchInput" placeholder="🔍 ابحث عن موظف..." onkeyup="filterChatUsers()">
            </div>
                <div class="chat-users-list" id="chatUsersList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 20px;">جاري تحميل الموظفين...</p>
                </div>
            </div>
            <div class="chat-main">
                <div id="chatNoSelection" class="chat-no-selection">
                    <div class="chat-no-selection-icon">💬</div>
                    <p>اختر موظفاً للبدء بالمحادثة</p>
                </div>
                <div id="chatMessagesArea" class="chat-messages-area" style="display: none;">
                    <div class="chat-messages-header">
                        <div class="chat-messages-user-info">
                            <span id="chatCurrentUserName">-</span>
                            <span id="chatCurrentUserStatus" class="user-status">نشط</span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- الرسائل ستظهر هنا -->
                    </div>
                    <div class="chat-input-area">
                        <textarea id="chatMessageInput" placeholder="اكتب رسالتك هنا..." rows="1" onkeydown="handleChatInputKeydown(event)"></textarea>
                        <button class="chat-send-btn" onclick="sendChatMessage()" title="إرسال (Enter)">
                            <span style="font-size: 1.2rem;">➤</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Note Modal -->
    <div id="addNoteModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="addNoteModalTitle">إضافة ملاحظة جديدة</h3>
                <button class="close-modal" onclick="closeAddNoteModal()">&times;</button>
            </div>
            <div id="addNoteAlert"></div>
            <input type="hidden" id="editNoteId" value="">
            <div class="form-group">
                <label for="noteTitle">عنوان الملاحظة *</label>
                <input type="text" id="noteTitle" placeholder="أدخل عنوان الملاحظة">
            </div>
            <div class="form-group">
                <label for="noteContent">محتوى الملاحظة *</label>
                <textarea id="noteContent" placeholder="أدخل محتوى الملاحظة" rows="8"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveNote()">حفظ</button>
                <button class="btn btn-secondary" onclick="closeAddNoteModal()">إلغاء</button>
            </div>
        </div>
    </div>


    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addUserModalTitle">إضافة مستخدم جديد</h3>
                <button class="close-modal" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div id="addUserAlert"></div>
            <input type="hidden" id="editUserId" value="">
            <div class="form-group">
                <label for="userUsername">اسم المستخدم *</label>
                <input type="text" id="userUsername" placeholder="أدخل اسم المستخدم (للتسجيل)">
            </div>
            <div class="form-group">
                <label for="userFullName">الاسم الكامل *</label>
                <input type="text" id="userFullName" placeholder="أدخل الاسم الكامل">
            </div>
            <div class="form-group">
                <label for="userPassword">كلمة المرور <span id="passwordRequired">*</span></label>
                <input type="password" id="userPassword" placeholder="أدخل كلمة المرور (اتركه فارغاً عند التعديل للحفاظ على الكلمة الحالية)">
                <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 5px;" id="passwordHint" style="display: none;">عند التعديل، اتركه فارغاً للحفاظ على كلمة المرور الحالية</small>
            </div>
            <div class="form-group">
                <label for="userRole">الدور *</label>
                <select id="userRole">
                    <option value="employee">موظف</option>
                    <option value="admin">مدير</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveUser()">حفظ</button>
                <button class="btn btn-secondary" onclick="closeAddUserModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tvlaypjqojvsbttaprko.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2bGF5cGpxb2p2c2J0dGFwcmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzQ1NDIsImV4cCI6MjA3ODM1MDU0Mn0.n3AwBUr5Qsq4HDSQZTjGzWFxOfmvXfhuIXmrmoKdEDc';
        
        // WhatsApp variables for sending functions (fallback to wa.me)
        let WHATSAPP_SERVER_URL = null;
        let useWhatsAppAPI = false;
        
        const dataCache = {
            calls: { data: null, timestamp: 0, ttl: 14400000 }, // 4 ساعات بدلاً من 2
            customers: { data: null, timestamp: 0, ttl: 14400000 }, // 4 ساعات بدلاً من 2
            users: { data: null, timestamp: 0, ttl: 28800000 },
            allowedUsers: { data: null, timestamp: 0, ttl: 28800000 },
            agents: { data: null, timestamp: 0, ttl: 28800000 },
            departments: { data: null, timestamp: 0, ttl: 28800000 },
            sentMessages: { data: null, timestamp: 0, ttl: 7200000 }, // ساعتان بدلاً من 1
            messages: { data: null, timestamp: 0, ttl: 300000 }, // 5 دقائق بدلاً من 1
            userProfiles: { data: null, timestamp: 0, ttl: 7200000 } // ساعتان بدلاً من 1
        };
        
        // قائمة الموظفين المستبعدين من الإحصائيات والعروض
        const EXCLUDED_EMPLOYEES = ['المدير العام', 'علي فاهم نعمة'];
        
        let isTabActive = true;
        document.addEventListener('visibilitychange', function() {
            isTabActive = !document.hidden;
        });
        
        function getCachedData(key) {
            const cache = dataCache[key];
            if (cache && Date.now() - cache.timestamp < cache.ttl) {
                return cache.data;
            }
            return null;
        }
        
        function setCachedData(key, data) {
            if (dataCache[key]) {
                dataCache[key].data = data;
                dataCache[key].timestamp = Date.now();
            }
        }
        
        function clearCache(key = null) {
            if (key && dataCache[key]) {
                dataCache[key].data = null;
                dataCache[key].timestamp = 0;
            } else {
                Object.keys(dataCache).forEach(k => {
                    dataCache[k].data = null;
                    dataCache[k].timestamp = 0;
                });
            }
        }
        
        const SYSTEM_NAME = 'customer_service';
        
        async function supabaseRequest(table, method = 'GET', data = null, filters = '', customHeaders = {}, useCache = false) {
            if (method === 'GET') {
                if (table === 'messages') {
                    const cacheKey = `messages_${filters}`;
                    if (dataCache[cacheKey]) {
                        const cached = getCachedData(cacheKey);
                        if (cached !== null) {
                            return cached;
                        }
                    }
                } else if (table === 'user_profiles') {
                    const cacheKey = `user_profiles_${filters}`;
                    if (dataCache[cacheKey]) {
                        const cached = getCachedData(cacheKey);
                        if (cached !== null) {
                            return cached;
                        }
                    }
                } else if (useCache && dataCache[table]) {
                const cached = getCachedData(table);
                if (cached !== null) {
                    return cached;
                    }
                }
            }
            
            const url = `${SUPABASE_URL}/rest/v1/${table}${filters}`;
            const options = {
                method: method,
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation',
                    ...customHeaders
                }
            };
            
            if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                options.signal = controller.signal;
                
                const response = await fetch(url, options);
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Supabase error: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                if (method === 'GET') {
                    if (table === 'messages') {
                        const cacheKey = `messages_${filters}`;
                        if (!dataCache[cacheKey]) {
                            dataCache[cacheKey] = { data: null, timestamp: 0, ttl: 60000 };
                        }
                        dataCache[cacheKey].data = result;
                        dataCache[cacheKey].timestamp = Date.now();
                    } else if (table === 'user_profiles') {
                        const cacheKey = `user_profiles_${filters}`;
                        if (!dataCache[cacheKey]) {
                            dataCache[cacheKey] = { data: null, timestamp: 0, ttl: 3600000 };
                        }
                        dataCache[cacheKey].data = result;
                        dataCache[cacheKey].timestamp = Date.now();
                    } else if (dataCache[table]) {
                    setCachedData(table, result);
                    }
                }
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - يرجى المحاولة مرة أخرى');
                }
                if (error.message && error.message.includes('Failed to fetch')) {
                    throw new Error('خطأ في الاتصال بالإنترنت - يرجى التحقق من الاتصال');
                }
                throw error;
            }
        }
        
        let loggedInUser = '';
        let currentUserRole = 'employee';
        let currentUserId = null;
        let currentTheme = 'light';
        let clockInterval = null;
        let agents = [];
        let departments = [];
        let employeeNameMap = {}; // خريطة لتوحيد أسماء الموظفين (الاسم القديم -> الاسم الجديد)
        let currentCustomerData = null;
        let statistics = {
            calls: [],
            customers: [],
            sentMessages: []
        };
        let isOnline = navigator.onLine;
        
        function saveToOfflineStorage(type, data) {
            try {
                const key = `offline_${type}_${Date.now()}`;
                const offlineData = {
                    type: type,
                    data: data,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(key, JSON.stringify(offlineData));
                return key;
            } catch (error) {
                return null;
            }
        }
        
        function getAllOfflineData() {
            const offlineItems = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('offline_')) {
                    try {
                        const item = JSON.parse(localStorage.getItem(key));
                        offlineItems.push({ key, ...item });
                    } catch (e) {
                    }
                }
            }
            return offlineItems.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }
        
        async function syncOfflineData() {
            if (!isOnline) return;
            
            const offlineItems = getAllOfflineData();
            if (offlineItems.length === 0) return;
            
            for (const item of offlineItems) {
                try {
                    if (item.type === 'customer') {
                        await supabaseRequest('customers', 'POST', item.data);
                        clearCache('customers');
                        localStorage.removeItem(item.key);
                    } else if (item.type === 'call') {
                        await supabaseRequest('calls', 'POST', item.data);
                        clearCache('calls'); 
                        localStorage.removeItem(item.key);
                    }
                } catch (error) {
                }
            }
        }
        
        window.addEventListener('online', function() {
            isOnline = true;
            syncOfflineData();
        });
        
        window.addEventListener('offline', function() {
            isOnline = false;
        });
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('txtDate').value = today.toISOString().split('T')[0];
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', currentTheme);
            }
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'light' ? '🌙' : '☀️';
            }
            
            const savedUser = localStorage.getItem('loggedInUser');
            const savedRole = localStorage.getItem('currentUserRole');
            const savedUserId = localStorage.getItem('currentUserId');
            if (savedUser) {
                loggedInUser = savedUser;
                currentUserRole = savedRole || 'employee';
                currentUserId = savedUserId;
                showMainApp();
                if (currentUserId) {
                    loadUserProfileForSidebar();
                }
            }

            Promise.all([
                loadAgents(),
                loadDepartments(),
                isOnline ? syncOfflineData() : Promise.resolve(),
                updateEmployeeNameMap() // تحديث خريطة الأسماء عند تحميل الصفحة
            ]).catch(err => {
                console.error('Error loading initial data:', err);
            });
            
            const txtPhone = document.getElementById('txtPhone');
            const txtName = document.getElementById('txtName');
            const txtCallPhone = document.getElementById('txtCallPhone');
            const txtCallName = document.getElementById('txtCallName');
            
            if (txtPhone) {
                txtPhone.addEventListener('input', () => validateInput(txtPhone, 'phone'));
                txtPhone.addEventListener('blur', () => validateInput(txtPhone, 'phone'));
            }
            
            if (txtName) {
                txtName.addEventListener('input', () => validateInput(txtName, 'name'));
                txtName.addEventListener('blur', () => validateInput(txtName, 'name'));
            }
            
            if (txtCallPhone) {
                txtCallPhone.addEventListener('input', () => validateInput(txtCallPhone, 'phone'));
                txtCallPhone.addEventListener('blur', () => validateInput(txtCallPhone, 'phone'));
            }
            
            if (txtCallName) {
                txtCallName.addEventListener('input', () => validateInput(txtCallName, 'name'));
                txtCallName.addEventListener('blur', () => validateInput(txtCallName, 'name'));
            }
            
            // تحديث موظف الأسبوع مرة واحدة يومياً (24 ساعة) بدلاً من كل 12 ساعة
            setInterval(async () => {
                if (isTabActive && document.getElementById('dashboard').classList.contains('active')) {
                    await updateEmployeeOfTheWeek();
                }
            }, 86400000); // 24 ساعة
            
            // تحديث الإحصائيات كل 6 ساعات بدلاً من 4 ساعات
            setInterval(async () => {
                if (isTabActive && document.getElementById('dashboard').classList.contains('active')) {
                    await refreshStatistics();
                }
            }, 21600000); // 6 ساعات
        });

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const alertDiv = document.getElementById('loginAlert');

            if (!username || !password) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول.', 'error');
                return;
            }

            showAlert(alertDiv, 'جاري التحقق من البيانات...', 'info');

            try {
                const passwordHash = await hashPassword(password);
                
                const filter = `?username=eq.${encodeURIComponent(username)}&is_active=eq.true&system_name=eq.${SYSTEM_NAME}`;
                
                const users = await supabaseRequest('users', 'GET', null, filter);
                
                if (users && users.length > 0) {
                    const user = users[0];
                    
                    if (user.password_hash === passwordHash) {
                        try {
                            await supabaseRequest('users', 'PATCH', { last_login: new Date().toISOString() }, `?id=eq.${user.id}`);
                        } catch (e) {
                        }
                        
                        loggedInUser = user.full_name;
                        currentUserRole = user.role;
                        currentUserId = user.id;
                        
                        localStorage.setItem('loggedInUser', user.full_name);
                        localStorage.setItem('currentUserRole', user.role);
                        localStorage.setItem('currentUserId', user.id);
                        
                        showMainApp();
                        
                        // تحديث خريطة أسماء الموظفين بعد تسجيل الدخول
                        updateEmployeeNameMap();
                        
                        loadUserProfileForSidebar();
                    } else {
                        showAlert(alertDiv, 'اسم المستخدم أو كلمة المرور غير صحيحة.', 'error');
                    }
                } else {
                    try {
                        const systemUsers = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&select=username`);
                        if (!systemUsers || systemUsers.length === 0) {
                            showAlert(alertDiv, 'لا يوجد مستخدمين في هذا النظام. يرجى إنشاء مستخدم مدير أولاً.', 'error');
                        } else {
                            showAlert(alertDiv, 'اسم المستخدم أو كلمة المرور غير صحيحة.', 'error');
                        }
                    } catch (e) {
                        showAlert(alertDiv, 'اسم المستخدم أو كلمة المرور غير صحيحة.', 'error');
                    }
                }
            } catch (error) {
                showAlert(alertDiv, `حدث خطأ أثناء تسجيل الدخول: ${error.message}. يرجى التحقق من الاتصال بالإنترنت والمحاولة مرة أخرى.`, 'error');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            const switchUserBtn = document.getElementById('switchUserBtn');
            const switchUserText = document.getElementById('switchUserText');
            if (switchUserBtn && switchUserText) {
                switchUserText.textContent = loggedInUser;
            }
            startClock();
            
            updateAdminTabsVisibility();
            
            
            const loadInitialData = async () => {
                try {
                    
                    const cachedCalls = getCachedData('calls');
                    const cachedCustomers = getCachedData('customers');
                    
                    
                    if (cachedCalls && cachedCustomers && Array.isArray(cachedCalls) && Array.isArray(cachedCustomers)) {
                        callsData = cachedCalls;
                        customersData = cachedCustomers;
                        
                        updateStatistics();
                    }
                    
                    
                    Promise.all([
                        fetchCallsData(false),
                        fetchCustomersData(false),
                        fetchAgentsCount(),
                        fetchDepartmentsCount(),
                        fetchSentMessagesCount()
                    ]).then(([calls, customers, agentsCount, deptsCount, sentCount]) => {
                        
                        if (calls && Array.isArray(calls) && calls.length > 0) {
                            callsData = calls;
                        }
                        if (customers && Array.isArray(customers) && customers.length > 0) {
                            customersData = customers;
                        }
                        
                        if (calls || customers) {
                            updateStatistics();
                        }
                    }).catch(err => {
                        console.error('Error loading initial statistics:', err);
                        
                        if (cachedCalls && cachedCustomers && Array.isArray(cachedCalls) && Array.isArray(cachedCustomers)) {
                            if (!callsData.length && !customersData.length) {
                                updateStatistics();
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error in loadInitialData:', error);
                }
            };
            
            
            try {
                const lastTab = localStorage.getItem('lastActiveTab');
                if (lastTab && document.getElementById(lastTab)) {
                    
                    if ((lastTab === 'advanced-stats' || lastTab === 'users') && currentUserRole !== 'admin') {
                        
                        switchTab('dashboard');
                        loadInitialData();
                    } else {
                        
                        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                        
                        
                        document.getElementById(lastTab).classList.add('active');
                        const navItems = document.querySelectorAll('.nav-item');
                        navItems.forEach(item => {
                            if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(lastTab)) {
                                item.classList.add('active');
                            }
                        });
                        
                        const titles = {
                            'dashboard': 'الاحصائيات',
                            'customer': 'إدخال بيانات المشترك',
                            'call': 'تفاصيل المكالمة',
                            'agents': 'إدارة الوكلاء',
                            'departments': 'إدارة الأقسام',
                            'notes': 'ملاحظاتي',
                            'reports': 'تصدير تقرير',
                            'advanced-stats': 'إحصائيات متقدمة',
                            'users': 'إدارة المستخدمين',
                        };
                        document.getElementById('pageTitle').textContent = titles[lastTab] || 'الاحصائيات';
                        
                        if (lastTab === 'dashboard') {
                            loadInitialData();
                        } else if (lastTab === 'advanced-stats') {
                            loadAdvancedStatistics();
                        } else if (lastTab === 'users') {
                            loadUsers();
                        } else if (lastTab === 'notes') {
                            loadNotes();
                        } else if (lastTab === 'reports') {
                            initializeReportForm();
                        }
                    }
                } else {
                    
                    switchTab('dashboard');
                    loadInitialData();
                }
            } catch (e) {
                switchTab('dashboard');
                loadInitialData();
            }
        }
        
        function updateAdminTabsVisibility() {
            const adminTabs = document.querySelectorAll('.admin-only');
            if (currentUserRole === 'admin') {
                adminTabs.forEach(tab => {
                    tab.style.display = 'block';
                });
            } else {
                adminTabs.forEach(tab => tab.style.display = 'none');
            }
        }

        function switchUser() {
            if (confirm('هل تريد تبديل المستخدم؟ سيتم تسجيل الخروج من الحساب الحالي.')) {
                loggedInUser = '';
                localStorage.removeItem('loggedInUser');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginAlert').innerHTML = '';
                if (clockInterval) {
                    clearInterval(clockInterval);
                }
            }
        }

        function closeApp() {
            if (confirm('هل تريد إغلاق التطبيق؟')) {
                window.close();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        function switchTab(tabName) {
            if ((tabName === 'advanced-stats' || tabName === 'users') && currentUserRole !== 'admin') {
                showToast('ليس لديك صلاحية للوصول إلى هذه الصفحة', 'error', 'غير مصرح');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (tabName === 'chat') {
                loadChatUsers();
                updateUnreadMessagesCount();
                if (!chatInterval) {
                    startChatAutoUpdate();
                }
            } else {
                if (chatInterval) {
                    stopChatAutoUpdate();
                }
            }

            const tabElement = document.getElementById(tabName);
            if (!tabElement) {
                console.error('Tab not found:', tabName);
                return;
            }
            
            tabElement.classList.add('active');
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            const titles = {
                'dashboard': 'الاحصائيات',
                'customer': 'إدخال بيانات المشترك',
                'call': 'تفاصيل المكالمة',
                'agents': 'إدارة الوكلاء',
                'departments': 'إدارة الأقسام',
                'notes': 'ملاحظاتي',
                'reports': 'تصدير تقرير',
                'advanced-stats': 'إحصائيات متقدمة',
                'users': 'إدارة المستخدمين',
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'الاحصائيات';
            
            try {
                localStorage.setItem('lastActiveTab', tabName);
            } catch (e) {
            }
            
            if (tabName === 'dashboard') {
                const cachedCalls = getCachedData('calls');
                const cachedCustomers = getCachedData('customers');
                
                if (cachedCalls && cachedCustomers) {
                    callsData = cachedCalls;
                    customersData = cachedCustomers;
                    updateStatistics();
                }
                
                refreshStatistics().catch(err => {
                    console.error('Error refreshing statistics:', err);
                });
            } else if (tabName === 'advanced-stats') {
                loadAdvancedStatistics();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'notes') {
                loadNotes();
            } else if (tabName === 'profile') {
                loadProfile();
            } else if (tabName === 'reports') {
                initializeReportForm();
            }
        }
        
        async function loadAllowedUsers() {
            try {
                const cached = getCachedData('allowedUsers');
                if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                    return cached;
                }
                
                const allowedUsers = await supabaseRequest('allowed_users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&is_active=eq.true&order=full_name.asc`);
                if (Array.isArray(allowedUsers) && allowedUsers.length > 0) {
                    setCachedData('allowedUsers', allowedUsers);
                    return allowedUsers;
                }
                console.warn('No allowed users found in database');
                return [];
            } catch (error) {
                console.error('Error loading allowed users:', error);
                return [];
            }
        }
        
        /**
         * تحديث خريطة أسماء الموظفين لتوحيد الأسماء القديمة والجديدة
         * يتم استدعاؤها عند تحميل المستخدمين
         */
        async function updateEmployeeNameMap() {
            try {
                const users = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&is_active=eq.true&select=id,username,full_name`);
                if (Array.isArray(users)) {
                    employeeNameMap = {};
                    users.forEach(user => {
                        if (user.full_name) {
                            const currentName = user.full_name.trim();
                            // ربط الاسم الحالي بجميع الأسماء المحتملة
                            employeeNameMap[currentName] = currentName;
                            
                            // ربط username بالاسم الحالي إذا كان مختلفاً
                            if (user.username && user.username.trim() !== currentName) {
                                employeeNameMap[user.username.trim()] = currentName;
                            }
                            
                            // البحث في البيانات القديمة عن أسماء مشابهة وربطها
                            // هذا يساعد في توحيد الأسماء القديمة مع الجديدة
                            if (callsData && callsData.length > 0) {
                                callsData.forEach(call => {
                                    const oldName = (call.agent || '').trim();
                                    if (oldName && oldName !== currentName) {
                                        // إذا كان الاسم القديم يحتوي على جزء من الاسم الجديد أو العكس
                                        if (oldName.includes(currentName) || currentName.includes(oldName) || 
                                            (user.username && oldName.includes(user.username))) {
                                            employeeNameMap[oldName] = currentName;
                                        }
                                    }
                                });
                            }
                            
                            if (customersData && customersData.length > 0) {
                                customersData.forEach(customer => {
                                    const oldName = (customer.employee || '').trim();
                                    if (oldName && oldName !== currentName) {
                                        if (oldName.includes(currentName) || currentName.includes(oldName) || 
                                            (user.username && oldName.includes(user.username))) {
                                            employeeNameMap[oldName] = currentName;
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating employee name map:', error);
            }
        }
        
        /**
         * الحصول على الاسم الموحد للموظف
         * @param {string} oldName - الاسم القديم المحفوظ في البيانات
         * @returns {string} الاسم الحالي الموحد
         */
        function getUnifiedEmployeeName(oldName) {
            if (!oldName || typeof oldName !== 'string') return oldName || 'غير معروف';
            const trimmed = oldName.trim();
            // البحث في الخريطة عن الاسم الموحد
            if (employeeNameMap[trimmed]) {
                return employeeNameMap[trimmed];
            }
            // إذا لم نجد، نبحث عن تطابق جزئي (للتعامل مع الأسماء القديمة)
            for (const [old, current] of Object.entries(employeeNameMap)) {
                if (old.includes(trimmed) || trimmed.includes(old)) {
                    return current;
                }
            }
            return trimmed; // إرجاع الاسم الأصلي إذا لم نجد تطابق
        }
        
        async function loadUsers() {
            if (currentUserRole !== 'admin') {
                document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">ليس لديك صلاحية للوصول إلى هذه الصفحة.</p>';
                return;
            }
            
            try {
                let allUsers = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allUsers = allUsers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                if (allUsers.length === 0) {
                    try {
                        const usersWithoutSystem = await supabaseRequest('users', 'GET', null, `?system_name=is.null&order=created_at.desc`);
                        if (Array.isArray(usersWithoutSystem) && usersWithoutSystem.length > 0) {
                            allUsers = usersWithoutSystem;
                        }
                    } catch (e) {
                    }
                    
                    if (allUsers.length === 0) {
                        try {
                            const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=100`);
                            if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                                allUsers = allUsersSimple;
                            }
                        } catch (e2) {
                        }
                    }
                }
                
                let filteredUsers = allUsers.filter(user => {
                    const userSystem = user.system_name || '';
                    return userSystem === SYSTEM_NAME || !userSystem || userSystem === '';
                });
                
                for (const user of filteredUsers) {
                    if (!user.system_name || user.system_name === null || user.system_name === '') {
                        try {
                            await supabaseRequest('users', 'PATCH', { system_name: SYSTEM_NAME }, `?id=eq.${user.id}`);
                            user.system_name = SYSTEM_NAME;
                        } catch (updateError) {
                        }
                    }
                }
                
                if (filteredUsers.length === 0) {
                    try {
                        const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=200`);
                        if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                            filteredUsers = allUsersSimple;
                        }
                    } catch (e) {
                    }
                }
                
                displayUsers(filteredUsers);
                // تحديث خريطة أسماء الموظفين بعد تحميل المستخدمين
                await updateEmployeeNameMap();
            } catch (error) {
                console.error('Error loading users:', error);
                const errorMsg = error.message || 'خطأ غير معروف';
                document.getElementById('usersList').innerHTML = `<p style="text-align: center; color: var(--error-color); padding: 20px;">حدث خطأ أثناء تحميل قائمة المستخدمين: ${errorMsg}</p>`;
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">لا يوجد مستخدمين مسجلين</p>';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>إجمالي المستخدمين:</strong> ${users.length} مستخدم
                </div>
                <table class="agents-stats-table" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>اسم المستخدم</th>
                            <th>الاسم الكامل</th>
                            <th>الدور</th>
                            <th>آخر تسجيل دخول</th>
                            <th>تاريخ الإنشاء</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const usernameSafe = escapeHtml(user.username || 'غير محدد');
                            const fullNameSafe = escapeHtml(user.full_name || 'غير محدد');
                            const usernameEscaped = (user.username || '').replace(/'/g, "\\'");
                            const fullNameEscaped = (user.full_name || '').replace(/'/g, "\\'");
                            return `
                            <tr>
                                <td><strong>${usernameSafe}</strong></td>
                                <td>${fullNameSafe}</td>
                                <td><span style="color: ${user.role === 'admin' ? '#dc3545' : '#28a745'}; font-weight: 600;">${user.role === 'admin' ? 'مدير' : 'موظف'}</span></td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleString('en-US') : 'لم يسجل دخول'}</td>
                                <td>${user.created_at ? new Date(user.created_at).toLocaleString('en-US') : 'غير محدد'}</td>
                                <td><span style="color: ${user.is_active ? '#28a745' : '#dc3545'}; font-weight: 600;">${user.is_active ? 'نشط' : 'معطل'}</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="openEditUserModal(${user.id}, '${usernameEscaped}', '${fullNameEscaped}', '${user.role}', ${user.is_active})">تعديل</button>
                                    <button class="btn btn-warning" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">${user.is_active ? 'تعطيل' : 'تفعيل'}</button>
                                    ${user.id !== currentUserId ? `<button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteUser(${user.id}, '${usernameEscaped}')">حذف</button>` : '<span style="color: var(--text-secondary); font-size: 0.85rem;">(المستخدم الحالي)</span>'}
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function openAddUserModal() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ليس لديك صلاحية لإضافة مستخدمين.', 'error');
                return;
            }
            document.getElementById('addUserModal').classList.add('active');
            document.getElementById('addUserModalTitle').textContent = 'إضافة مستخدم جديد';
            document.getElementById('editUserId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userUsername').disabled = false;
            document.getElementById('userFullName').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHint').style.display = 'none';
            document.getElementById('userRole').value = 'employee';
            document.getElementById('addUserAlert').innerHTML = '';
        }
        
        function openEditUserModal(userId, username, fullName, role, isActive) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ليس لديك صلاحية لتعديل المستخدمين.', 'error');
                return;
            }
            document.getElementById('addUserModal').classList.add('active');
            document.getElementById('addUserModalTitle').textContent = 'تعديل مستخدم';
            document.getElementById('editUserId').value = userId;
            document.getElementById('userUsername').value = username;
            document.getElementById('userUsername').disabled = true;
            document.getElementById('userFullName').value = fullName;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordRequired').style.display = 'none';
            document.getElementById('passwordHint').style.display = 'block';
            document.getElementById('userRole').value = role;
            document.getElementById('addUserAlert').innerHTML = '';
        }
        
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
        }
        
        async function saveUser() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('addUserAlert'), 'ليس لديك صلاحية لإضافة/تعديل المستخدمين.', 'error');
                return;
            }
            
            const editUserId = document.getElementById('editUserId').value;
            const username = document.getElementById('userUsername').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const role = document.getElementById('userRole').value;
            const alertDiv = document.getElementById('addUserAlert');
            
            if (!username || !fullName) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول المطلوبة.', 'error');
                return;
            }
            
            if (!editUserId && !password) {
                showAlert(alertDiv, 'يرجى إدخال كلمة المرور.', 'error');
                return;
            }
            
            try {
                const userData = {
                    full_name: fullName,
                    role: role,
                    system_name: SYSTEM_NAME
                };
                
                if (editUserId) {
                    if (password) {
                        const passwordHash = await hashPassword(password);
                        userData.password_hash = passwordHash;
                    }
                    await supabaseRequest('users', 'PATCH', userData, `?id=eq.${editUserId}`);
                    
                    try {
                        const allowedUserData = {
                            full_name: fullName,
                            username: username,
                            system_name: SYSTEM_NAME,
                            is_active: true,
                            updated_at: new Date().toISOString()
                        };
                        const existingAllowed = await supabaseRequest('allowed_users', 'GET', null, `?full_name=eq.${encodeURIComponent(fullName)}&system_name=eq.${SYSTEM_NAME}`);
                        if (existingAllowed && existingAllowed.length > 0) {
                            await supabaseRequest('allowed_users', 'PATCH', allowedUserData, `?id=eq.${existingAllowed[0].id}`);
                        } else {
                            await supabaseRequest('allowed_users', 'POST', allowedUserData);
                        }
                    } catch (allowedError) {
                        console.warn('Could not update allowed_users:', allowedError);
                    }
                    
                    showAlert(alertDiv, 'تم تحديث المستخدم بنجاح', 'success');
                } else {
                    if (!password) {
                        showAlert(alertDiv, 'يرجى إدخال كلمة المرور.', 'error');
                        return;
                    }
                    
                    let usernameExistsInCurrentSystem = false;
                    try {
                        const existingUserFilter = `?username=eq.${encodeURIComponent(username)}&system_name=eq.${SYSTEM_NAME}`;
                        const existingUsers = await supabaseRequest('users', 'GET', null, existingUserFilter);
                        
                        if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                            usernameExistsInCurrentSystem = true;
                            showAlert(alertDiv, 'اسم المستخدم موجود بالفعل في هذا النظام. يرجى اختيار اسم مستخدم آخر.', 'error');
                            return;
                        }
                    } catch (checkError) {
                        console.warn('Error checking username (will try to create anyway):', checkError);
                    }
                    
                    const passwordHash = await hashPassword(password);
                    userData.username = username;
                    userData.password_hash = passwordHash;
                    userData.is_active = true;
                    
                    let newUser;
                    try {
                        newUser = await supabaseRequest('users', 'POST', userData);
                    } catch (createError) {
                        const errorMsg = createError.message || createError.toString() || '';
                        if (errorMsg.includes('duplicate') || errorMsg.includes('23505') || errorMsg.includes('409') || errorMsg.includes('unique')) {
                            try {
                                const doubleCheck = await supabaseRequest('users', 'GET', null, `?username=eq.${encodeURIComponent(username)}&system_name=eq.${SYSTEM_NAME}`);
                                if (Array.isArray(doubleCheck) && doubleCheck.length > 0) {
                                    showAlert(alertDiv, 'اسم المستخدم موجود بالفعل في هذا النظام. يرجى اختيار اسم مستخدم آخر.', 'error');
                                    return;
                                }
                                
                                const allSystemsCheck = await supabaseRequest('users', 'GET', null, `?username=eq.${encodeURIComponent(username)}`);
                                if (Array.isArray(allSystemsCheck) && allSystemsCheck.length > 0) {
                                    const existingUser = allSystemsCheck[0];
                                    if (existingUser && existingUser.id) {
                                        try {
                                            await supabaseRequest('users', 'PATCH', { 
                                                system_name: SYSTEM_NAME,
                                                full_name: fullName,
                                                role: role,
                                                is_active: true
                                            }, `?id=eq.${existingUser.id}`);
                                            
                                            if (password) {
                                                const passwordHash = await hashPassword(password);
                                                await supabaseRequest('users', 'PATCH', { password_hash: passwordHash }, `?id=eq.${existingUser.id}`);
                                            }
                                            
                                            showAlert(alertDiv, 'تم نقل المستخدم إلى هذا النظام بنجاح', 'success');
                                            
                                            try {
                                                const allowedUserData = {
                                                    full_name: fullName,
                                                    username: username,
                                                    system_name: SYSTEM_NAME,
                                                    is_active: true
                                                };
                                                const existingAllowed = await supabaseRequest('allowed_users', 'GET', null, `?full_name=eq.${encodeURIComponent(fullName)}&system_name=eq.${SYSTEM_NAME}`);
                                                if (!existingAllowed || existingAllowed.length === 0) {
                                                    await supabaseRequest('allowed_users', 'POST', allowedUserData);
                                                } else {
                                                    await supabaseRequest('allowed_users', 'PATCH', allowedUserData, `?id=eq.${existingAllowed[0].id}`);
                                                }
                                            } catch (allowedError) {
                                            }
                                            
                                            closeAddUserModal();
                                            clearCache('users');
                                            clearCache('allowedUsers');
                                            loadUsers();
                                            if (typeof loadChatUsers === 'function') {
                                                loadChatUsers();
                                            }
                                            return;
                                        } catch (updateError) {
                                            showAlert(alertDiv, 'اسم المستخدم موجود في نظام آخر ولا يمكن نقله. يرجى اختيار اسم مستخدم مختلف.', 'error');
                                            return;
                                        }
                                    }
                                }
                                
                                showAlert(alertDiv, 'اسم المستخدم موجود بالفعل. يرجى اختيار اسم مستخدم آخر.', 'error');
                                return;
                            } catch (doubleCheckError) {
                                showAlert(alertDiv, 'اسم المستخدم موجود بالفعل. يرجى اختيار اسم مستخدم آخر.', 'error');
                                return;
                            }
                        }
                        throw createError;
                    }
                    
                    try {
                        const allowedUserData = {
                            full_name: fullName,
                            username: username,
                            system_name: SYSTEM_NAME,
                            is_active: true
                        };
                        await supabaseRequest('allowed_users', 'POST', allowedUserData);
                    } catch (allowedError) {
                        if (!allowedError.message || (!allowedError.message.includes('duplicate') && !allowedError.message.includes('23505') && !allowedError.message.includes('409'))) {
                            console.warn('Could not add user to allowed_users:', allowedError);
                        }
                    }
                    
                    showAlert(alertDiv, 'تم إضافة المستخدم بنجاح', 'success');
                }
                
                closeAddUserModal();
                loadUsers();
                if (typeof loadChatUsers === 'function') {
                    loadChatUsers();
                }
            } catch (error) {
                const errorMessage = error.message || error.toString() || 'خطأ غير معروف';
                if (errorMessage.includes('duplicate key') || errorMessage.includes('23505') || errorMessage.includes('409')) {
                    showAlert(alertDiv, 'اسم المستخدم موجود بالفعل. يرجى اختيار اسم مستخدم آخر.', 'error');
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('network')) {
                    showAlert(alertDiv, 'حدث خطأ في الاتصال. يرجى التحقق من الاتصال بالإنترنت والمحاولة مرة أخرى.', 'error');
                } else {
                    showAlert(alertDiv, `حدث خطأ أثناء حفظ المستخدم: ${errorMessage}`, 'error');
                }
            }
        }
        
        async function toggleUserStatus(userId, newStatus) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ليس لديك صلاحية لتعديل المستخدمين.', 'error');
                return;
            }
            
            try {
                await supabaseRequest('users', 'PATCH', { is_active: newStatus }, `?id=eq.${userId}`);
                loadUsers();
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), 'حدث خطأ أثناء تحديث حالة المستخدم.', 'error');
            }
        }
        
        async function deleteUser(userId, username = '') {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ليس لديك صلاحية لحذف المستخدمين.', 'error');
                return;
            }
            
            const confirmMessage = username 
                ? `هل أنت متأكد من حذف المستخدم "${username}"؟\n\nتحذير: سيتم حذف المستخدم نهائياً.`
                : 'هل أنت متأكد من حذف هذا المستخدم؟\n\nتحذير: سيتم حذف المستخدم نهائياً.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                await supabaseRequest('users', 'DELETE', null, `?id=eq.${userId}`);
                loadUsers();
                showAlert(document.getElementById('usersAlert'), `تم حذف المستخدم "${username || userId}" بنجاح`, 'success');
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), `حدث خطأ أثناء حذف المستخدم: ${error.message}`, 'error');
            }
        }
        
        async function loadAdvancedStatistics() {
            if (currentUserRole !== 'admin') {
                document.getElementById('advancedStatsContent').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">ليس لديك صلاحية للوصول إلى هذه الصفحة.</p>';
                return;
            }
            
            const period = document.getElementById('statsPeriod').value;
            const contentDiv = document.getElementById('advancedStatsContent');
            contentDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">جاري تحميل الإحصائيات...</p>';
            
            try {
                let startDate, endDate;
                const now = new Date();
                
                if (period === 'daily') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                } else if (period === 'weekly') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 7);
                } else {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                }
                
                const callsFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                const customersFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                
                let calls = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, callsFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        calls = calls.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                let customers = [];
                from = 0;
                hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, customersFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        customers = customers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                displayAdvancedStatistics(calls, customers, period);
            } catch (error) {
                contentDiv.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px;">حدث خطأ أثناء تحميل الإحصائيات.</p>';
            }
        }
        
        /**
         * عرض الإحصائيات المتقدمة
         * @param {Array} calls - بيانات المكالمات
         * @param {Array} customers - بيانات المشتركين
         * @param {string} period - الفترة الزمنية (daily/weekly/monthly)
         */
        function displayAdvancedStatistics(calls, customers, period) {
            const periodName = period === 'daily' ? 'اليوم' : period === 'weekly' ? 'هذا الأسبوع' : 'هذا الشهر';
            const callsData = Array.isArray(calls) ? calls : [];
            const customersData = Array.isArray(customers) ? customers : [];
            
            const totalCalls = callsData.length;
            const totalComplaints = callsData.filter(c => c.call_type === 'شكوى' || c.call_type === 'ضعف بالخدمة').length;
            const totalCustomers = customersData.length;
            
            const callsByType = {};
            callsData.forEach(call => {
                const type = call.call_type || 'غير محدد';
                callsByType[type] = (callsByType[type] || 0) + 1;
            });
            
            const callsByEmployee = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            callsData.forEach(call => {
                const oldEmpName = call.agent || 'غير محدد';
                const emp = getUnifiedEmployeeName(oldEmpName);
                if (emp && !EXCLUDED_EMPLOYEES.includes(emp)) {
                    if (!callsByEmployee[emp]) {
                        callsByEmployee[emp] = {
                            total: 0,
                            today: 0
                        };
                    }
                    callsByEmployee[emp].total++;
                    
                    const callDate = call.created_at ? new Date(call.created_at) : null;
                    if (callDate) {
                        callDate.setHours(0, 0, 0, 0);
                        if (callDate.getTime() === today.getTime()) {
                            callsByEmployee[emp].today++;
                        }
                    }
                }
            });
            
            const customersByAgent = {};
            customersData.forEach(customer => {
                const agent = customer.agent || 'غير محدد';
                customersByAgent[agent] = (customersByAgent[agent] || 0) + 1;
            });
            
            const contentDiv = document.getElementById('advancedStatsContent');
            const periodNameSafe = escapeHtml(periodName);
            contentDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon"></div>
                        <div class="stat-card-title">إجمالي المكالمات (${periodNameSafe})</div>
                        <div class="stat-card-value">${totalCalls}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon"></div>
                        <div class="stat-card-title">الشكاوى (${periodNameSafe})</div>
                        <div class="stat-card-value">${totalComplaints}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon"></div>
                        <div class="stat-card-title">المشتركين الجدد (${periodNameSafe})</div>
                        <div class="stat-card-value">${totalCustomers}</div>
                    </div>
                </div>
                
                <div class="charts-section" style="margin-top: 20px;">
                    <div class="chart-card">
                        <h4>توزيع أنواع المكالمات (${periodNameSafe})</h4>
                        <div class="chart-container">
                            <div class="bar-chart">
                                ${Object.entries(callsByType).sort((a, b) => b[1] - a[1]).map(([type, count]) => {
                                    const maxCount = Math.max(...Object.values(callsByType));
                                    const typeSafe = escapeHtml(type);
                                    return `
                                    <div class="bar-item">
                                        <div class="bar-label">${typeSafe}</div>
                                        <div class="bar-wrapper">
                                            <div class="bar-fill" style="width: ${maxCount > 0 ? (count / maxCount) * 100 : 0}%;">${count}</div>
                                        </div>
                                        <div class="bar-value">${count}</div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>المكالمات حسب الموظف (${periodNameSafe})</h4>
                        <div class="chart-container">
                            <div class="table-container" style="margin-top: 15px;">
                                <table class="agents-stats-table" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>اسم الموظف</th>
                                            <th>إجمالي المكالمات</th>
                                            <th>المكالمات اليومية</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(callsByEmployee).sort((a, b) => b[1].total - a[1].total).map(([emp, data]) => {
                                            const empSafe = escapeHtml(emp);
                                            return `
                                            <tr>
                                                <td><strong>${empSafe}</strong></td>
                                                <td><strong style="color: var(--primary-color);">${data.total}</strong></td>
                                                <td><strong style="color: #28a745;">${data.today}</strong></td>
                                            </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="bar-chart" style="margin-top: 20px;">
                                ${Object.entries(callsByEmployee).sort((a, b) => b[1].total - a[1].total).map(([emp, data]) => {
                                    const maxCount = Math.max(...Object.values(callsByEmployee).map(d => d.total));
                                    const empSafe = escapeHtml(emp);
                                    return `
                                    <div class="bar-item">
                                        <div class="bar-label">${empSafe}</div>
                                        <div class="bar-wrapper">
                                            <div class="bar-fill" style="width: ${maxCount > 0 ? (data.total / maxCount) * 100 : 0}%;">${data.total}</div>
                                        </div>
                                        <div class="bar-value">${data.total}</div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="font-size: 1.05rem; margin-bottom: 15px;">المشتركين حسب الوكيل (${periodNameSafe})</h3>
                    <div class="table-container">
                        <table class="agents-stats-table">
                            <thead>
                                <tr>
                                    <th>اسم الوكيل</th>
                                    <th>عدد المشتركين</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(customersByAgent).sort((a, b) => b[1] - a[1]).map(([agent, count]) => {
                                    const agentSafe = escapeHtml(agent);
                                    return `
                                    <tr>
                                        <td>${agentSafe}</td>
                                        <td><strong style="color: var(--primary-color);">${count}</strong></td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getCurrentShift() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 15) {
                return 'الشفت الصباحي';
            } else if (hour >= 15 && hour < 22) {
                return 'الشفت المسائي';
            } else {
                return 'الشفت الليلي';
            }
        }

        function updateShift() {
            const shift = getCurrentShift();
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const date = now.toLocaleDateString('en-US');
            document.getElementById('shiftDisplay').textContent = `${date} ${time} - ${shift}`;
        }

        function startClock() {
            updateShift();
            clockInterval = setInterval(updateShift, 1000);
        }

        async function checkDuplicateCustomer(name, phone) {
            try {
                const cached = getCachedData('customers');
                if (cached && cached.length > 0) {
                    const duplicate = cached.find(c => 
                        c.username === name && c.phone === phone
                    );
                    if (duplicate) {
                        return duplicate;
                    }
                }
                
                const nameFilter = `?username=eq.${encodeURIComponent(name)}&phone=eq.${encodeURIComponent(phone)}`;
                const existingCustomers = await supabaseRequest('customers', 'GET', null, nameFilter);
                
                if (existingCustomers && existingCustomers.length > 0) {
                    return existingCustomers[0];
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        /**
         * حفظ بيانات المشترك في قاعدة البيانات
         * يتحقق من التكرار قبل الحفظ
         */
        async function saveCustomerData() {
            const name = document.getElementById('txtName').value.trim();
            const region = document.getElementById('txtRegion').value.trim();
            const nearestPoint = document.getElementById('txtNearestPoint').value.trim();
            const phone = document.getElementById('txtPhone').value.trim();
            const selectedAgent = document.getElementById('selectAgent').value;
            const alertDiv = document.getElementById('customerAlert');

            if (!name || !region || !nearestPoint || !phone) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول المطلوبة (الاسم، المنطقة، أقرب نقطة دالة، رقم الهاتف).', 'error');
                return;
            }

            if (!selectedAgent) {
                showAlert(alertDiv, 'يرجى اختيار وكيل لإرسال البيانات إليه.', 'error');
                return;
            }

            const agent = agents.find(a => a.id === selectedAgent);
            if (!agent) {
                showAlert(alertDiv, 'الوكيل المحدد غير موجود. يرجى اختيار وكيل صحيح.', 'error');
                return;
            }

            if (isOnline) {
                showAlert(alertDiv, 'جاري التحقق من البيانات...', 'info');
                try {
                    const duplicate = await checkDuplicateCustomer(name, phone);
                    if (duplicate) {
                        showAlert(alertDiv, `⚠️ هذا المشترك موجود مسبقاً في النظام!\n\nالاسم: ${duplicate.username}\nرقم الهاتف: ${duplicate.phone}\nالمنطقة: ${duplicate.region}\nالتاريخ: ${duplicate.date || duplicate.created_at ? new Date(duplicate.date || duplicate.created_at).toLocaleDateString('en-US') : 'غير محدد'}\n\nلا يمكن إضافة نفس المعلومات مرة أخرى.`, 'error');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking duplicate:', error);
                }
            }

            const date = document.getElementById('txtDate').value;
            const notes = document.getElementById('txtNotes').value.trim();
            const shift = getCurrentShift();
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const shiftAndTime = `${shift} - ${time}`;

            const customerData = {
                username: name,
                region: region,
                closest_point: nearestPoint,
                phone: phone,
                date: date,
                notes: shiftAndTime + (notes ? ' - ' + notes : ''),
                employee: loggedInUser,
                agent: agent.name
            };

            showAlert(alertDiv, 'جاري حفظ البيانات...', 'info');

            try {
                if (isOnline) {
                    const result = await supabaseRequest('customers', 'POST', customerData);
                    // Customer data saved successfully
                    
                    const cached = getCachedData('customers');
                    if (cached && Array.isArray(cached)) {
                        cached.unshift(result[0] || customerData);
                        setCachedData('customers', cached);
                    } else {
                        clearCache('customers');
                    }
                    
                    if (customersData && Array.isArray(customersData)) {
                        customersData.unshift(result[0] || customerData);
                    }
                    
                    updateStatistics();
                    
                    setTimeout(() => {
                        sendCustomerToWhatsApp(agent, customerData);
                        saveSentMessageToSupabase('customer', agent.id, agent.name, customerData.username);
                    }, 500);
                    
                    showAlert(alertDiv, `تم حفظ البيانات وإرسالها للوكيل ${agent.name} عبر واتساب بنجاح`, 'success');
                } else {
                    saveToOfflineStorage('customer', customerData);
                    sendCustomerToWhatsApp(agent, customerData);
                    showAlert(alertDiv, `⚠️ لا يوجد اتصال بالإنترنت. تم حفظ البيانات محلياً وسيتم رفعها تلقائياً عند عودة الاتصال.\n\nتم إرسال البيانات للوكيل ${agent.name} عبر واتساب.`, 'info');
                }
                
                setTimeout(() => {
                    clearCustomerForm(true);
                }, 2000);
                
            } catch (error) {
                console.error('Error saving customer data:', error);
                
                if (!isOnline || error.message.includes('fetch') || error.message.includes('network')) {
                    saveToOfflineStorage('customer', customerData);
                    sendCustomerToWhatsApp(agent, customerData);
                    showAlert(alertDiv, `⚠️ لا يوجد اتصال بالإنترنت. تم حفظ البيانات محلياً وسيتم رفعها تلقائياً عند عودة الاتصال.\n\nتم إرسال البيانات للوكيل ${agent.name} عبر واتساب.`, 'info');
                } else {
                    sendCustomerToWhatsApp(agent, customerData);
                    showAlert(alertDiv, `تم إرسال البيانات للوكيل ${agent.name} عبر واتساب. حدث خطأ في حفظ البيانات: ${error.message}`, 'error');
                }
            }
        }


        function formatPhoneForWhatsApp(phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            
            if (cleanPhone.startsWith('964')) {
                return cleanPhone;
            }
            
            if (cleanPhone.startsWith('0')) {
                cleanPhone = cleanPhone.substring(1);
            }
            
            if (!cleanPhone.startsWith('964')) {
                cleanPhone = '964' + cleanPhone;
            }
            
            return cleanPhone;
        }

        async function sendCustomerToWhatsApp(agent, customerData) {
            const closestPoint = customerData.closest_point || customerData.closestPoint || 'غير محدد';
            const message = `*بيانات مشترك جديد*\n\n` +
                          `الاسم: ${customerData.username}\n` +
                          `المنطقة: ${customerData.region}\n` +
                          `أقرب نقطة دالة: ${closestPoint}\n` +
                          `رقم الهاتف: ${customerData.phone}\n` +
                          `التاريخ: ${customerData.date}`;

            const phone = formatPhoneForWhatsApp(agent.phone);
            const alertDiv = document.getElementById('customerAlert');
            
            // محاولة استخدام API إذا كان متاحاً
            if (useWhatsAppAPI && WHATSAPP_SERVER_URL) {
                try {
                    const response = await fetch(`${WHATSAPP_SERVER_URL}/api/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone: phone,
                            message: message
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showAlert(alertDiv, `تم إرسال البيانات للوكيل ${agent.name} عبر واتساب بنجاح`, 'success');
                        return;
                    } else {
                        console.warn('WhatsApp API failed, falling back to wa.me:', result.message);
                    }
                } catch (error) {
                    console.warn('WhatsApp API error, falling back to wa.me:', error);
                }
            }
            
            // Fallback إلى wa.me
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert(alertDiv, `تم إرسال البيانات للوكيل ${agent.name} عبر واتساب`, 'success');
        }

        function clearCustomerForm(skipConfirm) {
            if (skipConfirm || confirm('هل أنت متأكد أنك تريد مسح جميع الحقول؟')) {
                document.getElementById('txtName').value = '';
                document.getElementById('txtRegion').value = '';
                document.getElementById('txtNearestPoint').value = '';
                document.getElementById('txtPhone').value = '';
                document.getElementById('txtNotes').value = '';
                document.getElementById('selectAgent').value = '';
                document.getElementById('customerAlert').innerHTML = '';
                currentCustomerData = null;
            }
        }

        async function checkDuplicateCall(phone, name, details) {
            try {
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                
                const cached = getCachedData('calls');
                if (cached && cached.length > 0) {
                    const duplicates = cached.filter(c => 
                        c.phone === phone && c.name === name && c.details === details
                    );
                    
                    if (duplicates.length > 0) {
                        for (const duplicate of duplicates) {
                            if (duplicate.created_at) {
                                const duplicateDate = new Date(duplicate.created_at);
                                if (duplicateDate > oneHourAgo) {
                        return duplicate;
                                }
                            }
                        }
                    }
                }
                
                const phoneFilter = `?phone=eq.${encodeURIComponent(phone)}&name=eq.${encodeURIComponent(name)}&details=eq.${encodeURIComponent(details)}&order=created_at.desc`;
                const existingCalls = await supabaseRequest('calls', 'GET', null, phoneFilter);
                
                if (existingCalls && existingCalls.length > 0) {
                    for (const call of existingCalls) {
                        if (call.created_at) {
                            const callDate = new Date(call.created_at);
                            if (callDate > oneHourAgo) {
                                return call;
                            }
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error('Error checking duplicate call:', error);
                return null;
            }
        }

        /**
         * حفظ تفاصيل المكالمة في قاعدة البيانات
         * يتحقق من التكرار قبل الحفظ
         * يرسل الشكاوى تلقائياً للقسم المختار
         */
        async function saveCallDetails() {
            const callType = document.getElementById('cmbCallType').value.trim();
            const phone = document.getElementById('txtCallPhone').value.trim();
            const name = document.getElementById('txtCallName').value.trim();
            const details = document.getElementById('txtIssueDetails').value.trim();
            const selectedDepartment = document.getElementById('selectDepartment').value;
            const alertDiv = document.getElementById('callAlert');

            if (!callType || !phone || !name || !details) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول المطلوبة.', 'error');
                return;
            }

            if (isOnline) {
                showAlert(alertDiv, 'جاري التحقق من البيانات...', 'info');
                try {
                    const duplicate = await checkDuplicateCall(phone, name, details);
                    if (duplicate) {
                        const duplicateDate = new Date(duplicate.created_at);
                        const now = new Date();
                        const timeDiff = Math.ceil((now - duplicateDate) / (1000 * 60));
                        const remainingMinutes = 60 - timeDiff;
                        const canAddAfter = new Date(duplicateDate.getTime() + 60 * 60 * 1000);
                        
                        showAlert(alertDiv, `⚠️ هذه المكالمة موجودة مسبقاً في النظام!\n\nنوع المكالمة: ${duplicate.call_type}\nاسم المتصل: ${duplicate.name}\nرقم الهاتف: ${duplicate.phone}\nالتفاصيل: ${duplicate.details}\nالتاريخ: ${duplicate.created_at ? new Date(duplicate.created_at).toLocaleString('en-US') : 'غير محدد'}\n\nيمكنك إضافة نفس المكالمة مرة أخرى بعد مرور ساعة من آخر تسجيل.\nيمكنك الإضافة بعد: ${canAddAfter.toLocaleString('en-US')}`, 'error');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking duplicate:', error);
                }
            }

            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const date = now.toLocaleDateString('en-US');
            const shift = getCurrentShift();
            const shiftAndTime = `${date} ${time} - ${shift}`;

            let departmentName = null;
            if (selectedDepartment) {
                const department = departments.find(d => d.id === selectedDepartment || d.id.toString() === selectedDepartment);
                departmentName = department ? department.name : null;
            }

            const callData = {
                call_type: callType,
                phone: phone,
                name: name,
                details: details,
                agent: loggedInUser,
                shift_time: shiftAndTime,
                department: departmentName || null
            };

            showAlert(alertDiv, 'جاري حفظ البيانات...', 'info');

            try {
                if (isOnline) {
                    const result = await supabaseRequest('calls', 'POST', callData);
                    // Call data saved successfully
                    
                    const cached = getCachedData('calls');
                    if (cached && Array.isArray(cached)) {
                        cached.unshift(result[0] || callData);
                        setCachedData('calls', cached);
                    } else {
                        clearCache('calls');
                    }
                    
                    if (callsData && Array.isArray(callsData)) {
                        callsData.unshift(result[0] || callData);
                    }
                    
                    updateStatistics();
                    
                    showAlert(alertDiv, 'تم حفظ تفاصيل المكالمة بنجاح', 'success');
                } else {
                    saveToOfflineStorage('call', callData);
                    showAlert(alertDiv, '⚠️ لا يوجد اتصال بالإنترنت. تم حفظ البيانات محلياً وسيتم رفعها تلقائياً عند عودة الاتصال.', 'info');
                }
                
                if ((callType === 'شكوى' || callType === 'ضعف بالخدمة') && selectedDepartment) {
                    const department = departments.find(d => d.id === selectedDepartment);
                    if (department) {
                        setTimeout(() => {
                            sendComplaintToDepartment(department, callData);
                            if (isOnline) {
                                const employeeName = callData.agent || loggedInUser || 'غير معروف';
                                // Saving complaint with employee name
                                saveSentMessageToSupabase('complaint', department.id, department.name, callData.name, employeeName);
                            }
                        }, 500);
                    }
                }
                
                clearCallForm();
                
            } catch (error) {
                console.error('Error saving call data:', error);
                
                if (!isOnline || error.message.includes('fetch') || error.message.includes('network')) {
                    saveToOfflineStorage('call', callData);
                    showAlert(alertDiv, '⚠️ لا يوجد اتصال بالإنترنت. تم حفظ البيانات محلياً وسيتم رفعها تلقائياً عند عودة الاتصال.', 'info');
                } else {
                    showAlert(alertDiv, `حدث خطأ في حفظ البيانات: ${error.message}`, 'error');
                }
            }
        }

        async function sendComplaintToDepartment(department, callData) {
            const message = `*شكوى/مشكلة جديدة*\n\n` +
                          `نوع المكالمة: ${callData.call_type}\n` +
                          `اسم المتصل: ${callData.name}\n` +
                          `رقم الهاتف: ${callData.phone}\n` +
                          `التفاصيل: ${callData.details}\n` +
                          `الموظف: ${callData.agent}\n` +
                          `الوقت: ${callData.shift_time}`;

            const phone = formatPhoneForWhatsApp(department.phone);
            const alertDiv = document.getElementById('callAlert');
            
            // محاولة استخدام API إذا كان متاحاً
            if (useWhatsAppAPI && WHATSAPP_SERVER_URL) {
                try {
                    const response = await fetch(`${WHATSAPP_SERVER_URL}/api/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone: phone,
                            message: message
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showAlert(alertDiv, `تم إرسال الشكوى لقسم ${department.name} عبر واتساب بنجاح`, 'success');
                        return;
                    } else {
                        console.warn('WhatsApp API failed, falling back to wa.me:', result.message);
                    }
                } catch (error) {
                    console.warn('WhatsApp API error, falling back to wa.me:', error);
                }
            }
            
            // Fallback إلى wa.me
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert(alertDiv, `تم إرسال الشكوى لقسم ${department.name} عبر واتساب`, 'success');
        }

        function clearCallForm() {
            if (confirm('هل أنت متأكد أنك تريد مسح تفاصيل المكالمة؟')) {
                document.getElementById('cmbCallType').value = '';
                document.getElementById('txtCallPhone').value = '';
                document.getElementById('txtCallName').value = '';
                document.getElementById('txtIssueDetails').value = '';
                document.getElementById('selectDepartment').value = '';
                document.getElementById('callAlert').innerHTML = '';
            }
        }

        async function loadAllCustomers() {
            const resultsList = document.getElementById('searchResultsList');
            const alertDiv = document.getElementById('searchAlert');
            
            showAlert(alertDiv, 'جاري تحميل المشتركين...', 'info');
            
            try {
                allCustomersData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, `?order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allCustomersData = allCustomersData.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                if (allCustomersData && allCustomersData.length > 0) {
                    displayCustomersTable(allCustomersData);
                    document.getElementById('exportSearchBtn').style.display = 'inline-block';
                    window.searchResultsData = allCustomersData;
                    showAlert(alertDiv, `تم تحميل ${allCustomersData.length} مشترك`, 'success');
                } else {
                    resultsList.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">لا يوجد مشتركين</td></tr>';
                    showAlert(alertDiv, 'لا يوجد مشتركين', 'info');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showAlert(alertDiv, 'حدث خطأ أثناء تحميل المشتركين', 'error');
            }
        }
        
        function displayCustomersTable(customers) {
            const resultsList = document.getElementById('searchResultsList');
            resultsList.innerHTML = customers.map((customer, index) => {
                return `
                    <tr>
                        <td>${escapeHtml(customer.username || '')}</td>
                        <td>${escapeHtml(customer.region || '')}</td>
                        <td>${escapeHtml(customer.closest_point || '')}</td>
                        <td>${escapeHtml(customer.phone || '')}</td>
                        <td>${escapeHtml(customer.date || '')}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml((customer.notes || '').substring(0, 50))}${(customer.notes || '').length > 50 ? '...' : ''}</td>
                        <td>${escapeHtml(customer.employee || '')}</td>
                        <td>${escapeHtml(customer.agent || '')}</td>
                        <td>
                            <button class="btn btn-success" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="fillFormFromSearchResultByIndex(${index})">استخدام</button>
                            ${customer.agent ? `<button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="resendCustomerToAgentByIndex(${index})">إعادة إرسال للوكيل</button>` : ''}
                            ${currentUserRole === 'admin' ? `
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="editCustomerByIndex(${index})">تعديل</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;" onclick="deleteCustomerByIndex(${index})">حذف</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            window.currentCustomersData = customers;
        }
        
        function fillFormFromSearchResultByIndex(index) {
            if (window.currentCustomersData && window.currentCustomersData[index]) {
                fillFormFromSearchResult(window.currentCustomersData[index]);
            }
        }
        
        function resendCustomerToAgentByIndex(index) {
            if (window.currentCustomersData && window.currentCustomersData[index]) {
                resendCustomerToAgent(window.currentCustomersData[index]);
            }
        }
        
        function filterCustomers() {
            const searchQuery = document.getElementById('txtSearch').value.trim();
            const resultsList = document.getElementById('searchResultsList');
            
            if (allCustomersData.length === 0) {
                return;
            }
            
            if (!searchQuery) {
                displayCustomersTable(allCustomersData);
                return;
            }
            
            const filtered = allCustomersData.filter(customer => {
                const searchLower = searchQuery.toLowerCase();
                return (
                    (customer.username && customer.username.toLowerCase().includes(searchLower)) ||
                    (customer.region && customer.region.toLowerCase().includes(searchLower)) ||
                    (customer.closest_point && customer.closest_point.toLowerCase().includes(searchLower)) ||
                    (customer.phone && customer.phone.includes(searchQuery)) ||
                    (customer.notes && customer.notes.toLowerCase().includes(searchLower)) ||
                    (customer.employee && customer.employee.toLowerCase().includes(searchLower)) ||
                    (customer.agent && customer.agent.toLowerCase().includes(searchLower))
                );
            });
            
            if (filtered.length > 0) {
                displayCustomersTable(filtered);
                window.searchResultsData = filtered;
            } else {
                resultsList.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد نتائج</td></tr>';
            }
        }
        
        async function searchCustomers() {
            const searchQuery = document.getElementById('txtSearch').value.trim();
            const alertDiv = document.getElementById('searchAlert');
            const resultsList = document.getElementById('searchResultsList');

            if (!searchQuery) {
                showAlert(alertDiv, 'يرجى إدخال نص للبحث.', 'error');
                return;
            }

            resultsList.innerHTML = '';
            showAlert(alertDiv, 'جاري البحث...', 'info');

            try {
                const searchPattern = `%${searchQuery}%`;
                const filter = `?or=(username.ilike.${encodeURIComponent(searchPattern)},region.ilike.${encodeURIComponent(searchPattern)},closest_point.ilike.${encodeURIComponent(searchPattern)},phone.ilike.${encodeURIComponent(searchPattern)},notes.ilike.${encodeURIComponent(searchPattern)})&order=created_at.desc`;
                
                const data = await supabaseRequest('customers', 'GET', null, filter);
                
                if (Array.isArray(data) && data.length > 0) {
                    displayCustomersTable(data);
                    document.getElementById('exportSearchBtn').style.display = 'inline-block';
                    window.searchResultsData = data;
                    allCustomersData = data; 
                    showAlert(alertDiv, `تم العثور على ${data.length} نتيجة`, 'success');
                } else {
                    resultsList.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد نتائج</td></tr>';
                    document.getElementById('exportSearchBtn').style.display = 'none';
                    window.searchResultsData = [];
                    allCustomersData = [];
                    showAlert(alertDiv, 'لم يتم العثور على نتائج.', 'info');
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                showAlert(alertDiv, 'حدث خطأ أثناء البحث. تحقق من الاتصال بالإنترنت.', 'error');
            }
        }
        
        function fillFormFromSearchResult(customerJson) {
            try {
                const customer = typeof customerJson === 'string' ? JSON.parse(customerJson) : customerJson;
                switchTab('customer');
                document.getElementById('txtName').value = customer.username || '';
                document.getElementById('txtRegion').value = customer.region || '';
                document.getElementById('txtNearestPoint').value = customer.closest_point || '';
                document.getElementById('txtPhone').value = customer.phone || '';
                document.getElementById('txtDate').value = customer.date || '';
                document.getElementById('txtNotes').value = customer.notes || '';
            } catch (error) {
                console.error('Error in fillFormFromSearchResult:', error);
                showAlert(document.getElementById('searchAlert'), 'حدث خطأ أثناء تحميل البيانات', 'error');
            }
        }

        function fillFormFromSearch(item) {
            switchTab('customer');
            document.getElementById('txtName').value = item[0] || '';
            document.getElementById('txtRegion').value = item[1] || '';
            document.getElementById('txtNearestPoint').value = item[2] || '';
            document.getElementById('txtPhone').value = item[3] || '';
            document.getElementById('txtDate').value = item[4] || '';
            document.getElementById('txtNotes').value = item[5] || '';
        }

        async function loadAgents() {
            try {
                
                const cached = getCachedData('agents');
                if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                    agents = cached.map(agent => ({
                    id: agent.id.toString(),
                    name: agent.name,
                    phone: agent.phone,
                    address: agent.address || ''
                    }));
                displayAgents();
                updateAgentsSelect();
                    
                    loadAgentsFromDB();
                    return;
                }
                
                await loadAgentsFromDB();
            } catch (error) {
                console.error('Error loading agents:', error);
                agents = [];
                displayAgents();
                updateAgentsSelect();
            }
        }
        
        async function loadAgentsFromDB() {
            try {
                const data = await supabaseRequest('agents', 'GET', null, '?order=created_at.desc');
                agents = Array.isArray(data) ? data.map(agent => ({
                    id: agent.id.toString(),
                    name: agent.name,
                    phone: agent.phone,
                    address: agent.address || ''
                })) : [];
                setCachedData('agents', data);
                displayAgents();
                updateAgentsSelect();
            } catch (error) {
                console.error('Error loading agents from DB:', error);
            }
        }

        async function saveAgents() {
            displayAgents();
            updateAgentsSelect();
        }

        let agentsSearchFilter = '';
        
        function filterAgentsList() {
            const searchInput = document.getElementById('agentsSearchInput');
            const clearBtn = document.getElementById('clearAgentsSearchBtn');
            if (searchInput) {
                agentsSearchFilter = searchInput.value.trim().toLowerCase();
                if (clearBtn) {
                    clearBtn.style.display = agentsSearchFilter ? 'block' : 'none';
                }
            }
            displayAgents();
        }
        
        function clearAgentsSearch() {
            const searchInput = document.getElementById('agentsSearchInput');
            const clearBtn = document.getElementById('clearAgentsSearchBtn');
            if (searchInput) {
                searchInput.value = '';
                agentsSearchFilter = '';
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            }
            displayAgents();
        }

        function displayAgents() {
            const container = document.getElementById('agentsList');
            if (!container) return;
            
            let filteredAgents = agents;
            
            if (agentsSearchFilter) {
                filteredAgents = agents.filter(agent => {
                    const name = (agent.name || '').toLowerCase();
                    const phone = (agent.phone || '').toLowerCase();
                    const address = (agent.address || '').toLowerCase();
                    return name.includes(agentsSearchFilter) || 
                           phone.includes(agentsSearchFilter) || 
                           address.includes(agentsSearchFilter);
                });
            }
            
            if (filteredAgents.length === 0) {
                if (agentsSearchFilter) {
                    container.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 20px;">لا توجد نتائج للبحث "${agentsSearchFilter}"</p>`;
                } else {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">لا يوجد وكلاء مسجلين</p>';
                }
                return;
            }

            container.innerHTML = filteredAgents.map(agent => {
                const nameEscaped = (agent.name || '').replace(/'/g, "\\'");
                const phoneEscaped = (agent.phone || '').replace(/'/g, "\\'");
                const addressEscaped = (agent.address || '').replace(/'/g, "\\'");
                return `
                <div class="agent-card">
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-phone">${agent.phone}</div>
                        ${agent.address ? `<div class="agent-phone" style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 5px;">📍 ${agent.address}</div>` : ''}
                    </div>
                    <div class="agent-actions">
                        <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.85rem; margin-left: 5px;" onclick="openEditAgentModal(${agent.id}, '${nameEscaped}', '${phoneEscaped}', '${addressEscaped}')">تعديل</button>
                        <button class="btn btn-danger" style="padding: 8px 15px; font-size: 0.85rem;" onclick="deleteAgent(${agent.id})">حذف</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateAgentsSelect() {
            const select = document.getElementById('selectAgent');
            select.innerHTML = '<option value="">لا يوجد</option>' + 
                agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
        }

        function openAddAgentModal() {
            document.getElementById('addAgentModal').classList.add('active');
            document.getElementById('addAgentModalTitle').textContent = 'إضافة وكيل جديد';
            document.getElementById('editAgentId').value = '';
            document.getElementById('agentName').value = '';
            document.getElementById('agentPhone').value = '';
            document.getElementById('agentAddress').value = '';
            document.getElementById('addAgentAlert').innerHTML = '';
        }
        
        function openEditAgentModal(id, name, phone, address = '') {
            document.getElementById('addAgentModal').classList.add('active');
            document.getElementById('addAgentModalTitle').textContent = 'تعديل وكيل';
            document.getElementById('editAgentId').value = id;
            document.getElementById('agentName').value = name;
            document.getElementById('agentPhone').value = phone;
            document.getElementById('agentAddress').value = address || '';
            document.getElementById('addAgentAlert').innerHTML = '';
        }

        function closeAddAgentModal() {
            document.getElementById('addAgentModal').classList.remove('active');
        }

        async function saveAgent() {
            const editId = document.getElementById('editAgentId').value;
            const name = document.getElementById('agentName').value.trim();
            const phone = document.getElementById('agentPhone').value.trim();
            const address = document.getElementById('agentAddress').value.trim();
            const alertDiv = document.getElementById('addAgentAlert');

            if (!name || !phone) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول المطلوبة (الاسم ورقم الهاتف).', 'error');
                return;
            }

            try {
                const agentData = {
                    name: name,
                    phone: phone
                };
                
                if (address && address.trim()) {
                    agentData.address = address.trim();
                }
                
                if (editId) {
                    await supabaseRequest('agents', 'PATCH', agentData, `?id=eq.${editId}`);
                    showAlert(alertDiv, 'تم تحديث الوكيل بنجاح', 'success');
                    showAlert(document.getElementById('agentsAlert'), 'تم تحديث الوكيل بنجاح', 'success');
                } else {
                    await supabaseRequest('agents', 'POST', agentData);
                    showAlert(alertDiv, 'تم إضافة الوكيل بنجاح', 'success');
                    showAlert(document.getElementById('agentsAlert'), 'تم إضافة الوكيل بنجاح', 'success');
                }
                
                closeAddAgentModal();
                await loadAgents();
            } catch (error) {
                console.error('Error saving agent:', error);
                if (error.message && error.message.includes('address')) {
                    try {
                        const agentDataWithoutAddress = {
                            name: name,
                            phone: phone
                        };
                        if (editId) {
                            await supabaseRequest('agents', 'PATCH', agentDataWithoutAddress, `?id=eq.${editId}`);
                            showAlert(alertDiv, 'تم تحديث الوكيل بنجاح (تم تجاهل العنوان)', 'success');
                            showAlert(document.getElementById('agentsAlert'), 'تم تحديث الوكيل بنجاح', 'success');
                        } else {
                            await supabaseRequest('agents', 'POST', agentDataWithoutAddress);
                            showAlert(alertDiv, 'تم إضافة الوكيل بنجاح (تم تجاهل العنوان)', 'success');
                            showAlert(document.getElementById('agentsAlert'), 'تم إضافة الوكيل بنجاح', 'success');
                        }
                        closeAddAgentModal();
                        await loadAgents();
                        return;
                    } catch (retryError) {
                        console.error('Error saving agent without address:', retryError);
                    }
                }
                showAlert(alertDiv, `حدث خطأ: ${error.message}`, 'error');
            }
        }

        async function deleteAgent(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الوكيل؟')) {
                return;
            }
            
            try {
                await supabaseRequest('agents', 'DELETE', null, `?id=eq.${id}`);
                await loadAgents();
                showAlert(document.getElementById('agentsAlert'), 'تم حذف الوكيل ', 'success');
            } catch (error) {
                console.error('Error deleting agent:', error);
                showAlert(document.getElementById('agentsAlert'), 'حدث خطأ أثناء حذف الوكيل', 'error');
            }
        }

        async function loadDepartments() {
            try {
                
                const cached = getCachedData('departments');
                if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                    departments = cached.map(dept => ({
                    id: dept.id.toString(),
                    name: dept.name,
                    phone: dept.phone
                    }));
                displayDepartments();
                updateDepartmentsSelect();
                    
                    loadDepartmentsFromDB();
                    return;
                }
                
                await loadDepartmentsFromDB();
            } catch (error) {
                console.error('Error loading departments:', error);
                departments = [];
                displayDepartments();
                updateDepartmentsSelect();
            }
        }
        
        async function loadDepartmentsFromDB() {
            try {
                const data = await supabaseRequest('departments', 'GET', null, '?order=created_at.desc');
                departments = Array.isArray(data) ? data.map(dept => ({
                    id: dept.id.toString(),
                    name: dept.name,
                    phone: dept.phone
                })) : [];
                setCachedData('departments', data);
                displayDepartments();
                updateDepartmentsSelect();
            } catch (error) {
                console.error('Error loading departments from DB:', error);
            }
        }

        async function saveDepartments() {
            displayDepartments();
            updateDepartmentsSelect();
        }

        function displayDepartments() {
            const container = document.getElementById('departmentsList');
            if (departments.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">لا يوجد أقسام مسجلة</p>';
                return;
            }

            container.innerHTML = departments.map(dept => `
                <div class="agent-card">
                    <div class="agent-info">
                        <div class="agent-name">${dept.name}</div>
                        <div class="agent-phone">${dept.phone}</div>
                    </div>
                    <div class="agent-actions">
                        <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.85rem; margin-left: 5px;" onclick="openEditDepartmentModal('${dept.id}', '${dept.name}', '${dept.phone}')">تعديل</button>
                        <button class="btn btn-danger" style="padding: 8px 15px; font-size: 0.85rem;" onclick="deleteDepartment('${dept.id}')">حذف</button>
                    </div>
                </div>
            `).join('');
        }

        function updateDepartmentsSelect() {
            const select = document.getElementById('selectDepartment');
            select.innerHTML = '<option value="">لا يوجد</option>' + 
                departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
        }

        function openAddDepartmentModal() {
            document.getElementById('addDepartmentModal').classList.add('active');
            document.getElementById('addDepartmentModalTitle').textContent = 'إضافة قسم جديد';
            document.getElementById('editDepartmentId').value = '';
            document.getElementById('departmentName').value = '';
            document.getElementById('departmentPhone').value = '';
            document.getElementById('addDepartmentAlert').innerHTML = '';
        }
        
        function openEditDepartmentModal(id, name, phone) {
            document.getElementById('addDepartmentModal').classList.add('active');
            document.getElementById('addDepartmentModalTitle').textContent = 'تعديل قسم';
            document.getElementById('editDepartmentId').value = id;
            document.getElementById('departmentName').value = name;
            document.getElementById('departmentPhone').value = phone;
            document.getElementById('addDepartmentAlert').innerHTML = '';
        }

        function closeAddDepartmentModal() {
            document.getElementById('addDepartmentModal').classList.remove('active');
        }

        async function saveDepartment() {
            const editId = document.getElementById('editDepartmentId').value;
            const name = document.getElementById('departmentName').value.trim();
            const phone = document.getElementById('departmentPhone').value.trim();
            const alertDiv = document.getElementById('addDepartmentAlert');

            if (!name || !phone) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول.', 'error');
                return;
            }

            try {
                const departmentData = {
                    name: name,
                    phone: phone
                };
                
                if (editId) {
                    await supabaseRequest('departments', 'PATCH', departmentData, `?id=eq.${editId}`);
                    showAlert(alertDiv, 'تم تحديث القسم بنجاح', 'success');
                    showAlert(document.getElementById('departmentsAlert'), 'تم تحديث القسم بنجاح', 'success');
                } else {
                    await supabaseRequest('departments', 'POST', departmentData);
                    showAlert(alertDiv, 'تم إضافة القسم بنجاح', 'success');
                    showAlert(document.getElementById('departmentsAlert'), 'تم إضافة القسم بنجاح', 'success');
                }
                
                closeAddDepartmentModal();
                await loadDepartments();
            } catch (error) {
                console.error('Error saving department:', error);
                showAlert(alertDiv, `حدث خطأ: ${error.message}`, 'error');
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('هل أنت متأكد من حذف هذا القسم؟')) {
                return;
            }
            
            try {
                await supabaseRequest('departments', 'DELETE', null, `?id=eq.${id}`);
                await loadDepartments();
                showAlert(document.getElementById('departmentsAlert'), 'تم حذف القسم بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting department:', error);
                showAlert(document.getElementById('departmentsAlert'), 'حدث خطأ أثناء حذف القسم', 'error');
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'light' ? '🌙' : '☀️';
            }
            localStorage.setItem('theme', currentTheme);
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'light' ? '🌙' : '☀️';
            }
        }

        function showAlert(container, message, type) {
            const alertClass = `alert-${type}`;
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const titles_default = {
                success: 'نجح',
                error: 'خطأ',
                warning: 'تحذير',
                info: 'معلومة'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titles_default[type] || 'معلومة'}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function validateInput(input, type = 'text') {
            const value = input.value.trim();
            let isValid = true;
            let message = '';
            
            if (type === 'phone') {
                const phoneRegex = /^(\+964|0)?[7][0-9]{9}$/;
                isValid = phoneRegex.test(value);
                message = isValid ? '' : 'رقم الهاتف غير صحيح. يجب أن يبدأ بـ 07 ويحتوي على 10 أرقام';
            } else if (type === 'required') {
                isValid = value.length > 0;
                message = isValid ? '' : 'هذا الحقل مطلوب';
            } else if (type === 'name') {
                isValid = value.length >= 2;
                message = isValid ? '' : 'الاسم يجب أن يكون على الأقل حرفين';
            }
            
            if (isValid) {
                input.classList.remove('input-error');
                input.classList.add('input-success');
            } else {
                input.classList.remove('input-success');
                input.classList.add('input-error');
            }
            
            let msgEl = input.parentElement.querySelector('.validation-message');
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.className = 'validation-message';
                input.parentElement.appendChild(msgEl);
            }
            
            if (message) {
                msgEl.textContent = message;
                msgEl.className = 'validation-message show error';
            } else {
                msgEl.className = 'validation-message';
            }
            
            return isValid;
        }
        
        function timeAgo(date) {
            if (!date) return 'غير محدد';
            
            const now = new Date();
            const past = new Date(date);
            
            if (isNaN(past.getTime())) return 'غير محدد';
            
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) return 'الآن';
            if (diffInSeconds < 3600) return `منذ ${Math.floor(diffInSeconds / 60)} دقيقة`;
            if (diffInSeconds < 86400) return `منذ ${Math.floor(diffInSeconds / 3600)} ساعة`;
            if (diffInSeconds < 604800) return `منذ ${Math.floor(diffInSeconds / 86400)} يوم`;
            if (diffInSeconds < 2592000) return `منذ ${Math.floor(diffInSeconds / 604800)} أسبوع`;
            return past.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        let callsData = [];
        let customersData = [];

        /**
         * جلب بيانات المكالمات من قاعدة البيانات
         * @param {boolean} forceRefresh - إجبار التحديث حتى لو كانت البيانات موجودة في الكاش
         * @returns {Promise<Array>} بيانات المكالمات
         */
        async function fetchCallsData(forceRefresh = false) {
            try {
                
                if (!forceRefresh) {
                    const cached = getCachedData('calls');
                    if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                        callsData = cached;
                        return cached;
                    }
                }
                
                callsData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                const seenIds = new Set(); 
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, `?order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        
                        const uniqueBatch = batch.filter(call => {
                            const callId = call.id || call[6] || JSON.stringify(call);
                            if (seenIds.has(callId)) {
                                return false;
                            }
                            seenIds.add(callId);
                            return true;
                        });
                        callsData = callsData.concat(uniqueBatch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                setCachedData('calls', callsData); 
                return callsData;
            } catch (error) {
                console.error('Error fetching calls data:', error);
                
                try {
                    const data = await supabaseRequest('calls', 'GET', null, '?order=created_at.desc');
                    if (Array.isArray(data)) {
                        
                        const uniqueData = [];
                        const seenIds = new Set();
                        data.forEach(call => {
                            const callId = call.id || call[6] || JSON.stringify(call);
                            if (!seenIds.has(callId)) {
                                seenIds.add(callId);
                                uniqueData.push(call);
                            }
                        });
                        callsData = uniqueData;
                        setCachedData('calls', callsData); 
                    } else {
                        callsData = [];
                    }
                    return callsData;
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                callsData = [];
                return [];
            }
            }
        }
        

        /**
         * جلب بيانات المشتركين من قاعدة البيانات
         * @param {boolean} forceRefresh - إجبار التحديث حتى لو كانت البيانات موجودة في الكاش
         * @returns {Promise<Array>} بيانات المشتركين
         */
        async function fetchCustomersData(forceRefresh = false) {
            try {
                
                if (!forceRefresh) {
                    const cached = getCachedData('customers');
                    if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                        customersData = cached;
                        return cached;
                    }
                }
                
                let allCustomers = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, `?order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allCustomers = allCustomers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                customersData = allCustomers;
                setCachedData('customers', allCustomers); 
                return customersData;
            } catch (error) {
                console.error('Error fetching customers data:', error);
                try {
                    const data = await supabaseRequest('customers', 'GET', null, '?order=created_at.desc');
                    customersData = Array.isArray(data) ? data : [];
                    setCachedData('customers', customersData); 
                    return customersData;
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    customersData = [];
                    return [];
                }
            }
        }

        async function saveSentMessageToSupabase(type, recipientId, recipientName, subject, employeeNameOverride = null) {
            try {
                const employeeName = employeeNameOverride || loggedInUser || 'غير معروف';
                const messageData = {
                    type: type,
                    agent_id: recipientId,
                    agent_name: recipientName,
                    customer_name: subject,
                    employee_name: employeeName
                };
                console.log('Saving sent message with employee_name:', employeeName, 'loggedInUser:', loggedInUser, 'Full data:', messageData);
                const result = await supabaseRequest('sent_messages', 'POST', messageData);
                console.log('Sent message saved to Supabase:', result);
                if (result && Array.isArray(result) && result.length > 0) {
                    console.log('Saved message employee_name:', result[0].employee_name);
                }
            } catch (error) {
                console.error('Error saving sent message:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }
        
        function saveSentMessage(type, recipientId, recipientName, subject) {
            saveSentMessageToSupabase(type, recipientId, recipientName, subject);
        }

        let isRefreshing = false; 

        async function refreshStatistics() {
            
            if (isRefreshing) {
                return;
            }
            
            isRefreshing = true;
            
            
            const totalCallsEl = document.getElementById('totalCalls');
            const totalComplaintsEl = document.getElementById('totalComplaints');
            const totalCustomersEl = document.getElementById('totalCustomers');
            
            if (!totalCallsEl.textContent || totalCallsEl.textContent === '0' || totalCallsEl.textContent === '...') {
                totalCallsEl.textContent = '...';
                totalComplaintsEl.textContent = '...';
                totalCustomersEl.textContent = '...';
            }
            
            try {
                
                const [callsResult, customersResult] = await Promise.all([
                        fetchCallsData(false),
                        fetchCustomersData(false)
                ]);
                
                if (callsResult && callsResult.length > 0) {
                    callsData = callsResult;
                }
                if (customersResult && customersResult.length > 0) {
                    customersData = customersResult;
                }
                
                updateStatistics();
            } catch (error) {
                console.error('Error refreshing statistics:', error);
                
                const cachedCalls = getCachedData('calls');
                const cachedCustomers = getCachedData('customers');
                if (cachedCalls && cachedCustomers) {
                    callsData = cachedCalls;
                    customersData = cachedCustomers;
                    updateStatistics();
                } else {
                loadLocalStatistics();
                }
            } finally {
                isRefreshing = false;
            }
        }
        
        function updateStatistics() {
            
            const totalCalls = (callsData && Array.isArray(callsData)) ? callsData.length : 0;
            const totalCallsEl = document.getElementById('totalCalls');
            if (totalCallsEl) totalCallsEl.textContent = totalCalls.toLocaleString('en-US');
            
            const totalComplaints = (callsData && Array.isArray(callsData)) ? callsData.filter(c => 
                c.call_type === 'شكوى' || c.call_type === 'ضعف بالخدمة'
            ).length : 0;
            const totalComplaintsEl = document.getElementById('totalComplaints');
            if (totalComplaintsEl) totalComplaintsEl.textContent = totalComplaints.toLocaleString('en-US');
            
            const totalCustomers = (customersData && Array.isArray(customersData)) ? customersData.length : 0;
            const totalCustomersEl = document.getElementById('totalCustomers');
            if (totalCustomersEl) totalCustomersEl.textContent = totalCustomers.toLocaleString('en-US');
            
            
            Promise.all([
                fetchSentMessagesCount().catch(() => 0),
                fetchAgentsCount().catch(() => agents.length || 0),
                fetchDepartmentsCount().catch(() => departments.length || 0)
            ]).then(([sentCount, agentsCount, deptsCount]) => {
                const totalSentEl = document.getElementById('totalSent');
                if (totalSentEl) totalSentEl.textContent = sentCount.toLocaleString('en-US');
                
                const totalAgentsEl = document.getElementById('totalAgents');
                if (totalAgentsEl) totalAgentsEl.textContent = agentsCount.toLocaleString('en-US');
                
                const totalDepartmentsEl = document.getElementById('totalDepartments');
                if (totalDepartmentsEl) totalDepartmentsEl.textContent = deptsCount.toLocaleString('en-US');
            });
            
            
            updateCallsTypeChart();
            // تحديث خريطة الأسماء قبل تحديث المخططات (غير متزامن)
            updateEmployeeNameMap().then(() => {
                updateCallsByEmployeeChart();
            }).catch(() => {
                // في حالة الخطأ، نحدث المخطط على أي حال
                updateCallsByEmployeeChart();
            });
            
            
            updateAgentsStatistics();
            updateRecentActivity();
            
            
            updateEmployeeOfTheWeek().catch(err => {
                console.error('Error updating employee of the week:', err);
            });
        }
        
        
        async function calculateEmployeeOfTheWeek() {
            try {
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                
                
                let diff;
                if (dayOfWeek === 6) { 
                    diff = 0; 
                } else if (dayOfWeek === 0) { 
                    diff = -1; 
                } else { 
                    diff = dayOfWeek - 6; 
                }
                
                const currentWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
                currentWeekStart.setHours(0, 0, 0, 0);
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 7);
                
                
                const lastWeekStart = new Date(currentWeekStart);
                lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                const lastWeekEnd = new Date(currentWeekStart);
                
                
                const weekStartStr = lastWeekStart.toISOString().split('T')[0];
                const existingFilter = `?week_start_date=eq.${weekStartStr}`;
                const existing = await supabaseRequest('employee_of_the_week', 'GET', null, existingFilter);
                
                
                const isSaturday = dayOfWeek === 6;
                const currentHour = now.getHours();
                const canCalculateNew = isSaturday && currentHour >= 8;
                
                if (existing && existing.length > 0) {
                    const employee = existing[0];
                    const expiresAt = employee.expires_at ? new Date(employee.expires_at) : null;
                    const nowDate = new Date();
                    
                    
                    const employeeName = (employee.employee_name || '').trim();
                    const isValidName = employeeName && 
                                       employeeName !== '' && 
                                       employeeName !== 'غير محدد' &&
                                       employeeName !== 'null' &&
                                       employeeName !== 'undefined' &&
                                       !/^[A-Za-z\s]+$/.test(employeeName);
                    
                    
                    if (expiresAt && expiresAt > nowDate && isValidName) {
                        return employee;
                    } else if (!isValidName) {
                        
                        try {
                            await supabaseRequest('employee_of_the_week', 'DELETE', null, `?id=eq.${employee.id}`);
                        } catch (e) {
                            console.warn('Error deleting invalid employee record:', e);
                        }
                    }
                }
                
                
                if (!canCalculateNew) {
                    return existing && existing.length > 0 ? existing[0] : null;
                }
                
                
                const weekStart = lastWeekStart;
                const weekEnd = lastWeekEnd;
                
                
                const callsFilter = `?created_at=gte.${weekStart.toISOString()}&created_at=lt.${weekEnd.toISOString()}`;
                const customersFilter = `?created_at=gte.${weekStart.toISOString()}&created_at=lt.${weekEnd.toISOString()}`;
                
                let calls = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, callsFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        calls = calls.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                let customers = [];
                from = 0;
                hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, customersFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        customers = customers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                
                const employeeStats = {};
                
                function isValidEmployeeName(name) {
                    if (!name || typeof name !== 'string') return false;
                    const trimmed = name.trim();
                    if (trimmed === '' || trimmed === 'غير محدد' || trimmed === 'null' || trimmed === 'undefined') return false;
                    if (EXCLUDED_EMPLOYEES.includes(trimmed)) return false;
                    
                    const englishPattern = /^[A-Za-z\s]+$/;
                    if (englishPattern.test(trimmed) && trimmed.length < 20) return false;
                    return true;
                }
                
                calls.forEach(call => {
                    const oldEmployeeName = (call.agent || '').trim();
                    const employee = getUnifiedEmployeeName(oldEmployeeName);
                    if (isValidEmployeeName(employee)) {
                        if (!employeeStats[employee]) {
                            employeeStats[employee] = {
                                name: employee,
                                calls: 0,
                                customers: 0,
                                score: 0
                            };
                        }
                        employeeStats[employee].calls++;
                        employeeStats[employee].score += 1; 
                    }
                });
                
                customers.forEach(customer => {
                    const oldEmployeeName = (customer.employee || '').trim();
                    const employee = getUnifiedEmployeeName(oldEmployeeName);
                    if (isValidEmployeeName(employee)) {
                        if (!employeeStats[employee]) {
                            employeeStats[employee] = {
                                name: employee,
                                calls: 0,
                                customers: 0,
                                score: 0
                            };
                        }
                        employeeStats[employee].customers++;
                        employeeStats[employee].score += 2; 
                    }
                });
                
                
                let bestEmployee = null;
                let maxScore = 0;
                
                Object.values(employeeStats).forEach(emp => {
                    if (emp.score > maxScore && isValidEmployeeName(emp.name)) {
                        maxScore = emp.score;
                        bestEmployee = emp;
                    }
                });
                
                if (bestEmployee && maxScore > 0) {
                    
                    
                    const expiresAt = new Date(currentWeekEnd);
                    expiresAt.setHours(23, 59, 59, 999); 
                    
                    const employeeData = {
                        employee_name: bestEmployee.name,
                        week_start_date: weekStartStr,
                        week_end_date: weekEnd.toISOString().split('T')[0],
                        total_calls: bestEmployee.calls,
                        total_customers: bestEmployee.customers,
                        total_score: bestEmployee.score,
                        expires_at: expiresAt.toISOString()
                    };
                    
                    if (existing && existing.length > 0) {
                        
                        await supabaseRequest('employee_of_the_week', 'PATCH', employeeData, `?id=eq.${existing[0].id}`);
                        return { ...existing[0], ...employeeData };
                    } else {
                        
                        const result = await supabaseRequest('employee_of_the_week', 'POST', employeeData);
                        return Array.isArray(result) ? result[0] : result;
                    }
                }
                
                return existing && existing.length > 0 ? existing[0] : null;
            } catch (error) {
                console.error('Error calculating employee of the week:', error);
                return null;
            }
        }
        
        
        async function updateEmployeeOfTheWeek() {
            try {
                const now = new Date();
                    const employee = await calculateEmployeeOfTheWeek();
                    const banner = document.getElementById('employeeOfTheWeekBanner');
                    
                
                function isValidEmployeeName(name) {
                    if (!name || typeof name !== 'string') return false;
                    const trimmed = name.trim();
                    if (trimmed === '' || trimmed === 'غير محدد' || trimmed === 'null' || trimmed === 'undefined') return false;
                    
                    const englishPattern = /^[A-Za-z\s]+$/;
                    if (englishPattern.test(trimmed) && trimmed.length < 20) return false;
                    return true;
                }
                
                if (employee && employee.employee_name && isValidEmployeeName(employee.employee_name)) {
                    const expiresAt = employee.expires_at ? new Date(employee.expires_at) : null;
                    
                    
                    if (expiresAt && expiresAt > now) {
                        document.getElementById('employeeOfWeekName').textContent = employee.employee_name.trim();
                        document.getElementById('employeeOfWeekCalls').textContent = employee.total_calls || 0;
                        document.getElementById('employeeOfWeekCustomers').textContent = employee.total_customers || 0;
                        document.getElementById('employeeOfWeekScore').textContent = employee.total_score || 0;
                        
                        const weekStart = employee.week_start_date ? new Date(employee.week_start_date) : null;
                        const weekEnd = employee.week_end_date ? new Date(employee.week_end_date) : null;
                        
                        if (weekStart && weekEnd) {
                            const periodText = `من ${weekStart.toLocaleDateString('en-US')} إلى ${weekEnd.toLocaleDateString('en-US')}`;
                            document.getElementById('employeeOfWeekPeriod').textContent = periodText;
                        } else {
                            document.getElementById('employeeOfWeekPeriod').textContent = '';
                        }
                        
                        banner.style.display = 'block';
                    } else {
                        banner.style.display = 'none';
                    }
                } else {
                    banner.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating employee of the week:', error);
                document.getElementById('employeeOfTheWeekBanner').style.display = 'none';
            }
        }
        
        async function fetchSentMessagesCount() {
            try {
                
                const cached = getCachedData('sentMessages');
                if (cached !== null && typeof cached === 'number') {
                    return cached;
                }
                
                
                const result = await supabaseRequest('sent_messages', 'GET', null, '?select=id&limit=1');
                if (!result || result.length === 0) {
                    setCachedData('sentMessages', 0);
                    return 0;
                }
                
                
                let allData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('sent_messages', 'GET', null, '?select=id', {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allData = allData.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                const count = allData.length;
                setCachedData('sentMessages', count);
                return count;
            } catch (error) {
                console.error('Error fetching sent messages count:', error);
                return 0;
            }
        }
        
        async function fetchAgentsCount() {
            try {
                
                if (agents && agents.length > 0) {
                    return agents.length;
                }
                
                
                const cached = getCachedData('agents');
                if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                    return cached.length;
                }
                
                
                let allData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('agents', 'GET', null, '?select=id', {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allData = allData.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                return allData.length;
            } catch (error) {
                console.error('Error fetching agents count:', error);
                return agents.length || 0;
            }
        }
        
        async function fetchDepartmentsCount() {
            try {
                
                if (departments && departments.length > 0) {
                    return departments.length;
                }
                
                
                const cached = getCachedData('departments');
                if (cached !== null && Array.isArray(cached) && cached.length > 0) {
                    return cached.length;
                }
                
                
                let allData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('departments', 'GET', null, '?select=id', {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allData = allData.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                return allData.length;
            } catch (error) {
                console.error('Error fetching departments count:', error);
                return departments.length || 0;
            }
        }

        function loadLocalStatistics() {
            document.getElementById('totalCalls').textContent = '0';
            document.getElementById('totalComplaints').textContent = '0';
            document.getElementById('totalCustomers').textContent = '0';
            document.getElementById('totalSent').textContent = '0';
            document.getElementById('totalAgents').textContent = '0';
            document.getElementById('totalDepartments').textContent = '0';
            
            document.getElementById('callsTypeChart').innerHTML = '<p style="color: var(--text-secondary);">لا توجد بيانات</p>';
            document.getElementById('callsByEmployeeChart').innerHTML = '<p style="color: var(--text-secondary);">لا توجد بيانات</p>';
            
            const tbody = document.getElementById('agentsStatsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: var(--text-secondary);">لا توجد بيانات</td></tr>';
            }
            
            const recentActivity = document.getElementById('recentActivity');
            if (recentActivity) {
                recentActivity.innerHTML = '<p style="text-align: center; color: var(--text-primary); padding: 20px;">لا توجد بيانات</p>';
            }
        }

        function updateCallsTypeChart() {
            if (!callsData || callsData.length === 0) {
                document.getElementById('callsTypeChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 10px;">📊</div><p>لا توجد بيانات</p></div>';
                return;
            }
            
            const callsByType = {};
            callsData.forEach(call => {
                const callType = call.call_type || call[0] || 'غير محدد';
                if (callType) {
                    callsByType[callType] = (callsByType[callType] || 0) + 1;
                }
            });
            
            if (Object.keys(callsByType).length === 0) {
                document.getElementById('callsTypeChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 10px;">📊</div><p>لا توجد بيانات</p></div>';
                return;
            }
            
            const maxValue = Math.max(...Object.values(callsByType));
            const totalCalls = callsData.length;
            const sortedEntries = Object.entries(callsByType).sort((a, b) => b[1] - a[1]);
            const chart = document.getElementById('callsTypeChart');
            
            chart.innerHTML = `
                ${sortedEntries.map(([type, count]) => {
                    const percentage = maxValue > 0 ? (count / maxValue) * 100 : 0;
                    const typePercentage = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(1) : 0;
                    const typeColor = type === 'شكوى' || type === 'ضعف بالخدمة' ? '#ef4444' : '#3b82f6';
                    return `
                        <div class="bar-item">
                            <div class="bar-label" style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 0.9rem;">${type === 'شكوى' ? '⚠️' : type === 'استفسار' ? '❓' : type === 'طلب' ? '📋' : '📞'}</span>
                                <span>${type}</span>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar-fill" style="width: ${percentage}%; background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}dd 100%);">
                                    <span style="color: white; font-weight: 700; font-size: 0.7rem;">${count.toLocaleString('en-US')}</span>
                            </div>
                            </div>
                            <div class="bar-value" style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span style="font-size: 0.8rem; font-weight: 800;">${count.toLocaleString('en-US')}</span>
                                <span style="font-size: 0.65rem; color: var(--text-tertiary);">${typePercentage}%</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        /**
         * تحديث مخطط المكالمات حسب الموظف
         * يستبعد الموظفين المحددين في EXCLUDED_EMPLOYEES
         * يوحد الأسماء القديمة والجديدة للموظفين
         */
        function updateCallsByEmployeeChart() {
            if (!callsData || callsData.length === 0) {
                document.getElementById('callsByEmployeeChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 10px;">👤</div><p>لا توجد بيانات</p></div>';
                return;
            }
            
            const callsByEmployee = {};
            callsData.forEach(call => {
                const oldEmployeeName = call.agent || call[4] || 'غير معروف';
                const employee = getUnifiedEmployeeName(oldEmployeeName);
                if (employee && employee !== 'غير معروف' && !EXCLUDED_EMPLOYEES.includes(employee)) {
                    callsByEmployee[employee] = (callsByEmployee[employee] || 0) + 1;
                }
            });
            
            if (Object.keys(callsByEmployee).length === 0) {
                document.getElementById('callsByEmployeeChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 10px;">👤</div><p>لا توجد بيانات</p></div>';
                return;
            }
            
            const maxValue = Math.max(...Object.values(callsByEmployee));
            const totalCalls = callsData.length;
            const sortedEntries = Object.entries(callsByEmployee).sort((a, b) => b[1] - a[1]).slice(0, 15);
            const chart = document.getElementById('callsByEmployeeChart');
            
            chart.innerHTML = `
                ${sortedEntries.map(([employee, count], index) => {
                    const percentage = maxValue > 0 ? (count / maxValue) * 100 : 0;
                    const employeePercentage = totalCalls > 0 ? ((count / totalCalls) * 100).toFixed(1) : 0;
                    const rank = index + 1;
                    const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];
                    const colorIndex = index % colors.length;
                    const barColor = colors[colorIndex];
                    return `
                        <div class="bar-item" style="padding: 4px 8px;">
                            <div class="bar-label" style="display: flex; align-items: center; gap: 6px; min-width: 140px;">
                                <span style="font-weight: 700; font-size: 0.75rem;">${employee}</span>
                            </div>
                            <div class="bar-wrapper" style="height: 18px;">
                                <div class="bar-fill" style="width: ${percentage}%; background: linear-gradient(135deg, ${barColor} 0%, ${barColor}dd 100%); border-radius: 9px;">
                                    <span style="color: white; font-weight: 700; font-size: 0.65rem;">${count.toLocaleString('en-US')}</span>
                                </div>
                            </div>
                            <div class="bar-value" style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <span style="font-size: 0.8rem; font-weight: 800;">${count.toLocaleString('en-US')}</span>
                                <span style="font-size: 0.65rem; color: var(--text-tertiary);">${employeePercentage}%</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        async function updateAgentsStatistics() {
            const agentStats = {};
            
            const excludedAgents = ['ZAID@IQCELL_17'];
            
            try {
                const cachedSentMessages = getCachedData('sentMessages');
                let sentMessages = [];
                
                if (cachedSentMessages && Array.isArray(cachedSentMessages) && cachedSentMessages.length > 0) {
                    sentMessages = cachedSentMessages.filter(msg => msg.type === 'customer');
                } else {
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('sent_messages', 'GET', null, '?type=eq.customer&order=sent_at.desc', {
                        'Range': `${from}-${to}`
                        }, {}, true);
                    if (Array.isArray(batch) && batch.length > 0) {
                        sentMessages = sentMessages.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                        }
                    }
                }
                
                if (sentMessages && Array.isArray(sentMessages)) {
                    sentMessages.forEach(msg => {
                        const agentId = msg.agent_id;
                        const agentName = msg.agent_name || 'غير معروف';
                        
                        if (agentId && !excludedAgents.includes(agentName)) {
                            if (!agentStats[agentId]) {
                                agentStats[agentId] = {
                                    name: agentName,
                                    count: 0,
                                    lastSent: null,
                                    lastEmployee: null,
                                    lastSentDate: null
                                };
                            }
                            agentStats[agentId].count++;
                            const msgDate = new Date(msg.sent_at);
                            if (!agentStats[agentId].lastSentDate || msgDate > new Date(agentStats[agentId].lastSentDate)) {
                                agentStats[agentId].lastSent = msg.sent_at;
                                agentStats[agentId].lastSentDate = msg.sent_at;
                                agentStats[agentId].lastEmployee = msg.employee_name || 'غير محدد';
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading sent messages:', error);
            }
            
            if (customersData && customersData.length > 0) {
                customersData.forEach(customer => {
                    const customerAgent = customer.agent;
                    if (customerAgent && !excludedAgents.includes(customerAgent)) {
                        const agent = agents.find(a => a.id === customerAgent || a.name === customerAgent);
                        if (agent && !excludedAgents.includes(agent.name)) {
                            if (!agentStats[agent.id]) {
                                agentStats[agent.id] = {
                                    name: agent.name,
                                    count: 0,
                                    lastSent: null,
                                    lastEmployee: null,
                                    lastSentDate: null
                                };
                            }
                            agentStats[agent.id].count++;
                            const customerDate = customer.date || customer.created_at;
                            if (customerDate) {
                                const dateObj = new Date(customerDate);
                                if (!agentStats[agent.id].lastSentDate || dateObj > new Date(agentStats[agent.id].lastSentDate)) {
                                    agentStats[agent.id].lastSent = customerDate;
                                    agentStats[agent.id].lastSentDate = customerDate;
                                    agentStats[agent.id].lastEmployee = customer.employee || 'غير محدد';
                                }
                            }
                        }
                    }
                });
            }
            
            const tbody = document.getElementById('agentsStatsTableBody');
            if (Object.keys(agentStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: var(--text-secondary);">لا توجد بيانات</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(agentStats)
                .filter(([id, stats]) => !excludedAgents.includes(stats.name))
                .sort((a, b) => b[1].count - a[1].count)
                .map(([id, stats]) => {
                    let lastSentDate = 'لا يوجد';
                    if (stats.lastSent) {
                        try {
                            const date = new Date(stats.lastSent);
                            if (!isNaN(date.getTime())) {
                                const now = new Date();
                                const diffMs = now - date;
                                const diffMins = Math.floor(diffMs / 60000);
                                const diffHours = Math.floor(diffMs / 3600000);
                                const diffDays = Math.floor(diffMs / 86400000);
                                
                                if (diffMins < 1) {
                                    lastSentDate = 'الآن';
                                } else if (diffMins < 60) {
                                    lastSentDate = `منذ ${diffMins} دقيقة`;
                                } else if (diffHours < 24) {
                                    lastSentDate = `منذ ${diffHours} ساعة`;
                                } else if (diffDays < 7) {
                                    lastSentDate = `منذ ${diffDays} يوم`;
                                } else {
                                    lastSentDate = date.toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                }
                            } else {
                                lastSentDate = stats.lastSent;
                            }
                        } catch (e) {
                            lastSentDate = stats.lastSent;
                        }
                    }
                    const agentName = stats.name || 'غير معروف';
                    const lastEmployee = stats.lastEmployee || 'غير محدد';
                    return `
                        <tr>
                            <td><span style="font-weight: 600; color: var(--text-primary);">${agentName}</span></td>
                            <td><strong style="color: var(--primary-color);">${stats.count}</strong></td>
                            <td>${lastSentDate}</td>
                            <td><span style="color: var(--text-primary); font-weight: 600;">${escapeHtml(lastEmployee)}</span></td>
                        </tr>
                    `;
                }).join('');
        }

        function updateRecentActivity() {
            const activities = [];
            
            if (customersData && customersData.length > 0) {
                customersData.slice(-15).reverse().forEach(customer => {
                    const customerName = customer[0] || customer.username || 'غير معروف';
                    const customerPhone = customer.phone || customer[3] || '';
                    const customerRegion = customer.region || customer[1] || '';
                    const customerPoint = customer.closest_point || customer[2] || '';
                    const customerEmployee = customer.employee || customer[6] || 'غير معروف';
                    const customerAgent = customer.agent || '';
                    const customerDate = customer.created_at || customer[4] || customer.date || new Date();
                    activities.push({
                        type: 'customer',
                        icon: '👤',
                        title: 'مشترك جديد',
                        name: customerName,
                        phone: customerPhone,
                        region: customerRegion,
                        point: customerPoint,
                        employee: customerEmployee,
                        agent: customerAgent,
                        time: customerDate,
                        fullTime: new Date(customerDate).toLocaleString('en-US'),
                        color: '#4ade80'
                    });
                });
            }
            
            Promise.all([
                fetchSentMessagesForActivity(),
                fetchRecentCallsForActivity()
            ]).then(([sentMessages, recentCalls]) => {
                if (recentCalls && recentCalls.length > 0) {
                    recentCalls.slice(-8).reverse().forEach(call => {
                        const callType = call.call_type || 'غير محدد';
                        const callName = call.name || 'غير معروف';
                        const callPhone = call.phone || '';
                        const callDetails = call.details || '';
                        const callEmployee = call.agent || 'غير معروف';
                        const callDepartment = getDepartmentName(call.department) || '';
                        const callDate = call.created_at || new Date();
                        activities.push({
                            type: 'call',
                            icon: '📞',
                            title: `مكالمة ${callType}`,
                            name: callName,
                            phone: callPhone,
                            details: callDetails,
                            employee: callEmployee,
                            department: callDepartment,
                            time: callDate,
                            fullTime: new Date(callDate).toLocaleString('en-US'),
                            color: callType === 'شكوى' || callType === 'ضعف بالخدمة' ? '#f87171' : '#60a5fa'
                        });
                    });
                }
                
                if (sentMessages && sentMessages.length > 0) {
                    sentMessages.slice(-8).reverse().forEach(msg => {
                        activities.push({
                            type: 'message',
                            icon: '📨',
                            title: `إرسال ${msg.type === 'customer' ? 'مشترك' : 'شكوى'}`,
                            agentName: msg.agent_name || 'غير معروف',
                            customerName: msg.customer_name || '',
                            employee: msg.employee_name || 'غير محدد',
                            time: msg.sent_at,
                            fullTime: new Date(msg.sent_at).toLocaleString('en-US'),
                            color: '#fbbf24'
                        });
                    });
                }
                displayRecentActivity(activities);
            }).catch(() => {
                displayRecentActivity(activities);
            });
            
            return;
        }
        
        async function fetchRecentCallsForActivity() {
            try {
                // استخدام البيانات المحلية إذا كانت متوفرة بدلاً من طلب قاعدة البيانات
                if (callsData && Array.isArray(callsData) && callsData.length > 0) {
                    return callsData.slice(0, 8);
                }
                const data = await supabaseRequest('calls', 'GET', null, '?order=created_at.desc&limit=8', {}, true);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error fetching recent calls for activity:', error);
                return [];
            }
        }
        
        async function fetchSentMessagesForActivity() {
            try {
                // استخدام الكاش إذا كان متوفراً
                const cached = getCachedData('sentMessages');
                if (cached && Array.isArray(cached) && cached.length > 0) {
                    return cached.slice(0, 5);
                }
                const data = await supabaseRequest('sent_messages', 'GET', null, '?order=sent_at.desc&limit=5', {}, true);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error fetching sent messages for activity:', error);
                return [];
            }
        }
        
        function displayRecentActivity(activities) {
            
            activities.sort((a, b) => {
                const timeA = new Date(a.time);
                const timeB = new Date(b.time);
                if (isNaN(timeA.getTime()) && isNaN(timeB.getTime())) return 0;
                if (isNaN(timeA.getTime())) return 1;
                if (isNaN(timeB.getTime())) return -1;
                return timeB - timeA;
            });
            const recentActivities = activities.slice(0, 15);
            
            const container = document.getElementById('recentActivity');
            if (recentActivities.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-primary);"><div style="font-size: 3rem; margin-bottom: 10px;">📋</div><p>لا توجد نشاطات حديثة</p></div>';
                return;
            }
            
            container.innerHTML = recentActivities.map((activity, index) => {
                const timeAgoText = timeAgo(activity.time);
                const fullTime = activity.fullTime || new Date(activity.time).toLocaleString('en-US');
                const activityDate = new Date(activity.time);
                const dateText = activityDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeText = activityDate.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const activityColor = activity.color || 'var(--primary-color)';
                
                let detailsHTML = '';
                
                if (activity.type === 'call') {
                    detailsHTML = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-light);">
                            ${activity.phone ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>📱</span><span>${activity.phone}</span></div>` : ''}
                            ${activity.details ? `<div style="font-size: 0.75rem; color: var(--text-primary); margin-top: 4px; line-height: 1.4;">${activity.details.length > 60 ? activity.details.substring(0, 60) + '...' : activity.details}</div>` : ''}
                            ${activity.department ? `<div style="display: inline-block; margin-top: 4px; padding: 2px 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.7rem; color: var(--text-primary);">🏢 ${activity.department}</div>` : ''}
                        </div>
                    `;
                } else if (activity.type === 'customer') {
                    detailsHTML = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-light);">
                            ${activity.phone ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>📱</span><span>${activity.phone}</span></div>` : ''}
                            ${activity.region ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>📍</span><span>${activity.region}</span></div>` : ''}
                            ${activity.point ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>🎯</span><span>${activity.point}</span></div>` : ''}
                            ${activity.agent ? `<div style="display: inline-block; margin-top: 4px; padding: 2px 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.7rem; color: var(--text-primary);">👔 ${activity.agent}</div>` : ''}
                    </div>
                    `;
                } else if (activity.type === 'message') {
                    detailsHTML = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-light);">
                            ${activity.customerName ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>👤</span><span>${activity.customerName}</span></div>` : ''}
                            ${activity.agentName ? `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-primary);"><span>📤</span><span>إلى: ${activity.agentName}</span></div>` : ''}
                </div>
                    `;
                }
                
                return `
                    <div style="background: var(--card-bg); border: 1.5px solid var(--border-color); border-radius: 10px; padding: 14px; margin-bottom: 12px; transition: all 0.3s ease; box-shadow: 0 2px 4px var(--shadow-sm);" 
                         onmouseover="this.style.transform='translateX(-4px)'; this.style.boxShadow='0 4px 12px var(--shadow-md)'; this.style.borderColor='${activityColor}'" 
                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px var(--shadow-sm)'; this.style.borderColor='var(--border-color)'">
                        <div style="display: flex; align-items: flex-start; gap: 14px;">
                            <div style="width: 45px; height: 45px; background: ${activityColor}15; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; border: 2px solid ${activityColor}30;">
                                ${activity.icon || '📋'}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="color: ${activityColor}; font-weight: 700; font-size: 0.85rem; padding: 3px 10px; background: ${activityColor}15; border-radius: 6px; border: 1px solid ${activityColor}30;">${activity.title || 'نشاط'}</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                        <span style="font-size: 0.7rem; color: var(--text-primary); font-weight: 500;" title="${fullTime}">${timeAgoText}</span>
                                        <span style="font-size: 0.65rem; color: var(--text-primary);">📅 ${dateText}</span>
                                        <span style="font-size: 0.65rem; color: var(--text-primary);">🕐 ${timeText}</span>
                                    </div>
                                </div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 0.9rem; margin-bottom: 6px;">
                                    ${activity.type === 'message' ? (activity.customerName || '') : (activity.name || activity.agentName || '')}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 6px;">
                                    <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-primary); background: var(--bg-tertiary); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                        <span style="color: var(--primary-color); font-weight: 600;">👤 الموظف:</span>
                                        <span style="font-weight: 600; color: var(--text-primary); cursor: pointer; text-decoration: underline;" onclick="viewEmployeeProfile('${escapeHtml(activity.employee || '')}')" title="عرض الملف الشخصي">${activity.employee || 'غير معروف'}</span>
                                    </div>
                                    ${activity.department ? `<div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-primary);"><span>🏢</span><span>${activity.department}</span></div>` : ''}
                                </div>
                                ${detailsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('txtSearch')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCustomers();
        });
        
        
        async function exportCallsToExcel() {
            try {
                showAlert(document.getElementById('callAlert'), 'جاري تحميل البيانات...', 'info');
                
                let allCalls = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, '?order=created_at.desc', {
                        'Range': `${from}-${to}`
                    }, false);
                    
                    if (Array.isArray(batch) && batch.length > 0) {
                        allCalls = allCalls.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                if (allCalls.length === 0) {
                    showAlert(document.getElementById('callAlert'), 'لا توجد مكالمات للتصدير', 'info');
                    return;
                }
                
                const headers = ['نوع المكالمة', 'اسم المتصل', 'رقم الهاتف', 'التفاصيل', 'الموظف', 'القسم', 'وقت الشفت', 'تاريخ الإنشاء'];
                const rows = allCalls.map(call => [
                    call.call_type || '',
                    call.name || '',
                    call.phone || '',
                    call.details || '',
                    call.agent || '',
                    getDepartmentName(call.department) || '',
                    call.shift_time || '',
                    call.created_at ? new Date(call.created_at).toLocaleString('en-US') : ''
                ]);
                
                exportToExcel(headers, rows, 'المكالمات');
                showAlert(document.getElementById('callAlert'), `تم تصدير ${allCalls.length} مكالمة بنجاح`, 'success');
            } catch (error) {
                console.error('Error exporting calls:', error);
                showAlert(document.getElementById('callAlert'), 'حدث خطأ أثناء التصدير', 'error');
            }
        }
        
        async function exportCustomersToExcel() {
            try {
                showAlert(document.getElementById('customerAlert'), 'جاري تحميل البيانات...', 'info');
                
                let allCustomers = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, '?order=created_at.desc', {
                        'Range': `${from}-${to}`
                    }, false);
                    
                    if (Array.isArray(batch) && batch.length > 0) {
                        allCustomers = allCustomers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                if (allCustomers.length === 0) {
                    showAlert(document.getElementById('customerAlert'), 'لا يوجد مشتركين للتصدير', 'info');
                    return;
                }
                
                const headers = ['الاسم', 'المنطقة', 'أقرب نقطة دالة', 'رقم الهاتف', 'التاريخ', 'الملاحظات', 'الموظف', 'الوكيل', 'تاريخ الإنشاء'];
                const rows = allCustomers.map(customer => [
                    customer.username || '',
                    customer.region || '',
                    customer.closest_point || '',
                    customer.phone || '',
                    customer.date || '',
                    customer.notes || '',
                    customer.employee || '',
                    customer.agent || '',
                    customer.created_at ? new Date(customer.created_at).toLocaleString('en-US') : ''
                ]);
                
                exportToExcel(headers, rows, 'المشتركين');
                showAlert(document.getElementById('customerAlert'), `تم تصدير ${allCustomers.length} مشترك بنجاح`, 'success');
            } catch (error) {
                console.error('Error exporting customers:', error);
                showAlert(document.getElementById('customerAlert'), 'حدث خطأ أثناء التصدير', 'error');
            }
        }
        
        function exportSearchResultsToExcel() {
            if (!window.searchResultsData || window.searchResultsData.length === 0) {
                showAlert(document.getElementById('searchAlert'), 'لا توجد نتائج للتصدير', 'info');
                return;
            }
            
            const headers = ['الاسم', 'المنطقة', 'أقرب نقطة دالة', 'رقم الهاتف', 'التاريخ', 'الملاحظات', 'الموظف', 'الوكيل'];
            const rows = window.searchResultsData.map(customer => [
                customer.username || '',
                customer.region || '',
                customer.closest_point || '',
                customer.phone || '',
                customer.date || '',
                customer.notes || '',
                customer.employee || '',
                customer.agent || ''
            ]);
            
            exportToExcel(headers, rows, 'نتائج_البحث');
            showAlert(document.getElementById('searchAlert'), `تم تصدير ${window.searchResultsData.length} نتيجة بنجاح`, 'success');
        }
        
        function initializeReportForm() {
            const startDate = document.getElementById('reportStartDate');
            const endDate = document.getElementById('reportEndDate');
            
            if (!startDate || !endDate) return;
            
            
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            startDate.value = lastWeek.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
            
            const includeAll = document.getElementById('reportIncludeAll');
            if (includeAll) {
                includeAll.checked = false;
                toggleReportDateRange();
            }
        }
        
        function resetReportForm() {
            initializeReportForm();
            document.getElementById('reportIncludeSummary').checked = true;
            document.getElementById('reportIncludeCalls').checked = true;
            document.getElementById('reportIncludeCustomers').checked = true;
            document.getElementById('reportIncludeCharts').checked = true;
            const alertDiv = document.getElementById('reportsAlert');
            if (alertDiv) {
                alertDiv.innerHTML = '';
            }
        }
        
        function toggleReportDateRange() {
            const includeAll = document.getElementById('reportIncludeAll').checked;
            const startDate = document.getElementById('reportStartDate');
            const endDate = document.getElementById('reportEndDate');
            
            startDate.disabled = includeAll;
            endDate.disabled = includeAll;
            
            if (includeAll) {
                startDate.style.opacity = '0.5';
                endDate.style.opacity = '0.5';
            } else {
                startDate.style.opacity = '1';
                endDate.style.opacity = '1';
            }
        }
        
        async function generateReport() {
            const alertDiv = document.getElementById('reportsAlert') || document.getElementById('reportAlert');
            const includeAll = document.getElementById('reportIncludeAll').checked;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!includeAll && (!startDate || !endDate)) {
                showAlert(alertDiv, 'يرجى تحديد فترة التقرير', 'error');
                return;
            }
            
            if (!includeAll && new Date(startDate) > new Date(endDate)) {
                showAlert(alertDiv, 'تاريخ البداية يجب أن يكون قبل تاريخ النهاية', 'error');
                return;
            }
            
            const includeSummary = document.getElementById('reportIncludeSummary').checked;
            const includeCalls = document.getElementById('reportIncludeCalls').checked;
            const includeCustomers = document.getElementById('reportIncludeCustomers').checked;
            const includeCharts = document.getElementById('reportIncludeCharts').checked;
            
            if (!includeSummary && !includeCalls && !includeCustomers && !includeCharts) {
                showAlert(alertDiv, 'يرجى اختيار محتوى واحد على الأقل للتقرير', 'error');
                return;
            }
            
            showAlert(alertDiv, 'جاري إنشاء التقرير...', 'info');
            
            try {
                let calls = [];
                let customers = [];
                
                if (includeAll) {
                    
                    calls = await fetchAllCalls();
                    customers = await fetchAllCustomers();
                } else {
                    
                    const start = new Date(startDate);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    calls = await fetchCallsByDateRange(start, end);
                    customers = await fetchCustomersByDateRange(start, end);
                }
                
                const now = new Date();
                const reportDate = now.toLocaleDateString('en-US');
                const reportTime = now.toLocaleTimeString('en-US');
                
                const headers = ['المحتوى', 'التفاصيل', 'القيمة'];
                const rows = [];
                
                
                rows.push(['═══════════════════════════════════════════════════════', '', '']);
                rows.push(['📊 تقرير الإحصائيات الشامل', '', '']);
                rows.push(['═══════════════════════════════════════════════════════', '', '']);
                rows.push(['', '', '']);
                rows.push(['📅 تاريخ إنشاء التقرير', `${reportDate} ${reportTime}`, '']);
                
                if (!includeAll) {
                    rows.push(['📆 الفترة المحددة', `من ${new Date(startDate).toLocaleDateString('en-US')} إلى ${new Date(endDate).toLocaleDateString('en-US')}`, '']);
                } else {
                    rows.push(['📆 الفترة المحددة', 'جميع البيانات', '']);
                }
                
                rows.push(['', '', '']);
                
                
                if (includeSummary) {
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['📈 ملخص الإحصائيات', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['', '', '']);
                    
                    const totalCalls = calls.length;
                    const totalComplaints = calls.filter(c => 
                        c.call_type === 'شكوى' || c.call_type === 'ضعف بالخدمة'
                    ).length;
                    const totalCustomers = customers.length;
                    
                    rows.push(['📞 إجمالي المكالمات', totalCalls, '']);
                    rows.push(['⚠️ إجمالي الشكاوى', totalComplaints, '']);
                    rows.push(['👥 إجمالي المشتركين الجدد', totalCustomers, '']);
                    rows.push(['', '', '']);
                }
                
                
                if (includeCharts) {
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['📊 توزيع أنواع المكالمات', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['', '', '']);
                
                const callStats = {};
                calls.forEach(call => {
                    const type = call.call_type || 'غير محدد';
                    callStats[type] = (callStats[type] || 0) + 1;
                });
                    
                    Object.entries(callStats)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([type, count]) => {
                            const percentage = ((count / calls.length) * 100).toFixed(1);
                            rows.push(['', `${type}`, `${count} (${percentage}%)`]);
                        });
                    
                    rows.push(['', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['👤 المكالمات حسب الموظف', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['', '', '']);
                
                const employeeStats = {};
                calls.forEach(call => {
                    const emp = call.agent || 'غير محدد';
                    employeeStats[emp] = (employeeStats[emp] || 0) + 1;
                });
                    
                    Object.entries(employeeStats)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([emp, count]) => {
                            rows.push(['', emp, count]);
                        });
                    
                    rows.push(['', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['🏢 المشتركين حسب الوكيل', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['', '', '']);
                
                const agentStats = {};
                customers.forEach(customer => {
                    const agent = customer.agent || 'غير محدد';
                    agentStats[agent] = (agentStats[agent] || 0) + 1;
                });
                
                    Object.entries(agentStats)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([agent, count]) => {
                            rows.push(['', agent, count]);
                });
                
                rows.push(['', '', '']);
                }
                
                
                if (includeCalls && calls.length > 0) {
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['📞 تفاصيل المكالمات', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                rows.push(['', '', '']);
                    rows.push(['نوع المكالمة', 'اسم المتصل', 'رقم الهاتف', 'التفاصيل', 'الموظف', 'القسم', 'التاريخ']);
                
                calls.forEach(call => {
                    rows.push([
                        call.call_type || '',
                        call.name || '',
                        call.phone || '',
                        call.details || '',
                        call.agent || '',
                            getDepartmentName(call.department) || '',
                        call.created_at ? new Date(call.created_at).toLocaleString('en-US') : ''
                    ]);
                });
                
                    rows.push(['', '', '']);
                }
                
                
                if (includeCustomers && customers.length > 0) {
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['👥 تفاصيل المشتركين الجدد', '', '']);
                    rows.push(['═══════════════════════════════════════════════════════', '', '']);
                    rows.push(['', '', '']);
                    rows.push(['الاسم', 'المنطقة', 'أقرب نقطة دالة', 'رقم الهاتف', 'التاريخ', 'الملاحظات', 'الموظف', 'الوكيل']);
                    
                    customers.forEach(customer => {
                        rows.push([
                            customer.username || '',
                            customer.region || '',
                            customer.closest_point || '',
                            customer.phone || '',
                            customer.date || (customer.created_at ? new Date(customer.created_at).toLocaleDateString('en-US') : ''),
                            customer.notes || '',
                            customer.employee || '',
                            customer.agent || ''
                        ]);
                    });
                }
                
                
                rows.push(['', '', '']);
                rows.push(['═══════════════════════════════════════════════════════', '', '']);
                rows.push(['تم إنشاء التقرير بواسطة', loggedInUser || 'النظام', '']);
                rows.push(['═══════════════════════════════════════════════════════', '', '']);
                
                const fileName = includeAll 
                    ? `تقرير_شامل_${reportDate.replace(/\//g, '_')}`
                    : `تقرير_${startDate.replace(/-/g, '_')}_${endDate.replace(/-/g, '_')}`;
                
                exportToExcel(headers, rows, fileName);
                showToast('تم تصدير التقرير بنجاح', 'success', 'نجح');
                if (alertDiv) {
                    showAlert(alertDiv, 'تم تصدير التقرير بنجاح', 'success');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showAlert(alertDiv, `حدث خطأ أثناء إنشاء التقرير: ${error.message}`, 'error');
            }
        }
        
        async function fetchAllCalls() {
            let allCalls = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;
            
            while (hasMore) {
                const to = from + batchSize - 1;
                const batch = await supabaseRequest('calls', 'GET', null, '?order=created_at.desc', {
                    'Range': `${from}-${to}`
                });
                if (Array.isArray(batch) && batch.length > 0) {
                    allCalls = allCalls.concat(batch);
                    if (batch.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                } else {
                    hasMore = false;
                }
            }
            return allCalls;
        }
        
        async function fetchAllCustomers() {
            let allCustomers = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;
            
            while (hasMore) {
                const to = from + batchSize - 1;
                const batch = await supabaseRequest('customers', 'GET', null, '?order=created_at.desc', {
                    'Range': `${from}-${to}`
                });
                if (Array.isArray(batch) && batch.length > 0) {
                    allCustomers = allCustomers.concat(batch);
                    if (batch.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                } else {
                    hasMore = false;
                }
            }
            return allCustomers;
        }
        
        async function fetchCallsByDateRange(startDate, endDate) {
            let allCalls = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;
            
            const filter = `?created_at=gte.${startDate.toISOString()}&created_at=lte.${endDate.toISOString()}&order=created_at.desc`;
            
            while (hasMore) {
                const to = from + batchSize - 1;
                const batch = await supabaseRequest('calls', 'GET', null, filter, {
                    'Range': `${from}-${to}`
                });
                if (Array.isArray(batch) && batch.length > 0) {
                    allCalls = allCalls.concat(batch);
                    if (batch.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                } else {
                    hasMore = false;
                }
            }
            return allCalls;
        }
        
        async function fetchCustomersByDateRange(startDate, endDate) {
            let allCustomers = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;
            
            const filter = `?created_at=gte.${startDate.toISOString()}&created_at=lte.${endDate.toISOString()}&order=created_at.desc`;
            
            while (hasMore) {
                const to = from + batchSize - 1;
                const batch = await supabaseRequest('customers', 'GET', null, filter, {
                    'Range': `${from}-${to}`
                });
                if (Array.isArray(batch) && batch.length > 0) {
                    allCustomers = allCustomers.concat(batch);
                    if (batch.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                } else {
                    hasMore = false;
                }
            }
            return allCustomers;
        }
        
        
        
        async function exportWeeklyReport() {
            try {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                const startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 7);
                
                const callsFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                const customersFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                
                let calls = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, callsFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        calls = calls.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                let customers = [];
                from = 0;
                hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('customers', 'GET', null, customersFilter, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        customers = customers.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                const reportDate = now.toLocaleDateString('en-US');
                const reportTime = now.toLocaleTimeString('en-US');
                const weekStart = startDate.toLocaleDateString('en-US');
                const weekEnd = new Date(endDate.getTime() - 1).toLocaleDateString('en-US');
                
                const headers = ['نوع البيانات', 'التفاصيل', 'العدد'];
                const rows = [
                    ['تقرير أسبوعي - المكالمات والمشتركين الجدد', '', ''],
                    [`الفترة: من ${weekStart} إلى ${weekEnd}`, '', ''],
                    [`تاريخ التقرير: ${reportDate} ${reportTime}`, '', ''],
                    ['', '', ''],
                    ['إجمالي المكالمات لهذا الأسبوع', '', calls.length],
                    ['إجمالي الشكاوى', '', calls.filter(c => c.call_type === 'شكوى' || c.call_type === 'ضعف بالخدمة').length],
                    ['إجمالي المشتركين الجدد', '', customers.length],
                    ['', '', ''],
                    ['توزيع أنواع المكالمات', '', ''],
                ];
                
                const callStats = {};
                calls.forEach(call => {
                    const type = call.call_type || 'غير محدد';
                    callStats[type] = (callStats[type] || 0) + 1;
                });
                Object.entries(callStats).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                    rows.push(['', type, count]);
                });
                
                rows.push(['', '', '']);
                rows.push(['المكالمات حسب الموظف', '', '']);
                const employeeStats = {};
                calls.forEach(call => {
                    const emp = call.agent || 'غير محدد';
                    employeeStats[emp] = (employeeStats[emp] || 0) + 1;
                });
                Object.entries(employeeStats).sort((a, b) => b[1] - a[1]).forEach(([emp, count]) => {
                    rows.push(['', emp, count]);
                });
                
                rows.push(['', '', '']);
                rows.push(['المشتركين الجدد حسب الوكيل', '', '']);
                const agentStats = {};
                customers.forEach(customer => {
                    const agent = customer.agent || 'غير محدد';
                    agentStats[agent] = (agentStats[agent] || 0) + 1;
                });
                Object.entries(agentStats).sort((a, b) => b[1] - a[1]).forEach(([agent, count]) => {
                    rows.push(['', agent, count]);
                });
                
                rows.push(['', '', '']);
                rows.push(['تفاصيل المكالمات لهذا الأسبوع', '', '']);
                rows.push(['نوع المكالمة', 'اسم المتصل', 'رقم الهاتف', 'التفاصيل', 'الموظف', 'التاريخ']);
                calls.forEach(call => {
                    rows.push([
                        call.call_type || '',
                        call.name || '',
                        call.phone || '',
                        call.details || '',
                        call.agent || '',
                        call.created_at ? new Date(call.created_at).toLocaleString('en-US') : ''
                    ]);
                });
                
                rows.push(['', '', '']);
                rows.push(['تفاصيل المشتركين الجدد لهذا الأسبوع', '', '']);
                rows.push(['الاسم', 'المنطقة', 'أقرب نقطة دالة', 'رقم الهاتف', 'التاريخ', 'الموظف', 'الوكيل']);
                customers.forEach(customer => {
                    rows.push([
                        customer.username || '',
                        customer.region || '',
                        customer.closest_point || '',
                        customer.phone || '',
                        customer.date || customer.created_at ? new Date(customer.date || customer.created_at).toLocaleDateString('en-US') : '',
                        customer.employee || '',
                        customer.agent || ''
                    ]);
                });
                
                const filename = `تقرير_أسبوعي_${weekStart.replace(/\//g, '_')}_${weekEnd.replace(/\//g, '_')}`;
                exportToExcel(headers, rows, filename);
                showAlert(document.getElementById('dashboard').querySelector('.card'), `تم تصدير التقرير الأسبوعي بنجاح (${calls.length} مكالمة، ${customers.length} مشترك جديد)`, 'success');
            } catch (error) {
                console.error('Error exporting weekly report:', error);
                alert('حدث خطأ أثناء تصدير التقرير الأسبوعي');
            }
        }
        
        async function exportAdvancedStatsToExcel() {
            try {
                const period = document.getElementById('statsPeriod').value;
                let startDate, endDate;
                const now = new Date();
                
                if (period === 'daily') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                } else if (period === 'weekly') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 7);
                } else {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                }
                
                const callsFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                const customersFilter = `?created_at=gte.${startDate.toISOString()}&created_at=lt.${endDate.toISOString()}&order=created_at.desc`;
                
                let allCalls = [];
                let allCustomers = [];
                
                let from = 0;
                const batchSize = 1000;
                let hasMoreCalls = true;
                let hasMoreCustomers = true;
                
                while (hasMoreCalls || hasMoreCustomers) {
                    const to = from + batchSize - 1;
                    
                    const promises = [];
                    if (hasMoreCalls) {
                        promises.push(supabaseRequest('calls', 'GET', null, callsFilter, {
                            'Range': `${from}-${to}`
                        }, false));
                    } else {
                        promises.push(Promise.resolve([]));
                    }
                    
                    if (hasMoreCustomers) {
                        promises.push(supabaseRequest('customers', 'GET', null, customersFilter, {
                            'Range': `${from}-${to}`
                        }, false));
                    } else {
                        promises.push(Promise.resolve([]));
                    }
                    
                    const [callsBatch, customersBatch] = await Promise.all(promises);
                    
                    if (Array.isArray(callsBatch) && callsBatch.length > 0) {
                        allCalls = allCalls.concat(callsBatch);
                        if (callsBatch.length < batchSize) {
                            hasMoreCalls = false;
                        }
                    } else {
                        hasMoreCalls = false;
                    }
                    
                    if (Array.isArray(customersBatch) && customersBatch.length > 0) {
                        allCustomers = allCustomers.concat(customersBatch);
                        if (customersBatch.length < batchSize) {
                            hasMoreCustomers = false;
                        }
                    } else {
                        hasMoreCustomers = false;
                    }
                    
                    if (!hasMoreCalls && !hasMoreCustomers) {
                        break;
                    }
                    
                    from += batchSize;
                }
                
                const calls = allCalls;
                const customers = allCustomers;
                
                const periodName = period === 'daily' ? 'يومية' : period === 'weekly' ? 'أسبوعية' : 'شهرية';
                const headers = ['نوع البيانات', 'التفاصيل', 'العدد'];
                const rows = [
                    [`تقرير إحصائيات ${periodName}`, `من ${startDate.toLocaleDateString('en-US')} إلى ${endDate.toLocaleDateString('en-US')}`, ''],
                    ['', '', ''],
                    ['إجمالي المكالمات', '', calls.length],
                    ['إجمالي الشكاوى', '', calls.filter(c => c.call_type === 'شكوى' || c.call_type === 'ضعف بالخدمة').length],
                    ['إجمالي المشتركين', '', customers.length],
                ];
                
                const callStats = {};
                calls.forEach(call => {
                    const type = call.call_type || 'غير محدد';
                    callStats[type] = (callStats[type] || 0) + 1;
                });
                rows.push(['', '', '']);
                rows.push(['توزيع أنواع المكالمات', '', '']);
                Object.entries(callStats).forEach(([type, count]) => {
                    rows.push(['', type, count]);
                });
                
                const employeeStats = {};
                calls.forEach(call => {
                    const emp = call.agent || 'غير محدد';
                    employeeStats[emp] = (employeeStats[emp] || 0) + 1;
                });
                rows.push(['', '', '']);
                rows.push(['المكالمات حسب الموظف', '', '']);
                Object.entries(employeeStats).forEach(([emp, count]) => {
                    rows.push(['', emp, count]);
                });
                
                const agentStats = {};
                customers.forEach(customer => {
                    const agent = customer.agent || 'غير محدد';
                    agentStats[agent] = (agentStats[agent] || 0) + 1;
                });
                rows.push(['', '', '']);
                rows.push(['المشتركين حسب الوكيل', '', '']);
                Object.entries(agentStats).forEach(([agent, count]) => {
                    rows.push(['', agent, count]);
                });
                
                exportToExcel(headers, rows, `إحصائيات_${periodName}_${new Date().toISOString().split('T')[0]}`);
                alert(`تم تصدير التقرير ${periodName} بنجاح`);
            } catch (error) {
                console.error('Error exporting advanced stats:', error);
                alert('حدث خطأ أثناء تصدير التقرير');
            }
        }
        
        function exportToExcel(headers, rows, filename) {
            let csvContent = '\uFEFF';
            csvContent += headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function resendCustomerToAgent(customerJson) {
            try {
                const customer = typeof customerJson === 'string' ? JSON.parse(customerJson) : customerJson;
                if (!customer.agent) {
                    showAlert(document.getElementById('searchAlert'), 'هذا المشترك ليس له وكيل محدد', 'error');
                    return;
                }
                
                const agent = agents.find(a => a.id === customer.agent || a.name === customer.agent);
                if (!agent) {
                    showAlert(document.getElementById('searchAlert'), 'الوكيل المحدد غير موجود', 'error');
                    return;
                }
                
                const customerData = {
                    username: customer.username,
                    region: customer.region,
                    closestPoint: customer.closest_point,
                    phone: customer.phone,
                    date: customer.date
                };
                
                sendCustomerToWhatsApp(agent, customerData);
                saveSentMessageToSupabase('customer', agent.id, agent.name, customerData.username);
                showAlert(document.getElementById('searchAlert'), `تم إعادة إرسال بيانات المشترك ${customer.username} للوكيل ${agent.name}`, 'success');
            } catch (error) {
                console.error('Error in resendCustomerToAgent:', error);
                showAlert(document.getElementById('searchAlert'), 'حدث خطأ أثناء إعادة الإرسال', 'error');
            }
        }
        
        let allCallsData = [];
        let allCustomersData = [];
        
        async function loadAllCalls() {
            const tbody = document.getElementById('callsListBody');
            const alertDiv = document.getElementById('callAlert');
            
            showAlert(alertDiv, 'جاري تحميل المكالمات...', 'info');
            
            try {
                allCallsData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('calls', 'GET', null, `?order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allCallsData = allCallsData.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                if (allCallsData && allCallsData.length > 0) {
                    displayCallsTable(allCallsData);
                    showAlert(alertDiv, `تم تحميل ${allCallsData.length} مكالمة`, 'success');
                } else {
                    const container = document.getElementById('callsListBody');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                            <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">📞</div>
                            <p style="font-size: 1.1rem;">لا توجد مكالمات</p>
                        </div>
                    `;
                    showAlert(alertDiv, 'لا توجد مكالمات', 'info');
                }
            } catch (error) {
                console.error('Error loading calls:', error);
                showAlert(alertDiv, 'حدث خطأ أثناء تحميل المكالمات', 'error');
            }
        }
        
        function displayCallsTable(calls) {
            const container = document.getElementById('callsListBody');
            if (!calls || calls.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">📞</div>
                        <p style="font-size: 1.1rem;">لا توجد مكالمات</p>
                    </div>
                `;
                window.currentCallsData = [];
                return;
            }
            
            const callTypeColors = {
                'شكوى': '#f87171',
                'ضعف بالخدمة': '#fb923c',
                'استفسار': '#60a5fa',
                'طلب': '#4ade80',
                'شكر': '#a78bfa'
            };
            
            const getCallTypeColor = (type) => {
                if (!type) return '#94a3b8';
                return callTypeColors[type] || '#60a5fa';
            };
            
            container.innerHTML = calls.map((call, index) => {
                const callType = call.call_type || 'غير محدد';
                const callColor = getCallTypeColor(callType);
                const callDate = call.created_at ? new Date(call.created_at) : null;
                const formattedDate = callDate ? callDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'غير محدد';
                const timeAgo = callDate ? getTimeAgo(callDate) : '';
                const details = call.details || 'لا توجد تفاصيل';
                const shortDetails = details.length > 100 ? details.substring(0, 100) + '...' : details;
                
                return `
                    <div class="call-card" style="
                        background: var(--bg-primary);
                        border: 2px solid var(--border-color);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 12px rgba(0, 0, 0, 0.15)';" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            width: 5px;
                            height: 100%;
                            background: ${callColor};
                        "></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="
                                    display: inline-block;
                                    padding: 6px 12px;
                                    background: ${callColor}20;
                                    color: ${callColor};
                                    border-radius: 8px;
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                    margin-bottom: 10px;
                                ">${escapeHtml(callType)}</div>
                                <h3 style="
                                    margin: 0 0 8px 0;
                                    color: var(--text-primary);
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                ">${escapeHtml(call.name || 'غير معروف')}</h3>
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: var(--text-secondary);
                                    font-size: 0.95rem;
                                    margin-bottom: 5px;
                                ">
                                    <span style="font-size: 1.1rem;">📱</span>
                                    <a href="tel:${escapeHtml(call.phone || '')}" style="
                                        color: var(--primary-color);
                                        text-decoration: none;
                                        font-weight: 600;
                                    ">${escapeHtml(call.phone || 'غير محدد')}</a>
                                </div>
                            </div>
                        </div>
                        
                        <div style="
                            background: var(--bg-secondary);
                            padding: 12px;
                            border-radius: 10px;
                            margin-bottom: 15px;
                            border-right: 3px solid ${callColor};
                        ">
                            <div style="
                                color: var(--text-secondary);
                                font-size: 0.85rem;
                                margin-bottom: 5px;
                                font-weight: 600;
                            ">التفاصيل:</div>
                            <div style="
                                color: var(--text-primary);
                                font-size: 0.95rem;
                                line-height: 1.6;
                                white-space: pre-wrap;
                            ">${escapeHtml(shortDetails)}</div>
                        </div>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 12px;
                            margin-bottom: 15px;
                            padding-top: 15px;
                            border-top: 1px solid var(--border-color);
                        ">
                            <div>
                                <div style="
                                    color: var(--text-secondary);
                                    font-size: 0.8rem;
                                    margin-bottom: 4px;
                                    font-weight: 600;
                                ">👤 الموظف</div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">${escapeHtml(call.agent || 'غير محدد')}</div>
                            </div>
                            ${call.department ? `
                            <div>
                                <div style="
                                    color: var(--text-secondary);
                                    font-size: 0.8rem;
                                    margin-bottom: 4px;
                                    font-weight: 600;
                                ">🏢 القسم</div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">${escapeHtml(getDepartmentName(call.department) || 'غير محدد')}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding-top: 15px;
                            border-top: 1px solid var(--border-color);
                            margin-bottom: 15px;
                        ">
                            <div>
                                <div style="
                                    color: var(--text-secondary);
                                    font-size: 0.8rem;
                                    margin-bottom: 4px;
                                    font-weight: 600;
                                ">📅 التاريخ</div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 0.85rem;
                                    font-weight: 600;
                                ">${formattedDate}</div>
                                ${timeAgo ? `
                                <div style="
                                    color: var(--text-secondary);
                                    font-size: 0.75rem;
                                    margin-top: 4px;
                                ">${timeAgo}</div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="
                            display: flex;
                            gap: 10px;
                            flex-wrap: wrap;
                        ">
                            <button class="btn btn-primary" style="
                                padding: 10px 20px;
                                font-size: 0.9rem;
                                border-radius: 8px;
                                flex: 1;
                                min-width: 120px;
                                font-weight: 600;
                                cursor: pointer;
                                border: none;
                                transition: all 0.2s;
                            " onclick="showCallDetailsByIndex(${index})" 
                               onmouseover="this.style.opacity='0.9'; this.style.transform='scale(1.02)';" 
                               onmouseout="this.style.opacity='1'; this.style.transform='scale(1)';">
                                📋 عرض التفاصيل
                            </button>
                            ${currentUserRole === 'admin' ? `
                            <button class="btn btn-warning" style="
                                padding: 10px 16px;
                                font-size: 0.9rem;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                border: none;
                                transition: all 0.2s;
                            " onclick="editCallByIndex(${index})"
                               onmouseover="this.style.opacity='0.9'; this.style.transform='scale(1.02)';" 
                               onmouseout="this.style.opacity='1'; this.style.transform='scale(1)';">
                                ✏️ تعديل
                            </button>
                            <button class="btn btn-danger" style="
                                padding: 10px 16px;
                                font-size: 0.9rem;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                border: none;
                                transition: all 0.2s;
                            " onclick="deleteCallByIndex(${index})"
                               onmouseover="this.style.opacity='0.9'; this.style.transform='scale(1.02)';" 
                               onmouseout="this.style.opacity='1'; this.style.transform='scale(1)';">
                                🗑️ حذف
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            window.currentCallsData = calls;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} ساعة`;
            if (diffDays < 7) return `منذ ${diffDays} يوم`;
            return '';
        }
        
        function showCallDetailsByIndex(index) {
            if (window.currentCallsData && window.currentCallsData[index]) {
                showCallDetails(window.currentCallsData[index]);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getDepartmentName(departmentValue) {
            if (!departmentValue) return null;
            
            if (isNaN(departmentValue)) {
                return departmentValue;
            }
            
            const departmentId = departmentValue.toString();
            const department = departments.find(d => d.id === departmentId || d.id.toString() === departmentId);
            return department ? department.name : departmentValue;
        }
        
        function showCallDetails(call) {
            try {
                // حفظ بيانات المكالمة للوصول إليها عند المشاركة
                window.currentCallDetails = call;
                const callType = call.call_type || 'غير محدد';
                const callTypeColors = {
                    'شكوى': '#f87171',
                    'ضعف بالخدمة': '#fb923c',
                    'استفسار': '#60a5fa',
                    'طلب': '#4ade80',
                    'شكر': '#a78bfa'
                };
                const callColor = callTypeColors[callType] || '#60a5fa';
                const callDate = call.created_at ? new Date(call.created_at) : null;
                const formattedDate = callDate ? callDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    weekday: 'long'
                }) : 'غير محدد';
                
                const content = document.getElementById('callDetailsContent');
                content.innerHTML = `
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div style="
                            background: linear-gradient(135deg, ${callColor}15 0%, ${callColor}05 100%);
                            border: 2px solid ${callColor}40;
                            border-radius: 20px;
                            padding: 30px;
                            margin-bottom: 25px;
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="
                                position: absolute;
                                top: -50px;
                                right: -50px;
                                width: 200px;
                                height: 200px;
                                background: ${callColor}10;
                                border-radius: 50%;
                            "></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="
                                    display: inline-block;
                                    padding: 10px 20px;
                                    background: ${callColor};
                                    color: white;
                                    border-radius: 12px;
                                    font-weight: 700;
                                    font-size: 1.1rem;
                                    margin-bottom: 20px;
                                    box-shadow: 0 4px 12px ${callColor}40;
                                ">${escapeHtml(callType)}</div>
                                <h2 style="
                                    margin: 0 0 15px 0;
                                    color: var(--text-primary);
                                    font-size: 1.8rem;
                                    font-weight: 700;
                                ">${escapeHtml(call.name || 'غير معروف')}</h2>
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    margin-bottom: 10px;
                                ">
                                    <span style="font-size: 1.3rem;">📱</span>
                                    <a href="tel:${escapeHtml(call.phone || '')}" style="
                                        color: var(--primary-color);
                                        text-decoration: none;
                                        font-weight: 700;
                                        font-size: 1.2rem;
                                    ">${escapeHtml(call.phone || 'غير محدد')}</a>
                                </div>
                            </div>
                        </div>
                        
                        <div style="
                            background: var(--bg-secondary);
                            border-radius: 16px;
                            padding: 25px;
                            margin-bottom: 20px;
                            border-right: 4px solid ${callColor};
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                margin-bottom: 15px;
                            ">
                                <span style="font-size: 1.5rem;">📝</span>
                                <h3 style="
                                    margin: 0;
                                    color: var(--text-primary);
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                ">التفاصيل</h3>
                            </div>
                            <div style="
                                color: var(--text-primary);
                                font-size: 1rem;
                                line-height: 1.8;
                                white-space: pre-wrap;
                                padding: 15px;
                                background: var(--bg-primary);
                                border-radius: 12px;
                            ">${escapeHtml(call.details || 'لا توجد تفاصيل')}</div>
                        </div>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 20px;
                        ">
                            <div style="
                                background: var(--bg-secondary);
                                padding: 20px;
                                border-radius: 12px;
                                border-top: 3px solid var(--primary-color);
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                ">
                                    <span style="font-size: 1.3rem;">👤</span>
                                    <div style="
                                        color: var(--text-secondary);
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                    ">الموظف</div>
                                </div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                ">${escapeHtml(call.agent || 'غير محدد')}</div>
                            </div>
                            
                            ${call.department ? `
                            <div style="
                                background: var(--bg-secondary);
                                padding: 20px;
                                border-radius: 12px;
                                border-top: 3px solid var(--primary-color);
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                ">
                                    <span style="font-size: 1.3rem;">🏢</span>
                                    <div style="
                                        color: var(--text-secondary);
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                    ">القسم</div>
                                </div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                ">${escapeHtml(getDepartmentName(call.department) || 'غير محدد')}</div>
                            </div>
                            ` : ''}
                            
                            ${call.shift_time ? `
                            <div style="
                                background: var(--bg-secondary);
                                padding: 20px;
                                border-radius: 12px;
                                border-top: 3px solid var(--primary-color);
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                ">
                                    <span style="font-size: 1.3rem;">⏰</span>
                                    <div style="
                                        color: var(--text-secondary);
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                    ">وقت الشفت</div>
                                </div>
                                <div style="
                                    color: var(--text-primary);
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                ">${escapeHtml(call.shift_time)}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="
                            background: var(--bg-secondary);
                            padding: 20px;
                            border-radius: 12px;
                            border-top: 3px solid var(--primary-color);
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 10px;
                            ">
                                <span style="font-size: 1.3rem;">📅</span>
                                <div style="
                                    color: var(--text-secondary);
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">تاريخ الإنشاء</div>
                            </div>
                            <div style="
                                color: var(--text-primary);
                                font-size: 1.1rem;
                                font-weight: 700;
                            ">${formattedDate}</div>
                        </div>
                    </div>
                `;
                document.getElementById('callDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error showing call details:', error);
                showAlert(document.getElementById('callAlert'), 'حدث خطأ أثناء عرض التفاصيل', 'error');
            }
        }
        
        function closeCallDetailsModal() {
            document.getElementById('callDetailsModal').classList.remove('active');
            // مسح بيانات المكالمة المحفوظة
            window.currentCallDetails = null;
        }
        
        /**
         * مشاركة تذكرة المكالمة عبر واتساب أو نسخها كرسالة
         * @param {string} method - 'whatsapp' أو 'copy'
         */
        function shareCallTicket(method) {
            try {
                // الحصول على بيانات المكالمة المحفوظة
                const call = window.currentCallDetails;
                if (!call) {
                    const alertDiv = document.getElementById('callDetailsAlert') || document.getElementById('callAlert');
                    showAlert(alertDiv, 'خطأ: لم يتم العثور على بيانات المكالمة', 'error');
                    return;
                }
                
                // تنسيق التذكرة كرسالة
                const callType = call.call_type || 'غير محدد';
                const name = call.name || 'غير معروف';
                const phone = call.phone || 'غير محدد';
                const details = call.details || 'لا توجد تفاصيل';
                const agent = call.agent || 'غير محدد';
                const department = call.department ? getDepartmentName(call.department) : null;
                const shiftTime = call.shift_time || '';
                const callDate = call.created_at ? new Date(call.created_at) : null;
                const formattedDate = callDate ? callDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'غير محدد';
                
                let ticketMessage = `*تذكرة تفاصيل المكالمة*\n\n`;
                ticketMessage += `*نوع المكالمة:* ${callType}\n`;
                ticketMessage += `*اسم المتصل:* ${name}\n`;
                ticketMessage += `*رقم الهاتف:* ${phone}\n`;
                ticketMessage += `\n*التفاصيل:*\n${details}\n`;
                ticketMessage += `\n*الموظف:* ${agent}\n`;
                if (department) {
                    ticketMessage += `*القسم:* ${department}\n`;
                }
                if (shiftTime) {
                    ticketMessage += `*وقت الشفت:* ${shiftTime}\n`;
                }
                ticketMessage += `*تاريخ الإنشاء:* ${formattedDate}\n`;
                
                if (method === 'whatsapp') {
                    // مشاركة عبر واتساب
                    const whatsappText = encodeURIComponent(ticketMessage);
                    const whatsappUrl = `https://wa.me/?text=${whatsappText}`;
                    window.open(whatsappUrl, '_blank');
                } else if (method === 'copy') {
                    // نسخ الرسالة إلى الحافظة
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(ticketMessage).then(() => {
                            const alertDiv = document.getElementById('callDetailsAlert') || document.getElementById('callAlert');
                            showAlert(alertDiv, '✅ تم نسخ التذكرة إلى الحافظة بنجاح!', 'success');
                        }).catch(() => {
                            // طريقة بديلة للنسخ
                            copyToClipboardFallback(ticketMessage);
                        });
                    } else {
                        // طريقة بديلة للنسخ
                        copyToClipboardFallback(ticketMessage);
                    }
                }
            } catch (error) {
                console.error('Error sharing call ticket:', error);
                const alertDiv = document.getElementById('callDetailsAlert') || document.getElementById('callAlert');
                showAlert(alertDiv, 'حدث خطأ أثناء مشاركة التذكرة', 'error');
            }
        }
        
        /**
         * طريقة بديلة لنسخ النص إلى الحافظة
         * @param {string} text - النص المراد نسخه
         */
        function copyToClipboardFallback(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '0';
                textArea.style.left = '0';
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = '0';
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const alertDiv = document.getElementById('callDetailsAlert') || document.getElementById('callAlert');
                if (successful) {
                    showAlert(alertDiv, '✅ تم نسخ التذكرة إلى الحافظة بنجاح!', 'success');
                } else {
                    showAlert(alertDiv, '❌ فشل نسخ التذكرة. يرجى نسخها يدوياً.', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                const alertDiv = document.getElementById('callDetailsAlert') || document.getElementById('callAlert');
                showAlert(alertDiv, '❌ فشل نسخ التذكرة. يرجى نسخها يدوياً.', 'error');
            }
        }
        
        function editCallByIndex(index) {
            if (!window.currentCallsData || !window.currentCallsData[index]) {
                showAlert(document.getElementById('callAlert'), 'خطأ: لم يتم العثور على المكالمة', 'error');
                return;
            }
            const call = window.currentCallsData[index];
            openEditCallModal(call);
        }
        
        function openEditCallModal(call) {
            const modal = document.getElementById('editCallModal');
            if (!modal) {
                showAlert(document.getElementById('callAlert'), 'خطأ: لم يتم العثور على نافذة التعديل', 'error');
                return;
            }
            
            document.getElementById('editCallId').value = call.id || '';
            document.getElementById('editCallType').value = call.call_type || '';
            document.getElementById('editCallName').value = call.name || '';
            document.getElementById('editCallPhone').value = call.phone || '';
            document.getElementById('editCallDetails').value = call.details || '';
            document.getElementById('editCallAgent').value = call.agent || '';
            document.getElementById('editCallDepartment').value = call.department || '';
            document.getElementById('editCallShiftTime').value = call.shift_time || '';
            document.getElementById('editCallAlert').innerHTML = '';
            
            modal.classList.add('active');
        }
        
        function closeEditCallModal() {
            document.getElementById('editCallModal').classList.remove('active');
        }
        
        async function saveEditedCall() {
            const alertDiv = document.getElementById('editCallAlert');
            const id = document.getElementById('editCallId').value;
            const callType = document.getElementById('editCallType').value.trim();
            const name = document.getElementById('editCallName').value.trim();
            const phone = document.getElementById('editCallPhone').value.trim();
            const details = document.getElementById('editCallDetails').value.trim();
            const agent = document.getElementById('editCallAgent').value.trim();
            const department = document.getElementById('editCallDepartment').value.trim();
            const shiftTime = document.getElementById('editCallShiftTime').value.trim();
            
            if (!callType || !name || !phone) {
                showAlert(alertDiv, 'يجب ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            try {
                const updateData = {
                    call_type: callType,
                    name: name,
                    phone: phone,
                    details: details,
                    agent: agent,
                    department: department,
                    shift_time: shiftTime,
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest('calls', 'PATCH', updateData, `?id=eq.${id}`);
                showAlert(alertDiv, 'تم تحديث المكالمة بنجاح', 'success');
                
                setTimeout(async () => {
                    closeEditCallModal();
                    await loadAllCalls();
                    showAlert(document.getElementById('callAlert'), 'تم تحديث المكالمة بنجاح', 'success');
                }, 1000);
            } catch (error) {
                console.error('Error updating call:', error);
                showAlert(alertDiv, 'حدث خطأ أثناء تحديث المكالمة', 'error');
            }
        }
        
        async function deleteCallByIndex(index) {
            if (!window.currentCallsData || !window.currentCallsData[index]) {
                showAlert(document.getElementById('callAlert'), 'خطأ: لم يتم العثور على المكالمة', 'error');
                return;
            }
            const call = window.currentCallsData[index];
            
            if (!confirm(`هل أنت متأكد من حذف هذه المكالمة؟\n\nنوع المكالمة: ${call.call_type}\nاسم المتصل: ${call.name}\nرقم الهاتف: ${call.phone}`)) {
                return;
            }
            
            try {
                await supabaseRequest('calls', 'DELETE', null, `?id=eq.${call.id}`);
                showAlert(document.getElementById('callAlert'), 'تم حذف المكالمة بنجاح', 'success');
                await loadAllCalls();
            } catch (error) {
                console.error('Error deleting call:', error);
                showAlert(document.getElementById('callAlert'), 'حدث خطأ أثناء حذف المكالمة', 'error');
            }
        }
        
        function editCustomerByIndex(index) {
            if (!window.currentCustomersData || !window.currentCustomersData[index]) {
                showAlert(document.getElementById('customerAlert'), 'خطأ: لم يتم العثور على المشترك', 'error');
                return;
            }
            const customer = window.currentCustomersData[index];
            openEditCustomerModal(customer);
        }
        
        function openEditCustomerModal(customer) {
            const modal = document.getElementById('editCustomerModal');
            if (!modal) {
                showAlert(document.getElementById('customerAlert'), 'خطأ: لم يتم العثور على نافذة التعديل', 'error');
                return;
            }
            
            document.getElementById('editCustomerId').value = customer.id || '';
            document.getElementById('editCustomerUsername').value = customer.username || '';
            document.getElementById('editCustomerRegion').value = customer.region || '';
            document.getElementById('editCustomerClosestPoint').value = customer.closest_point || '';
            document.getElementById('editCustomerPhone').value = customer.phone || '';
            document.getElementById('editCustomerDate').value = customer.date || '';
            document.getElementById('editCustomerNotes').value = customer.notes || '';
            document.getElementById('editCustomerEmployee').value = customer.employee || '';
            document.getElementById('editCustomerAgent').value = customer.agent || '';
            document.getElementById('editCustomerAlert').innerHTML = '';
            
            modal.classList.add('active');
        }
        
        function closeEditCustomerModal() {
            document.getElementById('editCustomerModal').classList.remove('active');
        }
        
        async function saveEditedCustomer() {
            const alertDiv = document.getElementById('editCustomerAlert');
            const id = document.getElementById('editCustomerId').value;
            const username = document.getElementById('editCustomerUsername').value.trim();
            const region = document.getElementById('editCustomerRegion').value.trim();
            const closestPoint = document.getElementById('editCustomerClosestPoint').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const date = document.getElementById('editCustomerDate').value.trim();
            const notes = document.getElementById('editCustomerNotes').value.trim();
            const employee = document.getElementById('editCustomerEmployee').value.trim();
            const agent = document.getElementById('editCustomerAgent').value.trim();
            
            if (!username || !phone) {
                showAlert(alertDiv, 'يجب ملء الاسم ورقم الهاتف', 'error');
                return;
            }
            
            try {
                const updateData = {
                    username: username,
                    region: region,
                    closest_point: closestPoint,
                    phone: phone,
                    date: date,
                    notes: notes,
                    employee: employee,
                    agent: agent,
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest('customers', 'PATCH', updateData, `?id=eq.${id}`);
                showAlert(alertDiv, 'تم تحديث بيانات المشترك بنجاح', 'success');
                
                setTimeout(async () => {
                    closeEditCustomerModal();
                    await searchCustomers();
                    showAlert(document.getElementById('customerAlert'), 'تم تحديث بيانات المشترك بنجاح', 'success');
                }, 1000);
            } catch (error) {
                console.error('Error updating customer:', error);
                showAlert(alertDiv, 'حدث خطأ أثناء تحديث بيانات المشترك', 'error');
            }
        }
        
        async function deleteCustomerByIndex(index) {
            if (!window.currentCustomersData || !window.currentCustomersData[index]) {
                showAlert(document.getElementById('customerAlert'), 'خطأ: لم يتم العثور على المشترك', 'error');
                return;
            }
            const customer = window.currentCustomersData[index];
            
            if (!confirm(`هل أنت متأكد من حذف هذا المشترك؟\n\nالاسم: ${customer.username}\nرقم الهاتف: ${customer.phone}\nالمنطقة: ${customer.region}`)) {
                return;
            }
            
            try {
                await supabaseRequest('customers', 'DELETE', null, `?id=eq.${customer.id}`);
                showAlert(document.getElementById('customerAlert'), 'تم حذف المشترك بنجاح', 'success');
                await searchCustomers();
            } catch (error) {
                console.error('Error deleting customer:', error);
                showAlert(document.getElementById('customerAlert'), 'حدث خطأ أثناء حذف المشترك', 'error');
            }
        }
        
        async function searchCalls() {
            const searchQuery = document.getElementById('callSearchInput').value.trim();
            const tbody = document.getElementById('callsListBody');
            
            if (!searchQuery) {
                if (allCallsData.length > 0) {
                    displayCallsTable(allCallsData);
                }
                return;
            }
            
            try {
                if (allCallsData.length === 0) {
                    allCallsData = [];
                    let from = 0;
                    const batchSize = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const to = from + batchSize - 1;
                        const batch = await supabaseRequest('calls', 'GET', null, `?order=created_at.desc`, {
                            'Range': `${from}-${to}`
                        });
                        if (Array.isArray(batch) && batch.length > 0) {
                            allCallsData = allCallsData.concat(batch);
                            if (batch.length < batchSize) {
                                hasMore = false;
                            } else {
                                from += batchSize;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                }
                
                const filtered = allCallsData.filter(call => {
                    const searchLower = searchQuery.toLowerCase();
                    return (
                        (call.call_type && call.call_type.toLowerCase().includes(searchLower)) ||
                        (call.name && call.name.toLowerCase().includes(searchLower)) ||
                        (call.phone && call.phone.includes(searchQuery)) ||
                        (call.details && call.details.toLowerCase().includes(searchLower)) ||
                        (call.agent && call.agent.toLowerCase().includes(searchLower))
                    );
                });
                
                if (filtered.length > 0) {
                    displayCallsTable(filtered);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد نتائج</td></tr>';
                }
            } catch (error) {
                console.error('Error searching calls:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const callTab = document.getElementById('call');
            if (callTab) {
                const observer = new MutationObserver(function(mutations) {
                    if (callTab.classList.contains('active') && allCallsData.length === 0) {
                    }
                });
                observer.observe(callTab, { attributes: true, attributeFilter: ['class'] });
            }
        });
        
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };
            
            const headers = parseCSVLine(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    if (values.some(v => v && v.trim())) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = (values[index] || '').trim();
                        });
                        values.forEach((value, index) => {
                            row[index] = value.trim();
                        });
                        rows.push(row);
                    }
                }
            }
            
            return { headers, rows };
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            
            return values.map(v => v.trim().replace(/^"|"$/g, ''));
        }
        
        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const result = parseCSV(text);
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function formatDateForSupabase(dateString) {
            if (!dateString || dateString.trim() === '' || 
                dateString.toLowerCase().includes('لا يوجد') || 
                dateString.toLowerCase().includes('لايوجد') ||
                dateString.toLowerCase().includes('غير محدد')) {
                return null;
            }
            
            const dateMatch = dateString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (dateMatch) {
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                const year = dateMatch[3];
                const date = new Date(`${year}-${month}-${day}`);
                if (!isNaN(date.getTime()) && 
                    date.getDate() == parseInt(day) && 
                    date.getMonth() + 1 == parseInt(month) && 
                    date.getFullYear() == parseInt(year)) {
                    return `${year}-${month}-${day}`;
                }
            }
            
            const isoMatch = dateString.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (isoMatch) {
                const year = isoMatch[1];
                const month = isoMatch[2].padStart(2, '0');
                const day = isoMatch[3].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return null;
        }
        
        let chatUsers = [];
        let currentChatUserId = null;
        let chatInterval = null;
        let allChatMessages = [];
        let isSendingMessage = false; 
        
        function openChatWindow() {
            switchTab('chat');
        }
        
        function closeChatWindow() {
            switchTab('dashboard');
        }
        
        async function loadChatUsers() {
            try {
                if (!currentUserId) {
                    console.warn('Current user ID is not set');
                    document.getElementById('chatUsersList').innerHTML = '<p style="text-align: center; color: var(--error-color); padding: 20px;">يجب تسجيل الدخول أولاً</p>';
                    return;
                }
                
                
                
                let allUsers = [];
                
                
                try {
                    let from = 0;
                    const batchSize = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const to = from + batchSize - 1;
                        const batch = await supabaseRequest('users', 'GET', null, `?is_active=eq.true&system_name=eq.${SYSTEM_NAME}&order=full_name.asc`, {
                            'Range': `${from}-${to}`
                        });
                        if (Array.isArray(batch) && batch.length > 0) {
                            allUsers = allUsers.concat(batch);
                            if (batch.length < batchSize) {
                                hasMore = false;
                            } else {
                                from += batchSize;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                } catch (rangeError) {
                    console.log('Range method failed, trying simple query:', rangeError);
                    
                    try {
                        const simpleUsers = await supabaseRequest('users', 'GET', null, `?is_active=eq.true&system_name=eq.${SYSTEM_NAME}&order=full_name.asc`);
                        if (Array.isArray(simpleUsers)) {
                            allUsers = simpleUsers;
                        }
                    } catch (simpleError) {
                        console.error('Simple query also failed:', simpleError);
                    }
                }
                
                
                allUsers = allUsers.filter(u => {
                    const userSystem = u.system_name || '';
                    const isCorrectSystem = userSystem === SYSTEM_NAME;
                    if (!isCorrectSystem) {
                    }
                    return isCorrectSystem;
                });
                
                
                const allowedUsersList = await loadAllowedUsers();
                
                
                allUsers = allUsers.filter(u => {
                    const fullName = (u.full_name || '').trim();
                    const username = (u.username || '').trim();
                    
                    
                    let isAllowedByName = allowedUsersList.some(allowed => {
                        const allowedName = (allowed.full_name || '').trim();
                        return allowedName === fullName && allowed.is_active;
                    });
                    
                    
                    if (!isAllowedByName) {
                        isAllowedByName = allowedUsersList.some(allowed => {
                            if (!allowed.is_active) return false;
                            const allowedName = (allowed.full_name || '').trim();
                            
                            const normalizedAllowed = allowedName.replace(/\s+/g, ' ').trim();
                            const normalizedFull = fullName.replace(/\s+/g, ' ').trim();
                            return normalizedAllowed === normalizedFull || normalizedFull.includes(normalizedAllowed);
                        });
                    }
                    
                    
                    const isAdmin = username === 'admin' && allowedUsersList.some(allowed => 
                        (allowed.username === 'admin' || allowed.full_name === 'Ameer Helwas') && allowed.is_active
                    );
                    
                    const isAllowed = isAllowedByName || isAdmin;
                    
                    if (!isAllowed) {
                    }
                    return isAllowed;
                });
                
                
                
                chatUsers = allUsers.filter(u => {
                    
                    const userId = typeof u.id === 'string' ? parseInt(u.id) : u.id;
                    const currentId = typeof currentUserId === 'string' ? parseInt(currentUserId) : currentUserId;
                    const isDifferent = userId !== currentId;
                    if (!isDifferent) {
                    }
                    return isDifferent;
                });
                
                
                if (chatUsers.length === 0) {
                    document.getElementById('chatUsersList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">لا يوجد موظفين آخرين في النظام</p>';
                } else {
                    displayChatUsers(chatUsers);
                }
            } catch (error) {
                console.error('Error loading chat users:', error);
                document.getElementById('chatUsersList').innerHTML = '<p style="text-align: center; color: var(--error-color); padding: 20px;">حدث خطأ في تحميل الموظفين: ' + error.message + '</p>';
            }
        }
        
        function displayChatUsers(users) {
            const container = document.getElementById('chatUsersList');
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">لا يوجد موظفين</p>';
                return;
            }
            
            
            Promise.allSettled(users.map(async (user) => {
                try {
                    const [unreadCount, lastMessage, profile] = await Promise.allSettled([
                        getUnreadMessagesCount(user.id),
                        getLastMessage(user.id),
                        supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${user.id}`)
                    ]);
                    const profileData = profile.status === 'fulfilled' && profile.value && profile.value.length > 0 ? profile.value[0] : null;
                    return { 
                        user, 
                        unreadCount: unreadCount.status === 'fulfilled' ? unreadCount.value : 0,
                        lastMessage: lastMessage.status === 'fulfilled' ? lastMessage.value : null,
                        profilePicture: profileData?.profile_picture || null
                    };
                } catch (error) {
                    
                    return { 
                        user, 
                        unreadCount: 0,
                        lastMessage: null,
                        profilePicture: null
                    };
                }
            })).then(results => {
                container.innerHTML = results.map((result) => {
                    if (result.status === 'rejected') {
                        
                        const user = result.reason?.user || { id: 0, full_name: 'غير معروف' };
                    const avatarText = user.full_name ? user.full_name.charAt(0) : '?';
                    return `
                        <div class="chat-user-item" onclick="selectChatUser(${user.id}, '${escapeHtml(user.full_name)}', this)">
                            <div class="chat-user-avatar">${avatarText}</div>
                                <div class="chat-user-info">
                                    <div class="chat-user-name">${escapeHtml(user.full_name)}</div>
                                    <div class="chat-user-last-message">لا توجد رسائل</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    const { user, unreadCount, lastMessage, profilePicture } = result.value;
                    const avatarText = user.full_name ? user.full_name.charAt(0) : '?';
                    const avatarHTML = profilePicture ? 
                        `<img src="${escapeHtml(profilePicture)}" alt="${escapeHtml(user.full_name)}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${avatarText}';">` : 
                        avatarText;
                    return `
                        <div class="chat-user-item" onclick="selectChatUser(${user.id}, '${escapeHtml(user.full_name)}', this)">
                            ${unreadCount > 0 ? `<span class="chat-user-unread">${unreadCount}</span>` : ''}
                            <div class="chat-user-avatar">${avatarHTML}</div>
                            <div class="chat-user-info">
                                <div class="chat-user-name">${escapeHtml(user.full_name)}</div>
                                <div class="chat-user-last-message">${lastMessage ? escapeHtml(lastMessage.substring(0, 30)) + '...' : 'لا توجد رسائل'}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(error => {
                console.error('Error displaying chat users:', error);
                
                container.innerHTML = users.map(user => {
                    const avatarText = user.full_name ? user.full_name.charAt(0) : '?';
                    return `
                        <div class="chat-user-item" onclick="selectChatUser(${user.id}, '${escapeHtml(user.full_name)}', this)">
                            <div class="chat-user-avatar">${avatarText}</div>
                            <div class="chat-user-info">
                                <div class="chat-user-name">${escapeHtml(user.full_name)}</div>
                                <div class="chat-user-last-message">لا توجد رسائل</div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }
        
        async function getUnreadMessagesCount(userId) {
            try {
                if (!currentUserId || !userId) {
                    return 0;
                }
                const messages = await supabaseRequest('messages', 'GET', null, `?receiver_id=eq.${currentUserId}&sender_id=eq.${userId}&is_read=eq.false`);
                return Array.isArray(messages) ? messages.length : 0;
            } catch (error) {
                
                if (error.message && !error.message.includes('Failed to fetch')) {
                    console.warn('Error getting unread messages count:', error);
                }
                return 0;
            }
        }
        
        async function getLastMessage(userId) {
            try {
                if (!currentUserId || !userId) {
                    return null;
                }
                
                
                let sentMessages = null;
                let receivedMessages = null;
                
                try {
                    
                    sentMessages = await supabaseRequest('messages', 'GET', null, `?sender_id=eq.${currentUserId}&receiver_id=eq.${userId}&order=created_at.desc&limit=1`);
                } catch (sentError) {
                    
                    console.warn('Error fetching sent messages:', sentError);
                    sentMessages = null;
                }
                
                try {
                    
                    receivedMessages = await supabaseRequest('messages', 'GET', null, `?sender_id=eq.${userId}&receiver_id=eq.${currentUserId}&order=created_at.desc&limit=1`);
                } catch (receivedError) {
                    
                    console.warn('Error fetching received messages:', receivedError);
                    receivedMessages = null;
                }
                
                const sent = (Array.isArray(sentMessages) && sentMessages.length > 0) ? sentMessages[0] : null;
                const received = (Array.isArray(receivedMessages) && receivedMessages.length > 0) ? receivedMessages[0] : null;
                
                
                if (sent && received) {
                    try {
                        const sentDate = new Date(sent.created_at);
                        const receivedDate = new Date(received.created_at);
                        return sentDate > receivedDate ? sent.message : received.message;
                    } catch (dateError) {
                        
                        return sent.message || received.message;
                    }
                } else if (sent) {
                    return sent.message;
                } else if (received) {
                    return received.message;
                }
                
                return null;
            } catch (error) {
                
                if (error.message && error.message.includes('Failed to fetch')) {
                    
                    return null;
                }
                console.error('Error getting last message:', error);
                return null;
            }
        }
        
        async function selectChatUser(userId, userName, element) {
            currentChatUserId = userId;
            document.getElementById('chatCurrentUserName').textContent = userName;
            document.getElementById('chatNoSelection').style.display = 'none';
            document.getElementById('chatMessagesArea').style.display = 'flex';
            
            
            document.querySelectorAll('.chat-user-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            
            await loadChatMessages(userId);
            
            
            await markMessagesAsRead(userId);
        }
        
        async function loadChatMessages(userId) {
            try {
                if (!currentUserId || !userId) {
                    console.error('Missing user IDs:', { currentUserId, userId });
                    return;
                }
                
                
                const sentMessages = await supabaseRequest('messages', 'GET', null, `?sender_id=eq.${currentUserId}&receiver_id=eq.${userId}&order=created_at.asc`);
                const receivedMessages = await supabaseRequest('messages', 'GET', null, `?sender_id=eq.${userId}&receiver_id=eq.${currentUserId}&order=created_at.asc`);
                
                const sent = Array.isArray(sentMessages) ? sentMessages : [];
                const received = Array.isArray(receivedMessages) ? receivedMessages : [];
                
                
                allChatMessages = [...sent, ...received].sort((a, b) => {
                    return new Date(a.created_at) - new Date(b.created_at);
                });
                
                displayChatMessages(allChatMessages);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        async function displayChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #667781;"><div style="font-size: 4rem; margin-bottom: 15px; opacity: 0.5;">💬</div><p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">لا توجد رسائل بعد</p><p style="font-size: 0.9rem; opacity: 0.7;">ابدأ المحادثة بإرسال رسالة</p></div>';
                return;
            }
            
            const uniqueUserIds = [...new Set(messages.map(m => m.sender_id))];
            const userProfiles = {};
            
            await Promise.allSettled(uniqueUserIds.map(async (userId) => {
                try {
                    const profile = await supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${userId}`);
                    if (profile && profile.length > 0 && profile[0].profile_picture) {
                        userProfiles[userId] = profile[0].profile_picture;
                    }
                } catch (error) {
                    console.warn('Error loading profile for user', userId, error);
                }
            }));
            
            const currentUserProfile = userProfiles[currentUserId] || null;
            
            let lastDate = null;
            let lastSenderId = null;
            
            container.innerHTML = messages.map((msg, index) => {
                const isSent = msg.sender_id === currentUserId;
                const senderProfile = isSent ? currentUserProfile : (userProfiles[msg.sender_id] || null);
                const avatarText = isSent ? (loggedInUser ? loggedInUser.charAt(0).toUpperCase() : 'أ') : (msg.sender_name ? msg.sender_name.charAt(0).toUpperCase() : '?');
                const avatarHTML = senderProfile ? 
                    `<img src="${escapeHtml(senderProfile)}" alt="${escapeHtml(isSent ? loggedInUser : msg.sender_name)}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${avatarText}';">` : 
                    avatarText;
                const messageDate = new Date(msg.created_at);
                const messageTime = messageDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const messageDateStr = messageDate.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                
                let dateSeparator = '';
                const currentDate = messageDate.toDateString();
                if (lastDate !== currentDate) {
                    lastDate = currentDate;
                    dateSeparator = `<div style="text-align: center; margin: 24px 0 16px 0; position: relative;">
                        <span style="background: rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; color: #667781; font-weight: 500; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);">${messageDateStr}</span>
                    </div>`;
                }
                
                
                const prevMsg = index > 0 ? messages[index - 1] : null;
                const timeDiff = prevMsg ? (new Date(msg.created_at) - new Date(prevMsg.created_at)) / 1000 / 60 : 999; 
                const showAvatar = !prevMsg || prevMsg.sender_id !== msg.sender_id || timeDiff > 5;
                const showSpacer = !showAvatar && (prevMsg && prevMsg.sender_id === msg.sender_id);
                
                
                if (showAvatar) {
                    lastSenderId = msg.sender_id;
                }
                
                let statusIcon = '';
                if (isSent) {
                    if (msg.is_read) {
                        statusIcon = '<span class="message-status read" title="مقروءة">✓✓</span>';
                    } else if (msg.is_delivered) {
                        statusIcon = '<span class="message-status delivered" title="وصلت">✓✓</span>';
                    } else {
                        statusIcon = '<span class="message-status sent" title="أرسلت">✓</span>';
                    }
                }
                
                return `
                    ${dateSeparator}
                    <div class="chat-message ${isSent ? 'sent' : 'received'}" style="margin-bottom: ${showAvatar ? '12px' : '4px'}; width: 100%; display: flex; ${isSent ? 'justify-content: flex-end; padding-right: 0;' : 'justify-content: flex-start; padding-left: 0;'}">
                        ${!isSent && showAvatar ? `<div class="chat-message-avatar" style="margin-left: 0; margin-right: 8px; flex-shrink: 0;">${avatarHTML}</div>` : !isSent && !showSpacer ? '<div style="width: 40px; flex-shrink: 0;"></div>' : ''}
                        <div class="chat-message-content" style="position: relative; ${isSent ? 'margin-right: 0; margin-left: auto;' : 'margin-left: 0; margin-right: auto;'} max-width: 70%;">
                            <p class="chat-message-text" style="margin: 0 0 4px 0; word-wrap: break-word; white-space: pre-wrap;">${escapeHtml(msg.message)}</p>
                            <div class="chat-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: ${isSent ? 'flex-end' : 'flex-start'}; font-size: 0.7rem; color: rgba(0,0,0,0.5); margin-top: 4px;">
                                <span>${messageTime}</span>
                                ${statusIcon}
                            </div>
                        </div>
                        ${isSent && showAvatar ? `<div class="chat-message-avatar" style="margin-right: 0; margin-left: 8px; flex-shrink: 0;">${avatarHTML}</div>` : isSent && !showSpacer ? '<div style="width: 40px; flex-shrink: 0;"></div>' : ''}
                    </div>
                `;
            }).join('');
            
            
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        
        function handleChatInputKeydown(e) {
            const textarea = e.target;
            
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }
        
        async function sendChatMessage() {
            
            if (isSendingMessage) {
                return;
            }
            
            if (!currentChatUserId) {
                showToast('يرجى اختيار موظف أولاً', 'warning');
                return;
            }
            
            if (!currentUserId) {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const messageInput = document.getElementById('chatMessageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                return;
            }
            
            
            isSendingMessage = true;
            messageInput.disabled = true;
            const sendBtn = document.querySelector('.chat-send-btn');
            if (sendBtn) sendBtn.disabled = true;
            
            try {
                
                const senderCheck = await supabaseRequest('users', 'GET', null, `?id=eq.${currentUserId}`);
                if (!senderCheck || senderCheck.length === 0) {
                    showToast('المستخدم الحالي غير موجود في النظام', 'error');
                    messageInput.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                    return;
                }
                
                const receiverCheck = await supabaseRequest('users', 'GET', null, `?id=eq.${currentChatUserId}`);
                if (!receiverCheck || receiverCheck.length === 0) {
                    showToast('الموظف المحدد غير موجود في النظام', 'error');
                    messageInput.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                    return;
                }
                
                const receiver = chatUsers.find(u => u.id === currentChatUserId);
                if (!receiver) {
                    showToast('الموظف المحدد غير موجود', 'error');
                    messageInput.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                    return;
                }
                
                const messageData = {
                    sender_id: parseInt(currentUserId),
                    sender_name: loggedInUser,
                    receiver_id: parseInt(currentChatUserId),
                    receiver_name: receiver.full_name,
                    message: message,
                    is_read: false,
                    is_delivered: false
                };
                
                const result = await supabaseRequest('messages', 'POST', messageData);
                
                if (result && result.length > 0) {
                    const messageId = result[0].id;
                    setTimeout(async () => {
                        try {
                            await supabaseRequest('messages', 'PATCH', { is_delivered: true }, `?id=eq.${messageId}`);
                        } catch (error) {
                            console.warn('Error marking message as delivered:', error);
                        }
                    }, 1000);
                }
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                
                await loadChatMessages(currentChatUserId);
                await loadChatUsers(); 
            } catch (error) {
                console.error('Error sending message:', error);
                if (error.message && error.message.includes('foreign key')) {
                    showToast('خطأ: المستخدم غير موجود في النظام. يرجى تسجيل الخروج والدخول مرة أخرى', 'error');
                } else {
                    showToast('حدث خطأ في إرسال الرسالة', 'error');
                }
            } finally {
                isSendingMessage = false;
                messageInput.disabled = false;
                const sendBtn = document.querySelector('.chat-send-btn');
                if (sendBtn) sendBtn.disabled = false;
                messageInput.focus();
            }
        }
        
        async function markMessagesAsRead(userId) {
            try {
                const unreadMessages = await supabaseRequest('messages', 'GET', null, `?receiver_id=eq.${currentUserId}&sender_id=eq.${userId}&is_read=eq.false`);
                if (unreadMessages && Array.isArray(unreadMessages) && unreadMessages.length > 0) {
                    const messageIds = unreadMessages.map(m => m.id);
                    for (const msgId of messageIds) {
                        try {
                            await supabaseRequest('messages', 'PATCH', { is_read: true, is_delivered: true }, `?id=eq.${msgId}`);
                        } catch (error) {
                            console.warn('Error marking message as read:', error);
                        }
                    }
                }
                await loadChatMessages(userId);
                await loadChatUsers();
                updateUnreadMessagesCount();
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }
        
        async function updateUnreadMessagesCount() {
            try {
                const messages = await supabaseRequest('messages', 'GET', null, `?receiver_id=eq.${currentUserId}&is_read=eq.false`);
                const count = Array.isArray(messages) ? messages.length : 0;
                const badge = document.getElementById('unreadMessagesBadge');
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating unread count:', error);
            }
        }
        
        function filterChatUsers() {
            const searchQuery = document.getElementById('chatSearchInput').value.toLowerCase();
            const userItems = document.querySelectorAll('.chat-user-item');
            
            userItems.forEach(item => {
                const userName = item.querySelector('.chat-user-name').textContent.toLowerCase();
                if (userName.includes(searchQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        
        let unreadMessagesInterval = null;
        if (currentUserId) {
            updateUnreadMessagesCount();
            
            if (unreadMessagesInterval) clearInterval(unreadMessagesInterval);
            unreadMessagesInterval = setInterval(() => {
                if (isTabActive && document.getElementById('chat') && document.getElementById('chat').classList.contains('active')) {
                    updateUnreadMessagesCount();
                }
            }, 3600000); // 60 دقيقة بدلاً من 30 
        }
        
        
        let chatUpdateInterval = null;
        function startChatAutoUpdate() {
            if (chatUpdateInterval) clearInterval(chatUpdateInterval);
            chatUpdateInterval = setInterval(async () => {
                if (isTabActive && currentChatUserId && document.getElementById('chat') && document.getElementById('chat').classList.contains('active')) {
                    await loadChatMessages(currentChatUserId);
                    await loadChatUsers();
                }
            }, 3600000); // 60 دقيقة بدلاً من 30 
        }
        
        function stopChatAutoUpdate() {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }
        
        
        const originalOpenChat = openChatWindow;
        openChatWindow = function() {
            originalOpenChat();
            startChatAutoUpdate();
        };
        
        const originalCloseChat = closeChatWindow;
        closeChatWindow = function() {
            originalCloseChat();
            stopChatAutoUpdate();
        };
        
        
        async function loadUserProfileForSidebar() {
            if (!currentUserId) return;
            
            try {
                const user = await supabaseRequest('users', 'GET', null, `?id=eq.${currentUserId}`);
                if (user && user.length > 0) {
                    
                    
                    const userName = user[0].full_name || loggedInUser;
                    const initials = userName.charAt(0).toUpperCase();
                    document.getElementById('sidebarUserInitials').textContent = initials;
                }
                
                const profile = await supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${currentUserId}`);
                if (profile && profile.length > 0 && profile[0].profile_picture) {
                    document.getElementById('sidebarUserAvatar').src = profile[0].profile_picture;
                    document.getElementById('sidebarUserAvatar').style.display = 'block';
                    document.getElementById('sidebarUserInitials').style.display = 'none';
                } else {
                    document.getElementById('sidebarUserAvatar').style.display = 'none';
                    document.getElementById('sidebarUserInitials').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading user profile for sidebar:', error);
            }
        }
        
        async function loadProfile() {
            if (!currentUserId) {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            try {
                
                const user = await supabaseRequest('users', 'GET', null, `?id=eq.${currentUserId}`);
                if (user && user.length > 0) {
                    document.getElementById('profileFullName').value = user[0].full_name || '';
                    document.getElementById('profileUsername').value = user[0].username || '';
                    
                    
                    const initials = (user[0].full_name || '').charAt(0).toUpperCase();
                    document.getElementById('profileInitials').textContent = initials;
                }
                
                
                const profile = await supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${currentUserId}`);
                if (profile && profile.length > 0) {
                    const p = profile[0];
                    document.getElementById('profilePhone').value = p.phone || '';
                    document.getElementById('profileEmail').value = p.email || '';
                    
                    
                    if (p.profile_picture) {
                        document.getElementById('profilePicture').src = p.profile_picture;
                        document.getElementById('profilePicture').style.display = 'block';
                        document.getElementById('profileInitials').style.display = 'none';
                    } else {
                        document.getElementById('profilePicture').style.display = 'none';
                        document.getElementById('profileInitials').style.display = 'block';
                    }
                } else {
                    
                    document.getElementById('profilePhone').value = '';
                    document.getElementById('profileEmail').value = '';
                    document.getElementById('profilePicture').style.display = 'none';
                    document.getElementById('profileInitials').style.display = 'block';
                }
                
                const awardsSection = document.getElementById('employeeAwardsSection');
                if (awardsSection) {
                    if (currentUserRole !== 'admin') {
                        awardsSection.style.display = 'block';
                        await loadEmployeeAwards();
                    } else {
                        awardsSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('حدث خطأ في تحميل الملف الشخصي', 'error');
            }
        }
        
        async function loadEmployeeAwards(employeeName = null, targetElementId = 'employeeAwardsList') {
            try {
                const awardsList = document.getElementById(targetElementId);
                if (!awardsList) return;
                
                let fullName = employeeName;
                
                if (!fullName) {
                    const user = await supabaseRequest('users', 'GET', null, `?id=eq.${currentUserId}`);
                    if (!user || user.length === 0) {
                        awardsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">لا توجد بيانات للمستخدم</p>';
                        return;
                    }
                    fullName = (user[0].full_name || '').trim();
                }
                
                if (!fullName) {
                    awardsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">لا توجد بيانات للمستخدم</p>';
                    return;
                }
                
                let allAwards = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    try {
                        const batch = await supabaseRequest('employee_of_the_week', 'GET', null, `?employee_name=eq.${encodeURIComponent(fullName)}&order=week_start_date.desc`, {
                            'Range': `${from}-${to}`
                        });
                        if (Array.isArray(batch) && batch.length > 0) {
                            allAwards = allAwards.concat(batch);
                            if (batch.length < batchSize) {
                                hasMore = false;
                            } else {
                                from += batchSize;
                            }
                        } else {
                            hasMore = false;
                        }
                    } catch (error) {
                        console.warn('Error fetching awards batch:', error);
                        hasMore = false;
                    }
                }
                
                if (allAwards.length === 0) {
                    awardsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">لم يحصل على أي جائزة بعد</p>';
                    return;
                }
                
                awardsList.innerHTML = allAwards.map((award, index) => {
                    const weekStart = award.week_start_date ? new Date(award.week_start_date) : null;
                    const weekEnd = award.week_end_date ? new Date(award.week_end_date) : null;
                    const weekStartStr = weekStart ? weekStart.toLocaleDateString('en-US') : 'غير محدد';
                    const weekEndStr = weekEnd ? weekEnd.toLocaleDateString('en-US') : 'غير محدد';
                    
                    return `
                        <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); position: relative; overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.3);">
                            <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.2); border-radius: 50%;"></div>
                            <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.15); border-radius: 50%;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">🏆</div>
                                <div style="font-weight: 700; font-size: 1.1rem; color: #8B4513; margin-bottom: 8px;">الموظف المثالي</div>
                                <div style="font-size: 0.85rem; color: #654321; margin-bottom: 12px; line-height: 1.4;">
                                    ${weekStartStr}<br>إلى ${weekEndStr}
                                </div>
                                <div style="display: flex; justify-content: space-around; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(139, 69, 19, 0.3);">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #654321; opacity: 0.8;">المكالمات</div>
                                        <div style="font-weight: 700; color: #8B4513; font-size: 1.1rem;">${award.total_calls || 0}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #654321; opacity: 0.8;">المشتركين</div>
                                        <div style="font-weight: 700; color: #8B4513; font-size: 1.1rem;">${award.total_customers || 0}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #654321; opacity: 0.8;">النقاط</div>
                                        <div style="font-weight: 700; color: #8B4513; font-size: 1.1rem;">${award.total_score || 0}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading employee awards:', error);
                const awardsList = document.getElementById('employeeAwardsList');
                if (awardsList) {
                    awardsList.innerHTML = '<p style="text-align: center; color: var(--error-color); padding: 20px; grid-column: 1 / -1;">حدث خطأ أثناء تحميل الجوائز</p>';
                }
            }
        }
        
        async function viewEmployeeProfile(employeeName) {
            if (!employeeName || employeeName.trim() === '') {
                showToast('اسم الموظف غير صحيح', 'error');
                return;
            }
            
            const modal = document.getElementById('employeeProfileModal');
            const modalContent = document.getElementById('employeeProfileModalContent');
            const modalTitle = document.getElementById('employeeProfileModalTitle');
            
            modalTitle.textContent = `الملف الشخصي - ${employeeName}`;
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">👤</div>
                    <p>جاري تحميل البيانات...</p>
                </div>
            `;
            modal.classList.add('active');
            
            try {
                const users = await supabaseRequest('users', 'GET', null, `?full_name=eq.${encodeURIComponent(employeeName.trim())}`, {}, false);
                let user = null;
                let isAdmin = false;
                if (users && users.length > 0) {
                    user = users[0];
                    isAdmin = user.role === 'admin';
                }
                
                const profile = user ? await supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${user.id}`, {}, false) : null;
                const profileData = profile && profile.length > 0 ? profile[0] : null;
                
                const profilePicture = profileData?.profile_picture || null;
                const initials = employeeName.charAt(0).toUpperCase();
                
                let profileHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 30px;">
                        <div style="position: relative; display: inline-block;">
                            <div style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; font-weight: 700; border: 4px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;">
                                ${profilePicture ? `<img src="${escapeHtml(profilePicture)}" alt="${escapeHtml(employeeName)}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.textContent='${initials}';">` : `<span>${initials}</span>`}
                            </div>
                        </div>
                        <div style="width: 100%; max-width: 600px;">
                            <div class="form-group">
                                <label>الاسم الكامل</label>
                                <input type="text" value="${escapeHtml(employeeName)}" readonly style="background: var(--bg-tertiary);">
                            </div>
                        </div>
                        ${!isAdmin ? `
                        <div style="width: 100%; max-width: 600px; margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">🏆</span>
                                <span>جوائز الموظف المثالي</span>
                            </h4>
                            <div id="employeeProfileAwardsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                                <p style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">جاري تحميل الجوائز...</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                modalContent.innerHTML = profileHTML;
                
                if (!isAdmin) {
                    await loadEmployeeAwards(employeeName, 'employeeProfileAwardsList');
                }
            } catch (error) {
                console.error('Error loading employee profile:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--error-color);">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">⚠️</div>
                        <p>حدث خطأ أثناء تحميل الملف الشخصي</p>
                        <button class="btn btn-secondary" onclick="closeEmployeeProfileModal()" style="margin-top: 20px;">إغلاق</button>
                    </div>
                `;
            }
        }
        
        function closeEmployeeProfileModal() {
            document.getElementById('employeeProfileModal').classList.remove('active');
        }
        
        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('حجم الصورة كبير جداً. الحد الأقصى 2MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                document.getElementById('profilePicture').src = imageData;
                document.getElementById('profilePicture').style.display = 'block';
                document.getElementById('profileInitials').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function saveProfile() {
            if (!currentUserId) {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const alertDiv = document.getElementById('profileAlert');
            const phone = document.getElementById('profilePhone').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const profilePicture = document.getElementById('profilePicture').src;
            
            try {
                const profileData = {
                    user_id: parseInt(currentUserId),
                    phone: phone || null,
                    email: email || null,
                    profile_picture: profilePicture && profilePicture.startsWith('data:') ? profilePicture : null,
                    updated_at: new Date().toISOString()
                };
                
                
                const existing = await supabaseRequest('user_profiles', 'GET', null, `?user_id=eq.${currentUserId}`);
                
                if (existing && existing.length > 0) {
                    await supabaseRequest('user_profiles', 'PATCH', profileData, `?user_id=eq.${currentUserId}`);
                    showToast('تم تحديث الملف الشخصي بنجاح', 'success');
                } else {
                    await supabaseRequest('user_profiles', 'POST', profileData);
                    showToast('تم إنشاء الملف الشخصي بنجاح', 'success');
                }
                
                
                loadUserProfileForSidebar();
                loadProfile();
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('حدث خطأ في حفظ الملف الشخصي', 'error');
            }
        }
        
        
        async function loadNotes() {
            if (!currentUserId) {
                document.getElementById('notesList').innerHTML = '<p style="text-align: center; color: var(--error-color); padding: 20px;">يجب تسجيل الدخول أولاً</p>';
                return;
            }
            
            try {
                let allNotes = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    const batch = await supabaseRequest('notes', 'GET', null, `?user_id=eq.${currentUserId}&order=created_at.desc`, {
                        'Range': `${from}-${to}`
                    });
                    if (Array.isArray(batch) && batch.length > 0) {
                        allNotes = allNotes.concat(batch);
                        if (batch.length < batchSize) {
                            hasMore = false;
                        } else {
                            from += batchSize;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                displayNotes(allNotes);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('notesList').innerHTML = '<p style="text-align: center; color: var(--error-color); padding: 20px;">حدث خطأ في تحميل الملاحظات</p>';
            }
        }
        
        function displayNotes(notes) {
            const container = document.getElementById('notesList');
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;"> إضافة ملاحظة جديدة</p>';
                return;
            }
            
            container.innerHTML = notes.map(note => {
                const createdDate = new Date(note.created_at).toLocaleDateString('en-US');
                const createdTime = new Date(note.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const updatedDate = note.updated_at ? new Date(note.updated_at).toLocaleDateString('en-US') : null;
                const updatedTime = note.updated_at ? new Date(note.updated_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : null;
                const isUpdated = updatedDate && (updatedDate !== createdDate || updatedTime !== createdTime);
                
                
                const titleSafe = JSON.stringify(note.title || '');
                const contentSafe = JSON.stringify(note.content || '');
                
                return `
                    <div class="note-card" style="background: var(--card-bg); border: 1.5px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 6px var(--shadow-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--primary-color); font-size: 1.1rem; font-weight: 700; margin-bottom: 8px;">${escapeHtml(note.title)}</h4>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    <span>📅 ${createdDate} ${createdTime}</span>
                                    ${isUpdated ? `<span style="margin-right: 15px;">🔄 تم التحديث: ${updatedDate} ${updatedTime}</span>` : ''}
                                </div>
                            </div>
                            <div class="btn-group" style="margin: 0; gap: 8px;">
                                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="openEditNoteModal(${note.id}, ${titleSafe}, ${contentSafe})">تعديل</button>
                                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteNote(${note.id})">حذف</button>
                            </div>
                        </div>
                        <div style="color: var(--text-primary); line-height: 1.6; white-space: pre-wrap; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-light);">${escapeHtml(note.content)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function openAddNoteModal() {
            document.getElementById('addNoteModal').classList.add('active');
            document.getElementById('addNoteModalTitle').textContent = 'إضافة ملاحظة جديدة';
            document.getElementById('editNoteId').value = '';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('addNoteAlert').innerHTML = '';
        }
        
        function openEditNoteModal(noteId, title, content) {
            document.getElementById('addNoteModal').classList.add('active');
            document.getElementById('addNoteModalTitle').textContent = 'تعديل الملاحظة';
            document.getElementById('editNoteId').value = noteId;
            
            document.getElementById('noteTitle').value = typeof title === 'string' && title.startsWith('"') ? JSON.parse(title) : title;
            document.getElementById('noteContent').value = typeof content === 'string' && content.startsWith('"') ? JSON.parse(content) : content;
            document.getElementById('addNoteAlert').innerHTML = '';
        }
        
        function closeAddNoteModal() {
            document.getElementById('addNoteModal').classList.remove('active');
        }
        
        async function saveNote() {
            if (!currentUserId) {
                showAlert(document.getElementById('addNoteAlert'), 'يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const editNoteId = document.getElementById('editNoteId').value;
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const alertDiv = document.getElementById('addNoteAlert');
            
            if (!title || !content) {
                showAlert(alertDiv, 'يرجى تعبئة جميع الحقول المطلوبة.', 'error');
                return;
            }
            
            try {
                const noteData = {
                    user_id: currentUserId,
                    title: title,
                    content: content
                };
                
                if (editNoteId) {
                    await supabaseRequest('notes', 'PATCH', noteData, `?id=eq.${editNoteId}`);
                    showAlert(alertDiv, 'تم تحديث الملاحظة بنجاح', 'success');
                } else {
                    await supabaseRequest('notes', 'POST', noteData);
                    showAlert(alertDiv, 'تم إضافة الملاحظة بنجاح', 'success');
                }
                
                closeAddNoteModal();
                loadNotes();
            } catch (error) {
                console.error('Error saving note:', error);
                showAlert(alertDiv, `حدث خطأ: ${error.message}`, 'error');
            }
        }
        
        async function deleteNote(noteId) {
            if (!confirm('هل أنت متأكد من حذف هذه الملاحظة؟')) {
                return;
            }
            
            try {
                await supabaseRequest('notes', 'DELETE', null, `?id=eq.${noteId}`);
                showAlert(document.getElementById('notesAlert'), 'تم حذف الملاحظة بنجاح', 'success');
                loadNotes();
            } catch (error) {
                console.error('Error deleting note:', error);
                showAlert(document.getElementById('notesAlert'), 'حدث خطأ أثناء حذف الملاحظة', 'error');
            }
        }
        
    </script>
</body>
</html>
