<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #048267 0%, #14b8a6 100%);
            min-height: 100vh;
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            padding: 0;
            position: relative;
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-left: 4px solid #0f766e;
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 900;
            margin: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header p {
            font-size: 0.85rem;
            margin-top: 5px;
            opacity: 0.95;
        }

        .sidebar-nav {
            flex: 1;
            padding: 15px 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #0f766e 0%, #14b8a6 100%);
            transform: translateX(100%);
            border-radius: 0 12px 12px 0;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border-color: #14b8a6;
            color: #0f766e;
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.15) 0%, rgba(20, 184, 166, 0.1) 100%);
            border-color: #0f766e;
            color: #0f766e;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
        }

        .nav-item.active::before {
            transform: translateX(0);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
            border-radius: 8px;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }

        .nav-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 2px solid #e5e7eb;
            background: #f8f9fa;
        }

        .user-info-sidebar {
            color: #0f766e;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .date-info-sidebar {
            color: #2d3748;
            font-size: 0.75rem;
            text-align: center;
            font-weight: 600;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .main-container {
            margin-right: 280px;
            background: white;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header-section {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            top: -50%;
            right: -50%;
        }

        .header-section h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            letter-spacing: 0.5px;
        }
        
        .header-section h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            opacity: 0.98;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
            z-index: 1;
            letter-spacing: 0.4px;
        }

        .header-section p {
            font-size: 1rem;
            opacity: 0.98;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.3px;
        }


        .content-section {
            padding: 30px 25px;
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.12);
            margin-bottom: 20px;
            overflow: hidden;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%);
            border-top: 3px solid transparent;
            position: relative;
        }

        .card-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0f766e, #14b8a6);
        }

        .card-header-custom {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
        }

        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #d1d5db;
            padding: 10px 14px;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #ffffff;
        }

        .form-select {
            border-radius: 10px;
            border: 2px solid #d1d5db;
            padding: 10px 14px;
            padding-left: 40px;
            padding-right: 14px;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 16px 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0f766e;
            box-shadow: 0 0 0 0.3rem rgba(15, 118, 110, 0.2);
            background-color: #ffffff;
        }

        .form-control:hover, .form-select:hover {
            border-color: #9ca3af;
        }

        .card-body {
            padding: 20px;
        }

        .card-body .row {
            margin-bottom: 8px;
        }

        .text-muted {
            font-size: 0.75rem;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .col-md-3.mb-3 {
            margin-bottom: 0.8rem !important;
        }

        .col-md-2.mb-3 {
            margin-bottom: 0.8rem !important;
        }

        /* Ø¥Ø·Ø§Ø± Ø®Ø§Øµ Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ */
        #addStudentForm .form-control,
        #addStudentForm .form-select {
            border: 3px solid #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        #addStudentForm .form-control:focus,
        #addStudentForm .form-select:focus {
            border-color: #0f766e;
            box-shadow: 0 0 0 0.3rem rgba(15, 118, 110, 0.25), 0 4px 20px rgba(15, 118, 110, 0.15);
        }

        #editStudentForm .form-control,
        #editStudentForm .form-select {
            border: 3px solid #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        #editStudentForm .form-control:focus,
        #editStudentForm .form-select:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 0.3rem rgba(245, 158, 11, 0.25), 0 4px 20px rgba(245, 158, 11, 0.15);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            font-size: 0.95rem;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.25);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary-custom:hover {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .btn-success-custom {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.3);
        }

        .btn-success-custom:hover {
            box-shadow: 0 10px 30px rgba(86, 171, 47, 0.5);
        }

        .btn-info-custom {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-info-custom:hover {
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.5);
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-danger-custom:hover {
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table {
            font-size: 0.8rem;
        }

        .table thead {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }

        .table thead th {
            padding: 10px 8px;
            font-size: 0.8rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .table tbody tr {
            border-bottom: 1px solid #e2e8f0;
        }

        .table tbody td {
            padding: 5px 8px;
            font-size: 0.75rem;
            vertical-align: middle;
            line-height: 1.3;
        }

        .table tbody tr:hover {
            background: linear-gradient(to right, #f8f9ff 0%, #ffffff 100%);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid #0f766e;
        }

        .table tbody td strong {
            font-weight: 700;
            color: #2d3748;
        }

        .table td.no-print {
            white-space: nowrap;
        }

        .table td.no-print .btn {
            padding: 5px 10px;
            font-size: 0.7rem;
            margin: 0 2px;
            border-radius: 6px;
            font-weight: 600;
        }

        .table td.no-print .btn i {
            font-size: 0.75rem;
            margin: 0;
        }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ */
        .nav-tabs {
            border-bottom: 3px solid #0f766e;
        }

        .nav-tabs .nav-link {
            color: #0f766e;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            font-weight: 600;
        }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ */
        .nav-tabs .nav-link[data-school="rawda"] {
            color: #8B4513;
        }
        .nav-tabs .nav-link[data-school="rawda"].active {
            border-bottom-color: #8B4513;
            color: #8B4513;
        }
        
        .nav-tabs .nav-link[data-school="rasoul"] {
            color: #0f766e;
        }
        .nav-tabs .nav-link[data-school="rasoul"].active {
            border-bottom-color: #0f766e;
            color: #0f766e;
        }
        
        .nav-tabs .nav-link[data-school="noor"] {
            color: #f59e0b;
        }
        .nav-tabs .nav-link[data-school="noor"].active {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        
        .nav-tabs .nav-link[data-school="nabi"] {
            color: #3498db;
        }
        .nav-tabs .nav-link[data-school="nabi"].active {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .nav-tabs .nav-link[data-school="thanawiya"] {
            color: #e74c3c;
        }
        .nav-tabs .nav-link[data-school="thanawiya"].active {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            border-bottom-color: #14b8a6;
            color: #14b8a6;
        }
        
        .nav-tabs .nav-link[data-school="rawda"]:hover:not(.active) {
            border-bottom-color: #8B4513;
            color: #8B4513;
        }
        
        .nav-tabs .nav-link[data-school="noor"]:hover:not(.active) {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        
        .nav-tabs .nav-link[data-school="nabi"]:hover:not(.active) {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .nav-tabs .nav-link[data-school="thanawiya"]:hover:not(.active) {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .nav-tabs .nav-link.active {
            color: #0f766e;
            background-color: transparent;
            border-bottom: 3px solid #0f766e;
            font-weight: 700;
        }

        .filter-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .stats-card-advanced {
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stats-card-advanced::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            transition: transform 0.5s ease;
        }

        .stats-card-advanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-card-advanced:hover::before {
            transform: rotate(45deg);
        }

        .stats-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stats-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 600;
        }

        .badge-custom {
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            letter-spacing: 0;
        }

        .badge-custom:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        }

        .stats-box {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .stats-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        }

        .stats-box:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .stats-box h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .stats-box p {
            font-size: 1.5rem;
            font-weight: 900;
            margin: 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .installment-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            margin: 2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            letter-spacing: 0;
            line-height: 1.3;
        }
        
        .installment-badge small {
            display: block;
            font-size: 0.55rem;
            font-weight: 600;
            margin-top: 2px;
            opacity: 0.95;
        }

        .installment-badge:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .installment-paid {
            background: #10b981;
            color: white;
        }

        .installment-unpaid {
            background: #ef4444;
            color: white;
        }

        .installment-partial {
            background: #f59e0b;
            color: white;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
            }

            .no-print {
                display: none !important;
            }

            .print-section {
                page-break-after: always;
            }
        }

        .payment-modal .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .payment-modal .modal-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border-radius: 0;
            padding: 25px;
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        }

        .installments-section {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 15px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .installment-item:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .installment-item.paid {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .installment-item.partial {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .installment-item.unpaid {
            border-color: #ef4444;
            background: #fef2f2;
        }

        /* Notification Bell */
        .notification-bell {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .notification-bell:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Chat Button */
        .chat-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .chat-button:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 90px;
            left: 20px;
            width: 350px;
            max-height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9998;
            display: none;
            overflow: hidden;
            border: 2px solid #0f766e;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-right: 4px solid;
            cursor: pointer;
        }
        .notification-item.unread {
            background: #f0fdf4;
            border-right-color: #10b981;
        }
        .notification-item.read {
            background: #f9fafb;
            border-right-color: #cbd5e0;
        }

        /* Chat Panel */
        .chat-panel {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9998;
            display: none;
            flex-direction: column;
            border: 2px solid #0f766e;
        }
        .chat-panel.show {
            display: flex;
        }
        .chat-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 13px 13px 0 0;
        }
        .chat-status {
            font-size: 11px;
            opacity: 0.9;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f9fafb;
        }
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .chat-message.sent {
            align-items: flex-end;
        }
        .chat-message.received {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 5px;
        }
        .message-bubble.sent {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }
        .message-bubble.received {
            background: #e5e7eb;
            color: #1f2937;
        }
        .message-sender {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        .message-time {
            font-size: 10px;
            color: #9ca3af;
        }
        .chat-input-container {
            padding: 15px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            border-radius: 0 0 13px 13px;
        }
        .chat-input-container select {
            width: 150px;
        }
        .chat-input-container input {
            flex: 1;
        }
        
    </style>
</head>
<body>
    <!-- Notification Bell Button (Top Right) -->
    <button id="notificationBtn" class="notification-bell" style="display: none;">
        <i class="bi bi-bell"></i>
        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
    </button>

    <!-- Chat Button (Floating) -->
    <button id="chatBtn" class="chat-button" style="display: none;">
        <i class="bi bi-chat-dots"></i>
        <span id="chatBadge" class="chat-badge" style="display: none;">0</span>
    </button>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel">
        <div class="notification-header">
            <h6>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h6>
            <button class="close-notifications" onclick="closeNotifications()"><i class="bi bi-x"></i></button>
        </div>
        <div id="notificationList" class="notification-list"></div>
    </div>

    <!-- Chat Panel -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <div>
                <h6>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h6>
                <small id="chatStatus" class="chat-status">Ù…ØªØµÙ„</small>
            </div>
            <button class="close-chat" onclick="closeChat()"><i class="bi bi-x"></i></button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <select id="chatReceiver" class="form-select form-select-sm"></select>
            <input type="text" id="chatInput" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
            <button onclick="sendMessage()" class="btn btn-primary btn-sm">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #6b7d3d 0%, #8b945c 100%); border-radius: 15px 15px 0 0; color: white; border: none; padding: 15px 20px;">
                    <h5 class="modal-title" style="width: 100%; text-align: center; font-size: 1.2rem; margin: 0;">
                        <i class="bi bi-person-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </h5>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                        <select id="loginSchool" class="form-select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© --</option>
                            <option value="admin">Ø±Ø¦ÙŠØ³ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ( Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ )</option>
                            <option value="rawda">Ø±ÙˆØ¶Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                            <option value="rasoul">Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                            <option value="noor">Ù…Ø¯Ø±Ø³Ø© Ù†ÙˆØ± Ø§Ù„Ø±Ø­Ù…Ø©</option>
                            <option value="nabi">Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨ÙŠ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                            <option value="thanawiya">Ø«Ø§Ù†ÙˆÙŠØ© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                        </select>
                    </div>
                    <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                    <button onclick="authenticateUser()" class="btn btn-primary-custom btn-custom w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Ø¯Ø®ÙˆÙ„
                    </button>
                    
                    <div class="mt-3 p-2" style="background: #f8f9fa; border-radius: 8px; font-size: 0.8rem;">
                        <strong class="mb-1" style="font-size: 0.85rem;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:</strong>
                        <small class="text-muted" style="display: block; font-size: 0.75rem;">
                            <strong>Ø§Ù„Ù…Ø¯ÙŠØ±:</strong> admin / master123<br>
                            <strong>Ø±ÙˆØ¶Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©:</strong> rawda / rawda123<br>
                            <strong>Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©:</strong> rasoul / rasoul123<br>
                            <strong>Ù…Ø¯Ø±Ø³Ø© Ù†ÙˆØ± Ø§Ù„Ø±Ø­Ù…Ø©:</strong> noor / noor123<br>
                            <strong>Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨ÙŠ Ø§Ù„Ø±Ø­Ù…Ø©:</strong> nabi / nabi123<br>
                            <strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©:</strong> thanawiya123 / thanawiya123
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="sidebar-header">
            <h2><i class="bi bi-mortarboard"></i> Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</h2>
            <p id="sidebarSchoolName">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</p>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" onclick="switchMainTab('students')">
                <span class="nav-icon"><i class="bi bi-people"></i></span>
                <span class="nav-text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('schools')" id="schoolsTabNav" style="display: none;">
                <span class="nav-icon"><i class="bi bi-building"></i></span>
                <span class="nav-text">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('users')" id="usersTabNav" style="display: none;">
                <span class="nav-icon"><i class="bi bi-shield-lock"></i></span>
                <span class="nav-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('settings')">
                <span class="nav-icon"><i class="bi bi-gear"></i></span>
                <span class="nav-text">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info-sidebar" id="sidebarUserInfo">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
            <div class="date-info-sidebar" id="sidebarDateTime"></div>
        </div>
    </div>

    <div class="main-container" id="mainContent" style="display: none;">
        <div class="header-section" style="position: relative;">
            <button onclick="logout()" class="btn btn-light no-print" style="position: absolute; left: 20px; top: 20px; border: none; border-radius: 10px; padding: 10px 20px; font-weight: bold;">
                <i class="bi bi-box-arrow-right"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
            </button>
            <h1><i class="bi bi-mortarboard"></i> Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h1>
            <h3 id="schoolName">Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</h3>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</p>
        </div>

        <div class="content-section">
            <!-- Tab Content: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
            <div id="studentsTab" class="main-tab-content active">
            <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) -->
            <div id="schoolTabsContainer" class="mb-4" style="display: none;">
                <ul class="nav nav-tabs" id="schoolTabs" role="tablist" style="border-bottom: 3px solid #0f766e;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-schools-tab" data-bs-toggle="tab" data-bs-target="#all-schools" type="button" role="tab" onclick="filterBySchool('all')">
                            <i class="bi bi-building"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                        </button>
                    </li>
                </ul>
            </div>

            <!-- ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ -->
            <div class="card-custom no-print mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel"></i> ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ:</label>
                            <select class="form-select" id="gradeFilter" onchange="filterByGrade()">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel-fill"></i> ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                            <select class="form-select" id="statusFilter" onchange="filterByStatus()">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="paid">Ù…Ø³Ø¯Ø¯</option>
                                <option value="partial">Ø¬Ø²Ø¦ÙŠ</option>
                                <option value="unpaid">ØºÙŠØ± Ù…Ø³Ø¯Ø¯</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            <button onclick="clearFilters()" class="btn btn-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
                            </button>
                            <span id="filterInfo" class="badge bg-info ms-2" style="display: none;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stats-box">
                        <h3><i class="bi bi-people"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <p id="totalStudents">0</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
                        <h3><i class="bi bi-cash-stack"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h3>
                        <p id="totalFees">0 Ø¯.Ø¹</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <h3><i class="bi bi-check-circle"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h3>
                        <p id="totalPaid">0 Ø¯.Ø¹</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                        <h3><i class="bi bi-clock"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>
                        <p id="totalRemaining">0 Ø¯.Ø¹</p>
                    </div>
                </div>
            </div>

            <!-- Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
            <div class="card-custom no-print">
                <div class="card-header-custom">
                    <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                </div>
                <div class="card-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="studentName" required>
                                <small class="text-muted">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="guardianName" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø£Ù… <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="motherName" required>
                                <small class="text-muted">Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø®ÙˆØ©</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Ø§Ù„ØµÙ <span class="text-danger">*</span></label>
                                <select class="form-select" id="grade" required>
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row" id="adminSchoolRow" style="display: none;">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© <span class="text-danger">*</span></label>
                                <select class="form-select" id="adminSchoolSelect">
                                    <option value="rawda">Ø±ÙˆØ¶Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                    <option value="rasoul">Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                    <option value="noor">Ù…Ø¯Ø±Ø³Ø© Ù†ÙˆØ± Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                    <option value="nabi">Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨ÙŠ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                    <option value="thanawiya">Ø«Ø§Ù†ÙˆÙŠØ© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ</label>
                                <input type="number" class="form-control" id="annualFee" value="1200000" min="0" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Ø¥Ø®ÙˆØ© (Ø®ØµÙ… 5%)</label>
                                <select class="form-select" id="hasSibling" onchange="checkSiblingDiscount()">
                                    <option value="no">Ù„Ø§</option>
                                    <option value="yes">Ù†Ø¹Ù…</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="phone" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label>
                                <input type="date" class="form-control" id="registrationDate" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <input type="text" class="form-control" id="notes">
                            </div>
                        </div>
                        <div id="siblingAlert" class="alert alert-warning mt-3" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø®ÙˆØ© Ù…Ù† Ø¹Ø¯Ø© Ù…Ø¯Ø§Ø±Ø³:<br><br>
                            <div id="siblingNames" style="margin-right: 30px;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary-custom btn-custom">
                            <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨
                        </button>
                    </form>
                </div>
            </div>

            <!-- Ø¨Ø­Ø« -->
            <div class="card-custom no-print">
                <div class="card-header-custom">
                    <i class="bi bi-search"></i> Ø§Ù„Ø¨Ø­Ø«
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <input type="text" class="form-control" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„..." onkeyup="filterStudents()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="bi bi-list-ul"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Ù…</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th id="schoolNameHeader" style="display: none;">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                                    <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th>Ø§Ù„ØµÙ</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                                    <th>Ø§Ù„Ø¯ÙÙØ¹Ø§Øª</th>
                                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th>Ø§Ù„Ø®ØµÙ…</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable">
                                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù€ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© -->
            <div class="text-center no-print mt-4">
                <button onclick="printList()" class="btn btn-info-custom btn-custom me-2">
                    <i class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                </button>
                <button onclick="exportData()" class="btn btn-success-custom btn-custom me-2">
                    <i class="bi bi-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button onclick="sendBulkWhatsAppReminders()" class="btn btn-custom me-2" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;" title="Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†">
                    ğŸ“± Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©
                </button>
            </div>
            </div>
            <!-- End Tab Content: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->

            <!-- Tab Content: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ -->
            <div id="schoolsTab" class="main-tab-content" style="display: none;">
                <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                <div class="card-custom mb-3">
                    <div class="card-header-custom" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">
                        <i class="bi bi-speedometer2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="stats-icon"><i class="bi bi-building"></i></div>
                                    <div class="stats-value" id="totalSchoolsCount">0</div>
                                    <div class="stats-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="stats-icon"><i class="bi bi-people"></i></div>
                                    <div class="stats-value" id="totalStudentsCount">0</div>
                                    <div class="stats-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="stats-icon"><i class="bi bi-cash-stack"></i></div>
                                    <div class="stats-value" id="totalFeesAmount">0</div>
                                    <div class="stats-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <div class="stats-icon"><i class="bi bi-percent"></i></div>
                                    <div class="stats-value" id="overallPaymentRate">0%</div>
                                    <div class="stats-label">Ù…ØªÙˆØ³Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-pie-chart"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                                    </div>
                                    <div class="card-body">
                                        <canvas id="studentsDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-bar-chart"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø©
                                    </div>
                                    <div class="card-body">
                                        <canvas id="paymentRateChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
                <div class="card-custom">
                    <div class="card-header-custom" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">
                        <i class="bi bi-building"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ - Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø©
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('students')">
                                        <i class="bi bi-sort-numeric-down"></i> ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('payment')">
                                        <i class="bi bi-sort-alpha-down"></i> ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('fees')">
                                        <i class="bi bi-sort-amount-down"></i> ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="exportSchoolsReport()">
                                        <i class="bi bi-file-earmark-excel"></i> ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="schoolsStatsContainer" class="row mb-4"></div>
                        <div id="schoolsListContainer"></div>
                    </div>
                </div>
            </div>
            <!-- End Tab Content: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ -->

            <!-- Tab Content: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div id="usersTab" class="main-tab-content" style="display: none;">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <i class="bi bi-shield-lock"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button onclick="openAddUserModal()" class="btn btn-primary-custom btn-custom">
                                    <i class="bi bi-person-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                                </button>
                                <button onclick="loadUsers()" class="btn btn-secondary btn-custom">
                                    <i class="bi bi-arrow-clockwise"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ù…</th>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                        <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                                        <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù€ JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Tab Content: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->

            <!-- Tab Content: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="settingsTab" class="main-tab-content" style="display: none;">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <i class="bi bi-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-cash-coin"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h5>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-book"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</label>
                                    <input type="number" class="form-control" id="elementaryFee" value="1100000" step="10000">
                                    <small class="text-muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: 1,100,000 Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-mortarboard"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</label>
                                    <input type="number" class="form-control" id="middleFee" value="1300000" step="10000">
                                    <small class="text-muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: 1,300,000 Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-calendar-check"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</label>
                                    <input type="number" class="form-control" id="installmentCount" value="4" min="1" max="12">
                                    <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</small>
                                </div>
                                <button onclick="saveFeeSettings()" class="btn btn-primary-custom btn-custom w-100">
                                    <i class="bi bi-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-graph-up"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h5>
                                <button onclick="generateMonthlyReport()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-file-earmark-text"></i> ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ
                </button>
                                <button onclick="generateYearlyReport()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-calendar-year"></i> ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ
                                </button>
                                <button onclick="exportToExcel()" class="btn btn-success-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                                </button>
                                <button onclick="exportToPDF()" class="btn btn-danger-custom btn-custom w-100">
                                    <i class="bi bi-file-pdf"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
                </button>
            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-bell"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</h5>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="autoWhatsApp" class="form-check-input me-2">
                                        Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="reminderWhatsApp" class="form-check-input me-2">
                                        Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
                                    <input type="number" class="form-control" id="reminderDays" value="7" min="1">
                                </div>
                                <button onclick="saveWhatsAppSettings()" class="btn btn-primary-custom btn-custom">
                                    <i class="bi bi-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-database"></i> Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                                <button onclick="backupData()" class="btn btn-warning btn-custom w-100 mb-2">
                                    <i class="bi bi-cloud-upload"></i> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                                </button>
                                <button onclick="restoreData()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-cloud-download"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                </button>
                                <button onclick="clearCache()" class="btn btn-secondary btn-custom w-100">
                                    <i class="bi bi-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Tab Content: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        </div>
    </div>

    <!-- Modal Ù„Ù„Ø¯ÙØ¹ -->
    <div class="modal fade payment-modal" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="studentIdForPayment">
                        <input type="hidden" id="installmentIndex">
                        
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                            <input type="text" class="form-control" id="modalStudentName" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙØ¹Ø©</label>
                            <select class="form-select" id="selectedInstallment" onchange="updatePaymentDetails()">
                                <option value="-1">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙØ¹Ø©...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯ÙØ¹Ù‡</label>
                            <input type="number" class="form-control" id="paymentAmount" min="0" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                            <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                            <div class="col-md-6 mb-3">
                            <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
                                <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                            </select>
                        </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                        </div>
                        
                        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
                        <div class="installments-section">
                            <h6 class="mb-3"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª:</strong></h6>
                            <div id="installmentsList"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" onclick="printCurrentPayment()">
                        <i class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary-custom btn-custom" onclick="processPayment()">
                        <i class="bi bi-check-circle"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentDetailsContent">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù€ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                                <input type="text" class="form-control" id="editStudentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                                <input type="text" class="form-control" id="editGuardianName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø£Ù…</label>
                                <input type="text" class="form-control" id="editMotherName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ù„ØµÙ</label>
                                <select class="form-select" id="editGrade" required>
                                    <option value="Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·">Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·">Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù…ØªÙˆØ³Ø·">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù…ØªÙˆØ³Ø·</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ</label>
                                <input type="number" class="form-control" id="editAnnualFee" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø¥Ø®ÙˆØ© (Ø®ØµÙ… 5%)</label>
                                <select class="form-select" id="editHasSibling">
                                    <option value="no">Ù„Ø§</option>
                                    <option value="yes">Ù†Ø¹Ù…</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="text" class="form-control" id="editPhone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <input type="text" class="form-control" id="editNotes">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-warning" onclick="saveEditedStudent()">
                        <i class="bi bi-check"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© <span class="text-danger">*</span></label>
                            <select class="form-select" id="userSchool" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© --</option>
                                <option value="rawda">Ø±ÙˆØ¶Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                <option value="rasoul">Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                <option value="noor">Ù…Ø¯Ø±Ø³Ø© Ù†ÙˆØ± Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                <option value="nabi">Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨ÙŠ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                                <option value="thanawiya">Ø«Ø§Ù†ÙˆÙŠØ© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <select class="form-select" id="userType">
                                <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="school_admin">Ù…Ø¯ÙŠØ± Ù…Ø¯Ø±Ø³Ø©</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveNewUser()">
                        <i class="bi bi-check"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
        window.initSupabase = function() {
            if (typeof supabase !== 'undefined') {
                const supabaseUrl = 'https://vpvvjascwgivdjyyhzwp.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnZqYXNjd2dpdmRqeXloendwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDYxMjYsImV4cCI6MjA2NTM4MjEyNn0.6AR2-MG4x9ugNTXe9jUqx-IwGEtj1m6MCYwQkTsSbUQ';
                const { createClient } = supabase;
                window.supabaseClient = createClient(supabaseUrl, supabaseKey);
                console.log('Supabase initialized successfully');
            } else {
                console.error('Supabase failed to load');
                // Retry after a delay
                setTimeout(function() {
                    if (typeof supabase !== 'undefined') {
                        const supabaseUrl = 'https://vpvvjascwgivdjyyhzwp.supabase.co';
                        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnZqYXNjd2dpdmRqeXloendwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDYxMjYsImV4cCI6MjA2NTM4MjEyNn0.6AR2-MG4x9ugNTXe9jUqx-IwGEtj1m6MCYwQkTsSbUQ';
                        const { createClient } = supabase;
                        window.supabaseClient = createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase initialized successfully (retry)');
                    }
                }, 500);
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js" onload="initSupabase()"></script>
    <script>
        
        // Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        const ANNUAL_FEE = 1200000; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ
        const QUARTERLY_INSTALLMENT = 300000; // ÙƒÙ„ Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©
        const INSTALLMENT_COUNT = 4; // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        // Ø­Ø³Ø§Ø¨ Ø®ØµÙ… Ø§Ù„Ø£Ø®ÙˆØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
        function calculateSiblingDiscount(siblingCount) {
            if (siblingCount >= 3) {
                return 0.10; // Ø®ØµÙ… 10% Ù„Ù€ 3 Ø£Ø®ÙˆØ© Ø£Ùˆ Ø£ÙƒØ«Ø±
            } else if (siblingCount === 2) {
                return 0.05; // Ø®ØµÙ… 5% Ù„Ù€ 2 Ø£Ø®ÙˆØ©
            }
            return 0; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ…
        }

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
        const schools = {
            rawda: { name: 'Ø±ÙˆØ¶Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©', id: 'rawda' },
            rasoul: { name: 'Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©', id: 'rasoul' },
            noor: { name: 'Ù…Ø¯Ø±Ø³Ø© Ù†ÙˆØ± Ø§Ù„Ø±Ø­Ù…Ø©', id: 'noor' },
            nabi: { name: 'Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨ÙŠ Ø§Ù„Ø±Ø­Ù…Ø©', id: 'nabi' },
            thanawiya: { name: 'Ø«Ø§Ù†ÙˆÙŠØ© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©', id: 'thanawiya' }
        };

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±
        const adminUser = { username: 'admin', password: 'master123' };

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
        let students = [];
        let allStudents = []; // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ù„ÙÙ„ØªØ±Ø©)
        let receiptCounter = 1;
        let currentSchool = null;
        let currentSchoolId = null;
        let currentSchoolName = null;
        let isAdmin = false;
        let currentFilter = {
            school: 'all',
            grade: 'all',
            status: 'all'
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        async function authenticateUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const schoolId = document.getElementById('loginSchool').value;
            const errorDiv = document.getElementById('loginError');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±
            if (schoolId === 'admin') {
                if (username === adminUser.username && password === adminUser.password) {
                    isAdmin = true;
                    currentSchool = null;
                    document.getElementById('schoolName').textContent = 'Ø±Ø¦ÙŠØ³ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                    
                    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    localStorage.setItem('currentLogin', JSON.stringify({
                        username: username,
                        password: password,
                        schoolId: 'admin'
                    }));
                    
                    // Ø¥Ø®ÙØ§Ø¡ modal ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    loginModal.hide();
                    
                    document.getElementById('mainContent').style.display = 'block';
                    
                    document.getElementById('adminSchoolRow').style.display = 'block';
                    document.getElementById('schoolNameHeader').style.display = 'table-cell';
                    
                    document.getElementById('userManagementBtn').style.display = 'inline-block';
                    document.getElementById('userManagementSection').style.display = 'block';
                    
                    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
                    document.getElementById('registrationDate').valueAsDate = new Date();
                    document.getElementById('paymentDate').valueAsDate = new Date();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                    updateGradesForCurrentSchool();
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                    loadData().then(() => {
                        setupSchoolTabs(); // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                        updateGradeFilter(); // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
            renderTable();
                        updateStats();
                        loadUsers(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±
                    });
                    
                    return;
                } else {
                    errorDiv.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø¯ÙŠØ±';
                    errorDiv.style.display = 'block';
                    return;
                }
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            if (!schoolId || schoolId === 'admin') {
                errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
                errorDiv.style.display = 'block';
                return;
            }

            if (!username || !password) {
                errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                errorDiv.style.display = 'block';
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
            let userFound = false;
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                const { data: schoolData, error: schoolError } = await window.supabaseClient
                    .from('schools')
                    .select('id')
                    .eq('code', schoolId)
                    .single();

                if (schoolData && !schoolError) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const { data: userData, error: userError } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .eq('school_id', schoolData.id)
                        .eq('is_active', true)
                        .maybeSingle();

                    if (userData && !userError) {
                        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', userData);
                        if (userData.password === password) {
                            userFound = true;
                            console.log('Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù†Ø§Ø¬Ø­Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        } else {
                            console.log('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                        }
                    } else {
                        console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØºÙŠØ± Ù†Ø´Ø·');
                    }
                }
            } catch (error) {
                console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!userFound) {
                errorDiv.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                errorDiv.style.display = 'block';
                return;
            }

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
            currentSchool = schools[schoolId];
            currentSchoolId = currentSchool.id;
            currentSchoolName = currentSchool.name;
            isAdmin = false;
            
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            localStorage.setItem('currentLogin', JSON.stringify({
                username: username,
                password: password,
                schoolId: schoolId
            }));
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            const schoolNameElement = document.getElementById('schoolName');
            if (schoolNameElement) {
                schoolNameElement.textContent = currentSchool.name;
            }
            
            // Ø¥Ø®ÙØ§Ø¡ modal ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            loginModal.hide();
            
            document.getElementById('mainContent').style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
            document.getElementById('schoolsTabNav').style.display = 'none';
            document.getElementById('usersTabNav').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Sidebar
            document.getElementById('sidebar').style.display = 'flex';
            updateSidebarInfo();
            startDateTimeUpdate();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            loadData().then(() => {
                updateGradeFilter(); // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
                renderTable();
                updateStats();
                initChatSystem(); // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            });
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            document.getElementById('registrationDate').valueAsDate = new Date();
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            updateGradesForCurrentSchool();
        }


        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø§Ø¨Ù‚
            const savedLogin = localStorage.getItem('currentLogin');
            if (savedLogin) {
                try {
                    const loginData = JSON.parse(savedLogin);
                    const { username, password, schoolId } = loginData;
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    if (schoolId === 'admin') {
                        currentSchool = null;
                        isAdmin = true;
                        document.getElementById('schoolName').textContent = 'Ø±Ø¦ÙŠØ³ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                        document.getElementById('mainContent').style.display = 'block';
                        document.getElementById('adminSchoolRow').style.display = 'block';
                        document.getElementById('schoolNameHeader').style.display = 'table-cell';
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¯ÙŠØ±
                    document.getElementById('schoolsTabNav').style.display = 'block';
                    document.getElementById('usersTabNav').style.display = 'block';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Sidebar
                    document.getElementById('sidebar').style.display = 'flex';
                    updateSidebarInfo();
                    startDateTimeUpdate();
                        
                        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        loadData().then(() => {
                        setupSchoolTabs(); // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                        updateGradeFilter(); // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
                            renderTable();
                            updateStats();
                            loadUsers(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        loadSchoolsStats(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                        });
                    } else {
                        const school = schools[schoolId];
                        if (school) {
                            currentSchool = school;
                            currentSchoolId = school.id;
                            currentSchoolName = school.name;
                            isAdmin = false;
                            document.getElementById('schoolName').textContent = school.name;
                            document.getElementById('mainContent').style.display = 'block';
                            
                            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            loadData().then(() => {
                                updateGradeFilter(); // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
                                renderTable();
                                updateStats();
                                initChatSystem(); // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                            });
                        } else {
                            showLoginModal();
                        }
                    }
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', e);
                    showLoginModal();
                }
            } else {
                showLoginModal();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('loginModal').addEventListener('hidden.bs.modal', function() {
                if (!currentSchool && !isAdmin) {
                    location.reload();
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ù…
            document.getElementById('motherName').addEventListener('input', function() {
                checkSiblingDiscount();
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø­Ù‚Ù„ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
            document.getElementById('guardianName').addEventListener('input', function() {
                checkSiblingDiscount();
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            document.getElementById('adminSchoolSelect').addEventListener('change', function() {
                updateGradesForSchool(this.value);
            });
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        function updateGradesForSchool(schoolId) {
            const gradeSelect = document.getElementById('grade');
            gradeSelect.innerHTML = '';
            
            const grades = {
                'rawda': ['Ø±ÙˆØ¶Ø©'],
                'rasoul': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                'noor': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                'nabi': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                'thanawiya': ['Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·']
            };
            
            const schoolGrades = grades[schoolId] || grades['rasoul'];
            
            schoolGrades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        function updateGradesForCurrentSchool() {
            if (isAdmin) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const adminSelect = document.getElementById('adminSchoolSelect');
                if (adminSelect && adminSelect.value) {
                    updateGradesForSchool(adminSelect.value);
                } else if (adminSelect) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø© Ù…Ø­Ø¯Ø¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆÙ„
                    updateGradesForSchool('rasoul');
                }
            } else if (currentSchool) {
                updateGradesForSchool(currentSchool.id);
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const annualFee = parseFloat(document.getElementById('annualFee').value);
                const hasSibling = document.getElementById('hasSibling').value === 'yes';
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø·Ø§Ù„Ø¨
                let selectedSchoolId = null;
                if (isAdmin) {
                    selectedSchoolId = document.getElementById('adminSchoolSelect').value;
                } else if (currentSchool) {
                    selectedSchoolId = currentSchool.id;
                }
                
                if (!selectedSchoolId) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©');
                    return;
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ school_id Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { data: schoolData, error: schoolError } = await window.supabaseClient
                    .from('schools')
                    .select('id')
                    .eq('code', selectedSchoolId)
                    .single();
                
                if (schoolError) throw schoolError;
                if (!schoolData) {
                    alert('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                let finalFee = annualFee;
                let discountAmount = 0;
                
                if (hasSibling) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®ÙˆØ©
                    const motherName = document.getElementById('motherName').value.trim();
                    const guardianName = document.getElementById('guardianName').value.trim();
                    let siblingsCount = 1; // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    
                    if (motherName && guardianName) {
                        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù† Ø§Ù„Ø£Ø®ÙˆØ©
                        try {
                            const { data: siblingsData } = await window.supabaseClient
                                .from('students')
                                .select('id')
                                .ilike('mother_name', motherName)
                                .ilike('guardian', guardianName);
                            
                            if (siblingsData) {
                                siblingsCount = siblingsData.length + 1;
                            }
                        } catch (error) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø®ÙˆØ©:', error);
                        }
                    }
                    
                    const discountRate = calculateSiblingDiscount(siblingsCount);
                    discountAmount = annualFee * discountRate;
                    finalFee = annualFee - discountAmount;
                }
                
                // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { data: studentData, error: studentError } = await window.supabaseClient
                    .from('students')
                    .insert({
                        school_id: schoolData.id,
                        receipt_number: String(receiptCounter++).padStart(6, '0'),
                name: document.getElementById('studentName').value,
                        mother_name: document.getElementById('motherName').value,
                guardian: document.getElementById('guardianName').value,
                grade: document.getElementById('grade').value,
                phone: document.getElementById('phone').value,
                        annual_fee: annualFee,
                        final_fee: finalFee,
                        discount: discountAmount,
                        has_sibling: hasSibling,
                        registration_date: document.getElementById('registrationDate').value,
                        notes: document.getElementById('notes').value
                    })
                    .select()
                    .single();
                
                if (studentError) throw studentError;
                
                // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
                const installments = [];
                for (let i = 1; i <= 4; i++) {
                    const { data: instData, error: instError } = await window.supabaseClient
                        .from('installments')
                        .insert({
                            student_id: studentData.id,
                            installment_number: i,
                            amount_paid: 0,
                            status: 'unpaid'
                        })
                        .select()
                        .single();
                    
                    if (instError) throw instError;
                    installments.push(instData);
                }
                
                studentData.installments = installments;
                students.push(studentData);
                allStudents.push(studentData); // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                
                // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
                updateGradeFilter();
                
            renderTable();
            updateStats();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('addStudentForm').reset();
                document.getElementById('annualFee').value = ANNUAL_FEE;
            document.getElementById('registrationDate').valueAsDate = new Date();
            
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨: ' + error.message);
            }
        });

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
        function getField(student, camelName, snakeName) {
            return student[camelName] || student[snakeName];
        }
        
        function getStudentField(student, field) {
            const snakeField = field.replace(/([A-Z])/g, '_$1').toLowerCase();
            return getField(student, field, snakeField);
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„ÙƒÙ„ Ø¯ÙØ¹Ø©
        function calculateInstallmentAmount(student) {
            const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
            return finalFee / INSTALLMENT_COUNT;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø®ÙˆØ© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function checkSiblingDiscount() {
            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Supabase
            if (!window.supabaseClient) {
                await new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (window.supabaseClient) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => clearInterval(checkInterval), 5000);
                });
            }
            
            const motherName = document.getElementById('motherName').value.trim();
            const guardianName = document.getElementById('guardianName').value.trim();
            const alertDiv = document.getElementById('siblingAlert');
            const siblingNamesSpan = document.getElementById('siblingNames');
            
            if (!motherName || !guardianName) {
                alertDiv.style.display = 'none';
                return;
            }
            
            try {
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù† Ø·Ù„Ø§Ø¨ Ù„Ø¯ÙŠÙ‡Ù… Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ø£Ù… ÙˆÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                const { data: siblingsData, error } = await window.supabaseClient
                    .from('students')
                    .select(`
                        id, 
                        name, 
                        mother_name, 
                        grade, 
                        guardian,
                        schools!inner(name)
                    `)
                    .ilike('mother_name', motherName)
                    .ilike('guardian', guardianName)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… Supabase:', error);
                    throw error;
                }
                
                if (siblingsData && siblingsData.length > 0) {
                    console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø®ÙˆØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', siblingsData); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø®ÙˆØ© Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ù„ØµÙ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø³Ù‚
                    const siblingsList = siblingsData.map(s => {
                        const schoolName = s.schools?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        const grade = s.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        return `<div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-right: 4px solid #f59e0b; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="font-weight: bold; color: #856404; margin-bottom: 5px; font-size: 1.1em;">
                                        ğŸ‘¤ ${s.name}
                                    </div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.6;">
                                        <span>ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <strong>${schoolName}</strong></span><br>
                                        <span>ğŸ“š Ø§Ù„ØµÙ: <strong>${grade}</strong></span><br>
                                        <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${s.guardian || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    </div>
                                </div>`;
                    }).join('');
                    
                    siblingNamesSpan.innerHTML = siblingsList;
                    alertDiv.style.display = 'block';
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®ÙˆØ©
                    const confirmationMessage = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${siblingsData.length} Ø£Ø®/Ø£Ø®Øª Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…:\n\n` +
                        siblingsData.map(s => {
                            const schoolName = s.schools?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                            const grade = s.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                            return `ğŸ“Œ Ø§Ù„Ø§Ø³Ù…: ${s.name}\n   ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${schoolName}\n   ğŸ“š Ø§Ù„ØµÙ: ${grade}\n   ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${s.guardian || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                        }).join('\n\n') +
                        `\n\nØ³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… ${siblingsData.length + 1 >= 3 ? '10%' : '5%'} Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø®ÙˆØ© (${siblingsData.length + 1} Ø£Ø®/Ø£Ø®Øª)!\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø£Ù†Ù‡Ù… Ø¥Ø®ÙˆØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø®ÙˆØ©
                    if (document.getElementById('hasSibling').value === 'no') {
                        if (confirm(confirmationMessage)) {
                            document.getElementById('hasSibling').value = 'yes';
                            
                            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
                            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø£Ø®ÙˆØ© (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† + Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
                            const totalSiblingsCount = siblingsData.length + 1;
                            const discountRate = calculateSiblingDiscount(totalSiblingsCount);
                            
                            const updatePromises = siblingsData.map(async (sibling) => {
                                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                                const siblingAnnualFee = sibling.annual_fee || sibling.annualFee || 1200000;
                                const discount = siblingAnnualFee * discountRate;
                                const finalFee = siblingAnnualFee - discount;
                                
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø® ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                const { error: updateError } = await window.supabaseClient
                                    .from('students')
                                    .update({
                                        has_sibling: true,
                                        discount: discount,
                                        final_fee: finalFee
                                    })
                                    .eq('id', sibling.id);
                                
                                if (updateError) {
                                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø®:', sibling.name, updateError);
            } else {
                                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                                    const localSibling = students.find(s => s.id === sibling.id);
                                    if (localSibling) {
                                        localSibling.has_sibling = true;
                                        localSibling.hasSibling = true;
                                        localSibling.discount = discount;
                                        localSibling.final_fee = finalFee;
                                        localSibling.finalFee = finalFee;
                                    }
                                }
                            });
                            
                            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø®ÙˆØ©
                            await Promise.all(updatePromises);
                            
                            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                            renderTable();
                            updateStats();
                            
                            const totalSiblings = siblingsData.length + 1;
                            const discountPercent = totalSiblings >= 3 ? '10%' : '5%';
                            alert(`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… ${discountPercent} Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø®ÙˆØ© (${totalSiblings} Ø£Ø®/Ø£Ø®Øª)`);
                        }
                    }
            } else {
                    alertDiv.style.display = 'none';
            }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®ÙˆØ©:', error);
                alertDiv.style.display = 'none';
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        function getFinancialStatus(student) {
            if (!student.installments || !Array.isArray(student.installments)) {
                return { status: 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯', class: 'danger' };
            }
            
            const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const finalFee = getStudentField(student, 'finalFee');
            const annualFee = getStudentField(student, 'annualFee');
            const remaining = (finalFee || annualFee || 1200000) - totalPaid;
            
            if (remaining <= 0) {
                return { status: 'Ù…Ø³Ø¯Ø¯', class: 'success' };
            } else if (totalPaid > 0) {
                return { status: 'Ø¬Ø²Ø¦ÙŠ', class: 'warning' };
            } else {
                return { status: 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯', class: 'danger' };
            }
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
        function applyFilters() {
            let filtered = [...allStudents];
            
            // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            if (currentFilter.school !== 'all') {
                filtered = filtered.filter(s => {
                    const schoolId = s.schoolId || s.school_id || '';
                    return schoolId === currentFilter.school;
                });
            }
            
            // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ
            if (currentFilter.grade !== 'all') {
                filtered = filtered.filter(s => s.grade === currentFilter.grade);
            }
            
            // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (currentFilter.status !== 'all') {
                const statusMap = {
                    'paid': 'Ù…Ø³Ø¯Ø¯',
                    'partial': 'Ø¬Ø²Ø¦ÙŠ',
                    'unpaid': 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯'
                };
                const targetStatus = statusMap[currentFilter.status];
                filtered = filtered.filter(s => {
                    const statusInfo = getFinancialStatus(s);
                    return statusInfo.status === targetStatus;
                });
            }
            
            students = filtered;
            renderTable();
            updateStats();
            updateFilterInfo();
        }
        
        // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        function filterBySchool(schoolId) {
            currentFilter.school = schoolId;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
            if (isAdmin) {
                const tabsList = document.getElementById('schoolTabs');
                if (tabsList) {
                    tabsList.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    
                    const activeTab = schoolId === 'all' 
                        ? document.getElementById('all-schools-tab')
                        : document.getElementById(`${schoolId}-tab`);
                    
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                }
            }
            
            applyFilters();
        }
        
        // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ
        function filterByGrade() {
            const grade = document.getElementById('gradeFilter').value;
            currentFilter.grade = grade;
            applyFilters();
        }
        
        // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
        function filterByStatus() {
            const status = document.getElementById('statusFilter').value;
            currentFilter.status = status;
            applyFilters();
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
        function clearFilters() {
            currentFilter = {
                school: 'all',
                grade: 'all',
                status: 'all'
            };
            
            document.getElementById('gradeFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³"
            if (isAdmin) {
                document.getElementById('all-schools-tab').click();
            }
            
            applyFilters();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙ„ØªØ±
        function updateFilterInfo() {
            const info = document.getElementById('filterInfo');
            const activeFilters = [];
            
            if (currentFilter.school !== 'all') {
                const school = schools[currentFilter.school];
                if (school) activeFilters.push(`Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${school.name}`);
            }
            if (currentFilter.grade !== 'all') {
                activeFilters.push(`Ø§Ù„ØµÙ: ${currentFilter.grade}`);
            }
            if (currentFilter.status !== 'all') {
                const statusNames = {
                    'paid': 'Ù…Ø³Ø¯Ø¯',
                    'partial': 'Ø¬Ø²Ø¦ÙŠ',
                    'unpaid': 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯'
                };
                activeFilters.push(`Ø§Ù„Ø­Ø§Ù„Ø©: ${statusNames[currentFilter.status]}`);
            }
            
            if (activeFilters.length > 0) {
                info.textContent = `ÙØ¹Ø§Ù„: ${activeFilters.join(' | ')} | Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${students.length}`;
                info.style.display = 'inline-block';
            } else {
                info.style.display = 'none';
            }
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
        function setupSchoolTabs() {
            if (!isAdmin) return;
            
            const tabsContainer = document.getElementById('schoolTabsContainer');
            const tabsList = document.getElementById('schoolTabs');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            tabsContainer.style.display = 'block';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const existingTabs = tabsList.querySelectorAll('.nav-item');
            if (existingTabs.length > 1) {
                // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                return;
            }
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„Ù„Ù…Ø¯Ø§Ø±Ø³
            Object.keys(schools).forEach(schoolId => {
                const school = schools[schoolId];
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.setAttribute('role', 'presentation');
                
                const button = document.createElement('button');
                button.className = 'nav-link';
                button.id = `${schoolId}-tab`;
                button.setAttribute('data-bs-toggle', 'tab');
                button.setAttribute('data-bs-target', `#${schoolId}`);
                button.setAttribute('data-school', schoolId);
                button.setAttribute('type', 'button');
                button.setAttribute('role', 'tab');
                button.onclick = () => filterBySchool(schoolId);
                button.innerHTML = `<i class="bi bi-building"></i> ${school.name}`;
                
                li.appendChild(button);
                tabsList.appendChild(li);
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
        function updateGradeFilter() {
            const gradeFilter = document.getElementById('gradeFilter');
            const currentValue = gradeFilter.value;
            
            // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
            const allGrades = new Set();
            allStudents.forEach(student => {
                if (student.grade) {
                    allGrades.add(student.grade);
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (!isAdmin && currentSchool) {
                const grades = {
                    'rawda': ['Ø±ÙˆØ¶Ø©'],
                    'rasoul': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                    'noor': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                    'nabi': ['Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ'],
                    'thanawiya': ['Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·']
                };
                
                const schoolGrades = grades[currentSchool.id] || [];
                schoolGrades.forEach(grade => allGrades.add(grade));
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ
            const sortedGrades = Array.from(allGrades).sort((a, b) => {
                const order = ['Ø±ÙˆØ¶Ø©', 'Ø§Ù„Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·', 'Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·'];
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            gradeFilter.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>';
            sortedGrades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeFilter.appendChild(option);
            });
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (currentValue && Array.from(gradeFilter.options).some(opt => opt.value === currentValue)) {
                gradeFilter.value = currentValue;
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderTable() {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨: Ø£ÙˆÙ„Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ØºÙŠØ± Ù…Ø³Ø¯Ø¯ Ø£ÙˆÙ„Ø§Ù‹)ØŒ Ø«Ù… Ø­Ø³Ø¨ Ø§Ù„ØµÙØŒ Ø«Ù… Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
            const sortedStudents = [...students].sort((a, b) => {
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                const statusA = getFinancialStatus(a);
                const statusB = getFinancialStatus(b);
                const statusOrder = { 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯': 1, 'Ø¬Ø²Ø¦ÙŠ': 2, 'Ù…Ø³Ø¯Ø¯': 3 };
                const statusDiff = (statusOrder[statusA.status] || 99) - (statusOrder[statusB.status] || 99);
                if (statusDiff !== 0) return statusDiff;
                
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØµÙ
                const gradeOrder = ['Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³', 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³', 
                                   'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†', 'Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±', 'Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±'];
                const gradeA = gradeOrder.indexOf(a.grade || '');
                const gradeB = gradeOrder.indexOf(b.grade || '');
                if (gradeA !== -1 && gradeB !== -1) {
                    if (gradeA !== gradeB) return gradeA - gradeB;
                } else if (a.grade && b.grade) {
                    const gradeDiff = (a.grade || '').localeCompare(b.grade || '', 'ar');
                    if (gradeDiff !== 0) return gradeDiff;
                }
                
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
                return (a.name || '').localeCompare(b.name || '', 'ar');
            });

            sortedStudents.forEach((student, index) => {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments
                if (!student.installments || !Array.isArray(student.installments)) {
                    if (!student.installments) {
                        student.installments = [
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' }
                        ];
                    }
                }
                
                const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee');
                const annualFee = getStudentField(student, 'annualFee');
                const remaining = (finalFee || annualFee || 1200000) - totalPaid;
                const statusInfo = getFinancialStatus(student);
                const installmentAmount = calculateInstallmentAmount(student);
                
                const receiptNumber = getStudentField(student, 'receiptNumber');
                const annualFeeValue = Number(annualFee || finalFee || 1200000);
                const discountValue = Number(getStudentField(student, 'discount') || 0);
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ø®ØµÙ…
                const discountPercent = annualFeeValue > 0 ? ((discountValue / annualFeeValue) * 100).toFixed(0) : 0;
                const discountDisplay = discountValue > 0 ? `${discountValue.toLocaleString('en-US')} Ø¯.Ø¹ (${discountPercent}%)` : '0 Ø¯.Ø¹';

                // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª
                const installmentsHtml = student.installments.map((inst, i) => {
                    const paidAmount = inst.amount_paid || inst.amount || 0;
                    const requiredAmount = installmentAmount;
                    let status = 'unpaid';
                    let badgeClass = 'installment-unpaid';
                    
                    if (paidAmount >= requiredAmount) {
                        status = 'paid';
                        badgeClass = 'installment-paid';
                    } else if (paidAmount > 0) {
                        status = 'partial';
                        badgeClass = 'installment-partial';
                    }
                    
                    const paymentDate = inst.payment_date || inst.paymentDate || '';
                    let dateStr = '';
                    if (paymentDate) {
                        if (paymentDate.includes('-')) {
                            const dateParts = paymentDate.split('-');
                            dateStr = `${dateParts[2]}/${dateParts[1]}`;
                        } else {
                            dateStr = paymentDate;
                        }
                    }
                    
                    return `<span class="installment-badge ${badgeClass}" title="${dateStr ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙÙŠ: ' + dateStr : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©'}">Ø§Ù„Ø¯ÙØ¹Ø© ${i + 1}${dateStr ? '<br><small>' + dateStr + '</small>' : ''}</span>`;
                }).join('');

                const row = document.createElement('tr');
                const schoolNameCell = isAdmin && student.schoolName ? `<td><strong>${student.schoolName}</strong></td>` : '';
                
                // Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù„Ù„ØµÙ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                let rowClass = '';
                if (statusInfo.status === 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯') {
                    rowClass = 'table-warning';
                } else if (statusInfo.status === 'Ø¬Ø²Ø¦ÙŠ') {
                    rowClass = 'table-info';
                } else {
                    rowClass = 'table-success';
                }
                
                row.className = rowClass;
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${receiptNumber || '---'}</strong></td>
                    <td><strong style="cursor: pointer; color: #0f766e;" onclick="showStudentDetails('${student.id}')" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">${student.name}</strong></td>
                    ${schoolNameCell}
                    <td>${student.guardian}</td>
                    <td>${student.grade}</td>
                    <td>${annualFeeValue.toLocaleString('en-US')} Ø¯.Ø¹</td>
                    <td>${installmentsHtml}</td>
                    <td><strong>${remaining.toLocaleString('en-US')} Ø¯.Ø¹</strong></td>
                    <td>${discountDisplay}</td>
                    <td><span class="badge bg-${statusInfo.class} badge-custom">${statusInfo.status}</span></td>
                    <td class="no-print">
                        <button onclick="openPaymentModal('${student.id}')" class="btn btn-success-custom btn-sm">
                            <i class="bi bi-cash-coin"></i> Ø¯ÙØ¹Ø©
                        </button>
                        <button onclick="sendWhatsAppMessage('${student.id}', 'payment')" class="btn btn-sm" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                            ğŸ“± Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹
                        </button>
                        <button onclick="sendWhatsAppMessage('${student.id}', 'reminder')" class="btn btn-sm" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; border: none;" title="Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                            <i class="bi bi-bell"></i> ØªØ°ÙƒÙŠØ±
                        </button>
                        <button onclick="editStudent('${student.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="printReceipt('${student.id}')" class="btn btn-info-custom btn-sm">
                            <i class="bi bi-printer"></i> ÙˆØµÙ„
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="btn btn-danger-custom btn-sm">
                            <i class="bi bi-trash"></i> Ø­Ø°Ù
                        </button>
                    </td>
                `;
                row.setAttribute('data-search', `${student.name} ${student.guardian} ${receiptNumber || ''}`);
                tbody.appendChild(row);
            });
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tr');
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                if (searchText.toLowerCase().includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            
            let totalFees = 0;
            let totalPaid = 0;
            
            students.forEach(student => {
                const finalFee = getStudentField(student, 'finalFee');
                const annualFee = getStudentField(student, 'annualFee');
                const fee = finalFee || annualFee || 1200000;
                totalFees += fee;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                if (student.installments && Array.isArray(student.installments)) {
                    totalPaid += student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                } else if (student.paid) {
                totalPaid += student.paid;
                }
            });
            
            document.getElementById('totalFees').textContent = totalFees.toLocaleString('en-US') + ' Ø¯.Ø¹';
            document.getElementById('totalPaid').textContent = totalPaid.toLocaleString('en-US') + ' Ø¯.Ø¹';
            document.getElementById('totalRemaining').textContent = (totalFees - totalPaid).toLocaleString('en-US') + ' Ø¯.Ø¹';
        }

        // ÙØªØ­ Modal Ø§Ù„Ø¯ÙØ¹
        function openPaymentModal(studentId) {
            console.log('openPaymentModal called with studentId:', studentId);
            const student = students.find(s => s.id === studentId);
            if (!student) {
                console.log('Student not found for ID:', studentId);
                return;
            }
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments
            if (!student.installments || !Array.isArray(student.installments)) {
                alert('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                return;
            }
            
            document.getElementById('studentIdForPayment').value = studentId;
            document.getElementById('modalStudentName').value = student.name;
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª
            const selectInstallment = document.getElementById('selectedInstallment');
            selectInstallment.innerHTML = '<option value="-1">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙØ¹Ø©...</option>';
            
            const installmentAmount = calculateInstallmentAmount(student);
            
            // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            student.installments.forEach((inst, i) => {
                const paidAmount = inst.amount_paid || inst.amount || 0;
                const remainingForInstallment = installmentAmount - paidAmount;
                const option = document.createElement('option');
                option.value = i;
                
                if (remainingForInstallment > 0) {
                    option.textContent = `Ø§Ù„Ø¯ÙØ¹Ø© ${i + 1} - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remainingForInstallment.toLocaleString('en-US')} Ø¯.Ø¹`;
                } else {
                    option.textContent = `Ø§Ù„Ø¯ÙØ¹Ø© ${i + 1} - Ù…ÙƒØªÙ…Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ø¥Ø¶Ø§ÙÙŠ)`;
                }
                
                selectInstallment.appendChild(option);
            });
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª
            updateInstallmentsList(student);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº
            document.getElementById('paymentAmount').max = '';
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        function updatePaymentDetails() {
            const studentId = parseInt(document.getElementById('studentIdForPayment').value);
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments
            if (!student.installments || !Array.isArray(student.installments)) {
                alert('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                return;
            }
            
            const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
            if (selectedIndex === -1) {
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentAmount').max = '';
                return;
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº - ÙŠÙ…ÙƒÙ† Ø¯ÙØ¹ Ø£ÙŠ Ù…Ø¨Ù„Øº
            document.getElementById('paymentAmount').max = '';
        }

        function updateInstallmentsList(student) {
            const listDiv = document.getElementById('installmentsList');
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments
            if (!student.installments || !Array.isArray(student.installments)) {
                listDiv.innerHTML = '<p class="text-danger">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</p>';
                return;
            }
            
            const installmentAmount = calculateInstallmentAmount(student);
            
            let html = '';
            student.installments.forEach((inst, i) => {
                const paid = inst.amount_paid || inst.amount || 0;
                const remaining = installmentAmount - paid;
                let statusClass = 'unpaid';
                
                if (paid >= installmentAmount) {
                    statusClass = 'paid';
                } else if (paid > 0) {
                    statusClass = 'partial';
                }
                
                const paymentDate = inst.payment_date || inst.paymentDate || '';
                let dateStr = '';
                if (paymentDate) {
                    if (paymentDate.includes('-')) {
                        const dateParts = paymentDate.split('-');
                        dateStr = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
                    } else {
                        dateStr = paymentDate;
                    }
                }
                
                html += `
                    <div class="installment-item ${statusClass}">
                        <div>
                            <strong>Ø§Ù„Ø¯ÙØ¹Ø© ${i + 1}:</strong> ${paid.toLocaleString('en-US')} / ${installmentAmount.toLocaleString('en-US')} Ø¯.Ø¹
                            ${remaining > 0 ? `(Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toLocaleString('en-US')} Ø¯.Ø¹)` : '<span class="text-success">âœ“ Ù…ÙƒØªÙ…Ù„Ø©</span>'}
                            ${dateStr ? `<br><small class="text-muted">ğŸ“… ${dateStr}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        function printCurrentPayment() {
            const studentId = document.getElementById('studentIdForPayment').value;
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (isNaN(selectedIndex) || selectedIndex < 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙØ¹Ø©');
                return;
            }
            
            const installments = student.installments || [];
            const installment = installments[selectedIndex];
            
            if (!installment) {
                alert('Ø§Ù„Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return;
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            const paymentAmount = parseFloat(installment.amount_paid || installment.amountPaid || 0);
            
            const installmentNames = ['Ø§Ù„Ø§ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø±Ø§Ø¨Ø¹'];
            const installmentName = installmentNames[selectedIndex] || 'Ø§Ù„Ø§ÙˆÙ„';
            const receiptNumber = getStudentField(student, 'receiptNumber');
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©
            const installmentPaymentDate = installment.payment_date || installment.paymentDate || paymentDate;
            
            let formattedDate = paymentDate;
            if (paymentDate.includes('-')) {
                const dateParts = paymentDate.split('-');
                formattedDate = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
            }
            
            let installmentDateStr = '';
            if (installmentPaymentDate) {
                if (installmentPaymentDate.includes('-')) {
                    const dateParts = installmentPaymentDate.split('-');
                    installmentDateStr = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
                } else {
                    installmentDateStr = installmentPaymentDate;
                }
            }
            
            const receiptHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ÙˆØµÙ„ Ù‚Ø¨Ø¶ - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Arial', 'Segoe UI', sans-serif; padding: 15px; direction: rtl; background: #e5e7eb; }
                        .receipt { background: white; max-width: 750px; margin: 0 auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
                        
                        .header-gradient { 
                            background: linear-gradient(180deg, #0f766e 0%, #f0fdf4 100%); 
                            padding: 30px 15px; 
                            text-align: center; 
                            position: relative;
                            overflow: hidden;
                        }
                        .header-gradient::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-image: 
                                repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 8px, transparent 8px, transparent 16px);
                            opacity: 0.3;
                        }
                        .logo-container { margin-bottom: 15px; position: relative; z-index: 1; }
                        .logo { 
                            width: 80px; 
                            height: 80px; 
                            margin: 0 auto; 
                            position: relative; 
                            display: block; 
                            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
                        }
                        .logo-svg {
                            width: 100%;
                            height: 100%;
                        }
                        .institution-name { 
                            background: white; 
                            border: 3px solid #0f766e; 
                            padding: 12px 40px; 
                            display: inline-block; 
                            border-radius: 25px; 
                            font-weight: bold; 
                            color: #1e40af; 
                            font-size: 18px; 
                            margin-top: 10px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            position: relative;
                            z-index: 1;
                        }
                        
                        .receipt-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-bottom: 2px solid #0f766e; }
                        .receipt-number { font-size: 18px; font-weight: bold; color: #1f2937; }
                        .receipt-title { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 6px 15px; border-radius: 15px; font-weight: bold; font-size: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
                        .receipt-date { font-size: 13px; font-weight: bold; color: #374151; }
                        
                        .content { padding: 15px 20px; }
                        .info-row { margin: 10px 0; display: grid; grid-template-columns: 160px 1fr; gap: 15px; align-items: center; padding: 6px 0; border-bottom: 1px solid #e5e7eb; }
                        .info-row:last-of-type { border-bottom: none; }
                        .info-row label { font-weight: bold; font-size: 14px; color: #374151; }
                        .info-value { font-size: 15px; font-weight: 600; color: #1f2937; padding: 6px 12px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; }
                        
                        .notes-section { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 12px; margin: 15px 0; border-radius: 10px; border-right: 4px solid #f59e0b; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.1); }
                        .notes-section ul { list-style: none; padding-right: 0; }
                        .notes-section li { margin: 6px 0; font-size: 12px; color: #78350f; font-weight: 500; padding-right: 20px; position: relative; }
                        .notes-section li::before { content: 'âœ“'; position: absolute; right: 0; top: 0; color: #f59e0b; font-weight: bold; font-size: 15px; }
                        
                        .signature-section { display: flex; justify-content: space-around; margin: 20px 0 15px 0; padding-top: 15px; border-top: 2px solid #e5e7eb; }
                        .signature-box { text-align: center; min-width: 180px; }
                        .signature-box label { font-weight: bold; display: block; margin-bottom: 10px; font-size: 14px; color: #374151; }
                        .signature-line { border-bottom: 2px solid #1f2937; height: 40px; width: 180px; margin: 0 auto; position: relative; border-radius: 4px; }
                        
                        .separator { height: 2px; background: linear-gradient(90deg, transparent, #0f766e, transparent); margin: 12px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .receipt { border: none; box-shadow: none; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header-gradient">
                            <div class="institution-name">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
                        </div>
                        
                        <div class="receipt-header">
                            <div class="receipt-number">${receiptNumber}</div>
                            <div class="receipt-title">ÙˆØµÙ„ Ù‚Ø¨Ø¶</div>
                            <div class="receipt-date">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formattedDate}</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-row">
                                <label>Ø§Ø³ØªÙ„Ù…Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                                <span class="info-value">${student.guardian}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>ÙÙŠ Ø§Ù„ØµÙ:</label>
                                <span class="info-value">${student.grade}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>Ù…Ø¨Ù„ØºØ§Ù‹ Ù‚Ø¯Ø±Ù‡:</label>
                                <span class="info-value">${paymentAmount.toLocaleString('en-US')} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</span>
                            </div>
                            
                            <div class="info-row">
                                <label>ÙˆÙ‡Ùˆ Ø§Ù„Ù‚Ø³Ø·:</label>
                                <span class="info-value">${installmentName}</span>
                            </div>
                            
                            ${installmentDateStr ? `
                            <div class="info-row">
                                <label>ØªØ§Ø±ÙŠØ® ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ø·:</label>
                                <span class="info-value">${installmentDateStr}</span>
                            </div>
                            ` : ''}
                            
                            <div class="info-row">
                                <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                <span class="info-value">${paymentNotes || '---'}</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <div class="notes-section">
                                <ul>
                                    <li>ÙŠØ³Ù‚Ø· Ø­Ù‚ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ÙˆØµÙ„.</li>
                                    <li>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙˆØµÙ„ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <div class="signature-box">
                                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-box">
                                <label>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</label>
                                <div class="signature-line"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
            
            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø©
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø©
        async function processPayment() {
            try {
                const studentId = document.getElementById('studentIdForPayment').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
                const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
                
                if (!paymentAmount || paymentAmount <= 0) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                    return;
                }
                
                const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
                if (!student) {
                    alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments
                if (!student.installments || !Array.isArray(student.installments)) {
                    alert('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                return;
            }
            
                if (selectedIndex === -1 || selectedIndex >= student.installments.length) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©');
                    return;
                }
                
                const installment = student.installments[selectedIndex];
                const installmentId = installment.id;
                
                if (!installmentId) {
                    alert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø³Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const installmentAmount = calculateInstallmentAmount(student);
                const currentAmount = installment.amount_paid || installment.amount || 0;
                const newAmount = currentAmount + paymentAmount;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const newStatus = newAmount >= installmentAmount ? 'paid' : 'partial';
                
                const { error: updateError } = await window.supabaseClient
                    .from('installments')
                    .update({
                        amount_paid: newAmount,
                        payment_date: paymentDate,
                        status: newStatus
                    })
                    .eq('id', installmentId);
                
                if (updateError) throw updateError;
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙÙŠ payment_history
                const { error: historyError } = await window.supabaseClient
                    .from('payment_history')
                    .insert({
                        student_id: studentId,
                        installment_id: installmentId,
                amount: paymentAmount,
                        payment_date: paymentDate,
                        receipt_number: student.receipt_number || '',
                notes: paymentNotes
            });
            
                if (historyError) console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹:', historyError);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                installment.amount = newAmount;
                installment.amount_paid = newAmount;
                installment.status = newStatus;
                
                // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„Ù„ÙˆØµÙ„
                student.lastPayment = {
                    amount: paymentAmount,
                    installmentIndex: selectedIndex,
                    paymentDate: paymentDate,
                    paymentMethod: paymentMethod,
                    notes: paymentNotes
                };
                
            renderTable();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            
            document.getElementById('paymentForm').reset();
            
                alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ù…Ø¨Ù„Øº: ${paymentAmount.toLocaleString('en-US')} Ø¯.Ø¹`);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
                setTimeout(() => {
                    sendWhatsAppMessage(studentId, 'payment', {
                        amount: paymentAmount,
                        installmentNumber: selectedIndex + 1,
                        paymentDate: paymentDate
                    });
                }, 500);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©: ' + error.message);
            }
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
        function printReceipt(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const installments = student.installments || [];
            const installmentNames = ['Ø§Ù„Ø§ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø±Ø§Ø¨Ø¹'];
            const receiptNumber = getStudentField(student, 'receiptNumber');
            
            // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
            const today = new Date();
            const formattedDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹
            const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const annualFee = student.annualFee || student.annual_fee || 1200000;
            const discount = student.discount || 0;
            const finalFee = student.finalFee || student.final_fee || annualFee;
            const installmentAmount = finalFee / 4;
            
            const receiptHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ÙˆØµÙ„ Ù‚Ø¨Ø¶ - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Arial', 'Segoe UI', sans-serif; padding: 10px; direction: rtl; background: #e5e7eb; }
                        .receipt { background: white; max-width: 100%; margin: 0 auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
                        
                        /* Header with gradient */
                        .header-gradient { 
                            background: linear-gradient(180deg, #0f766e 0%, #f0fdf4 100%); 
                            padding: 15px 10px; 
                            text-align: center; 
                            position: relative;
                            overflow: hidden;
                        }
                        .header-gradient::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-image: 
                                repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 8px, transparent 8px, transparent 16px);
                            opacity: 0.3;
                        }
                        .logo-container { margin-bottom: 5px; position: relative; z-index: 1; }
                        .logo { 
                            width: 50px; 
                            height: 50px; 
                            margin: 0 auto; 
                            position: relative; 
                            display: block; 
                            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
                        }
                        .logo-svg {
                            width: 100%;
                            height: 100%;
                        }
                        .institution-name { 
                            background: white; 
                            border: 2px solid #0f766e; 
                            padding: 6px 20px; 
                            display: inline-block; 
                            border-radius: 15px; 
                            font-weight: bold; 
                            color: #1e40af; 
                            font-size: 13px; 
                            margin-top: 5px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            position: relative;
                            z-index: 1;
                        }
                        
                        /* Receipt info section */
                        .receipt-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-bottom: 2px solid #0f766e; }
                        .receipt-number { font-size: 14px; font-weight: bold; color: #1f2937; }
                        .receipt-title { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
                        .receipt-date { font-size: 11px; font-weight: bold; color: #374151; }
                        
                        /* Main content */
                        .content { padding: 8px 10px; }
                        .info-row { margin: 5px 0; display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center; padding: 3px 0; border-bottom: 1px solid #e5e7eb; }
                        .info-row:last-of-type { border-bottom: none; }
                        .info-row label { font-weight: bold; font-size: 12px; color: #374151; }
                        .info-value { font-size: 13px; font-weight: 600; color: #1f2937; padding: 4px 8px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; }
                        
                        /* Installment dates */
                        .installment-dates { margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border-radius: 10px; border: 2px solid #10b981; }
                        .installment-dates-title { font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #065f46; }
                        .date-boxes { display: flex; gap: 10px; }
                        .date-box { width: 70px; height: 50px; background: white; border: 2px solid #10b981; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: #065f46; box-shadow: 0 3px 6px rgba(16, 185, 129, 0.2); }
                        
                        /* Important notes */
                        .notes-section { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 12px; margin: 15px 0; border-radius: 10px; border-right: 4px solid #f59e0b; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.1); }
                        .notes-section ul { list-style: none; padding-right: 0; }
                        .notes-section li { margin: 6px 0; font-size: 12px; color: #78350f; font-weight: 500; padding-right: 20px; position: relative; }
                        .notes-section li::before { content: 'âœ“'; position: absolute; right: 0; top: 0; color: #f59e0b; font-weight: bold; font-size: 15px; }
                        
                        /* Signature section */
                        .signature-section { display: flex; justify-content: space-around; margin: 20px 0 15px 0; padding-top: 15px; border-top: 2px solid #e5e7eb; }
                        .signature-box { text-align: center; min-width: 180px; }
                        .signature-box label { font-weight: bold; display: block; margin-bottom: 10px; font-size: 14px; color: #374151; }
                        .signature-line { border-bottom: 2px solid #1f2937; height: 40px; width: 180px; margin: 0 auto; position: relative; border-radius: 4px; }
                        
                        /* Separator */
                        .separator { height: 2px; background: linear-gradient(90deg, transparent, #0f766e, transparent); margin: 12px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .receipt { border: none; box-shadow: none; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <!-- Header with gradient -->
                        <div class="header-gradient">
                            <div class="logo-container">
                                <div class="logo"></div>
                        </div>
                            <div class="institution-name">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
                        </div>
                        
                        <!-- Receipt Number and Title -->
                        <div class="receipt-header">
                            <div class="receipt-number">${receiptNumber}</div>
                            <div class="receipt-title">ÙˆØµÙ„ Ù‚Ø¨Ø¶</div>
                            <div class="receipt-date">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formattedDate}</div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="content">
                            <div class="info-row">
                                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                                <span class="info-value">${student.name}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                                <span class="info-value">${student.guardian}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>Ø§Ù„ØµÙ:</label>
                                <span class="info-value">${student.grade}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ:</label>
                                <span class="info-value">${annualFee.toLocaleString('en-US')} Ø¯.Ø¹</span>
                            </div>
                            
                            <div class="info-row">
                                <label>Ø§Ù„Ø®ØµÙ…:</label>
                                <span class="info-value">${discount.toLocaleString('en-US')} Ø¯.Ø¹</span>
                            </div>
                            
                            <div class="info-row">
                                <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
                                <span class="info-value">${finalFee.toLocaleString('en-US')} Ø¯.Ø¹</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <!-- Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
                            <div class="installments-table" style="margin: 8px 0;">
                                <h6 style="font-weight: bold; margin-bottom: 5px; font-size: 11px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</h6>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${installments.map((inst, i) => {
                                            const paid = inst.amount_paid || inst.amount || 0;
                                            const required = installmentAmount;
                                            return `
                                                <tr>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${installmentNames[i]}</td>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${required.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${paid.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f3f4f6; font-weight: bold;">
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">${finalFee.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div class="separator" style="margin: 5px 0;"></div>
                            
                            <div class="info-row" style="background: #fff3cd; padding: 5px 8px; border-radius: 5px; border: 2px solid #f59e0b; margin: 5px 0;">
                                <label style="font-size: 12px; color: #856404;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
                                <span class="info-value" style="font-size: 13px; color: #856404;">${(finalFee - totalPaid).toLocaleString('en-US')} Ø¯.Ø¹</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <!-- Important Notes -->
                            <div class="notes-section" style="padding: 6px; margin: 5px 0; font-size: 9px;">
                                <ul style="margin: 0; padding-right: 0;">
                                    <li style="margin: 3px 0; padding-right: 15px; font-size: 9px;">ÙŠØ³Ù‚Ø· Ø­Ù‚ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ÙˆØµÙ„.</li>
                                    <li style="margin: 3px 0; padding-right: 15px; font-size: 9px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙˆØµÙ„ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Signature Section -->
                        <div class="signature-section" style="display: flex; justify-content: space-around; margin: 8px 0 5px 0; padding-top: 5px; border-top: 2px solid #e5e7eb;">
                            <div class="signature-box" style="text-align: center; min-width: 140px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 11px; color: #374151;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                                <div class="signature-line" style="border-bottom: 2px solid #1f2937; height: 25px; width: 140px; margin: 0 auto; position: relative; border-radius: 4px;"></div>
                            </div>
                            <div class="signature-box" style="text-align: center; min-width: 140px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 11px; color: #374151;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</label>
                                <div class="signature-line" style="border-bottom: 2px solid #1f2937; height: 25px; width: 140px; margin: 0 auto; position: relative; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // Ø­Ø°Ù Ø·Ø§Ù„Ø¨
        async function deleteStudent(studentId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
            
            try {
                // Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { error } = await window.supabaseClient
                    .from('students')
                    .delete()
                    .eq('id', studentId);
                
                if (error) throw error;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            students = students.filter(s => s.id !== studentId);
            allStudents = allStudents.filter(s => s.id !== studentId);
            renderTable();
            updateStats();
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ' + error.message);
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©)
        async function saveData() {
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function migrateOldData(studentsData) {
            let counter = 1;
            return studentsData.map((student, index) => {
                // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (!student.receiptNumber) {
                    student.receiptNumber = String(counter++).padStart(6, '0');
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                if (!student.installments && student.paid !== undefined) {
                    const annualFee = student.annualFee || student.monthlyFee * 12 || 1200000;
                    const hasSibling = student.hasSibling || false;
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                    let finalFee = annualFee;
                    let discountAmount = 0;
                    
                    if (hasSibling) {
                        discountAmount = annualFee * SIBLING_DISCOUNT_RATE;
                        finalFee = annualFee - discountAmount;
                    }
                    
                    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø§Øª
                    const installmentAmount = finalFee / INSTALLMENT_COUNT;
                    const paidAmount = student.paid || 0;
                    const installments = [];
                    
                    let remainingPaid = paidAmount;
                    
                    for (let i = 0; i < INSTALLMENT_COUNT; i++) {
                        if (remainingPaid >= installmentAmount) {
                            installments.push({ amount: installmentAmount, status: 'paid' });
                            remainingPaid -= installmentAmount;
                        } else if (remainingPaid > 0) {
                            installments.push({ amount: remainingPaid, status: 'partial' });
                            remainingPaid = 0;
                        } else {
                            installments.push({ amount: 0, status: 'unpaid' });
                        }
                    }
                    
                    return {
                        ...student,
                        annualFee: annualFee,
                        finalFee: finalFee,
                        hasSibling: hasSibling,
                        discount: discountAmount,
                        installments: installments
                    };
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ installments Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                if (!student.installments) {
                    const installmentAmount = calculateInstallmentAmount(student);
                    student.installments = [
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' }
                    ];
                }
                
                return student;
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadData() {
            if (!currentSchool && !isAdmin) return;
            
            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Supabase
            if (!window.supabaseClient) {
                console.log('Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Supabase...');
                await new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (window.supabaseClient) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => clearInterval(checkInterval), 10000);
                });
            }
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ school_id Ù„Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if (currentSchool) {
                    console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:', currentSchool.id);
                    const { data: schoolData, error: schoolError } = await window.supabaseClient
                        .from('schools')
                        .select('id')
                        .eq('code', currentSchool.id)
                        .single();
                    
                    if (schoolError) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:', schoolError);
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                        return;
                    }
                    
                    if (!schoolData) {
                        console.log('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§:', currentSchool.name);
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                        const { data: newSchool, error: insertError } = await window.supabaseClient
                            .from('schools')
                            .insert({
                                name: currentSchool.name,
                                code: currentSchool.id,
                                description: `${currentSchool.name} - Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©`
                            })
                            .select()
                            .single();
                        
                        if (insertError) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:', insertError);
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ù…Ù„Ù database_schema.sql Ø£ÙˆÙ„Ø§Ù‹.');
                            return;
                        }
                        
                        schoolData = { id: newSchool.id };
                    }
                    
                    // ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    currentSchoolId = schoolData.id;
                    currentSchoolName = currentSchool.name;
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨
                    const { data, error } = await window.supabaseClient
                        .from('students')
                        .select('*')
                        .eq('school_id', schoolData.id)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    students = data || [];
                    allStudents = [...students]; // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                    for (let student of students) {
                        const { data: installmentsData } = await window.supabaseClient
                            .from('installments')
                            .select('*')
                            .eq('student_id', student.id)
                            .order('installment_number', { ascending: true });
                        
                        student.installments = installmentsData || [
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' }
                        ];
                    }
                } else if (isAdmin) {
                    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ±
                    const { data, error } = await window.supabaseClient
                        .from('students')
                        .select('*, schools(code, name)')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    students = data || [];
                    allStudents = [...students]; // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                    for (let student of students) {
                        const { data: installmentsData } = await window.supabaseClient
                            .from('installments')
                            .select('*')
                            .eq('student_id', student.id)
                            .order('installment_number', { ascending: true });
                        
                        student.installments = installmentsData || [
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' }
                        ];
                        
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                        if (student.schools) {
                            student.schoolId = student.schools.code || '';
                            student.schoolName = student.schools.name || '';
                        }
                    }
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    if (isAdmin) {
                        setupSchoolTabs();
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« counter
                if (students.length > 0) {
                    const maxReceiptNumber = Math.max(...students.map(s => {
                        const num = parseInt(s.receipt_number) || 0;
                        return isNaN(num) ? 0 : num;
                    }));
                    receiptCounter = maxReceiptNumber + 1;
                }
                
            updateStats();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function showLoginModal() {
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), { backdrop: 'static', keyboard: false });
            loginModal.show();
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                localStorage.removeItem('currentLogin');
                currentSchool = null;
                isAdmin = false;
                students = [];
                document.getElementById('mainContent').style.display = 'none';
                location.reload();
            }
        }

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function exportData() {
            const dataStr = JSON.stringify(students, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students_data_${new Date().getTime()}.json`;
            link.click();
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
        function showStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const installments = student.installments || [];
            const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const annualFee = student.annualFee || student.annual_fee || 1200000;
            const discount = student.discount || 0;
            const finalFee = student.finalFee || student.final_fee || annualFee;
            const remaining = finalFee - totalPaid;
            const installmentAmount = calculateInstallmentAmount(student);
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø®ÙˆØ©
            const motherName = student.motherName || student.mother_name || '';
            const guardian = student.guardian || '';
            const siblings = students.filter(s => 
                s.id !== studentId && 
                (s.motherName || s.mother_name) === motherName && 
                motherName !== '' &&
                s.guardian === guardian
            );
            
            let siblingsHTML = '';
            if (siblings.length > 0) {
                siblingsHTML = `
                    <hr>
                    <h5 class="mb-3"><i class="bi bi-people"></i> Ø§Ù„Ø¥Ø®ÙˆØ© (${siblings.length})</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                                    <th>Ø§Ù„ØµÙ</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${siblings.map(s => {
                                    const schoolName = s.schoolName || '---';
                                    return `
                                        <tr>
                                            <td>${s.name || '---'}</td>
                                            <td>${schoolName}</td>
                                            <td>${s.grade || '---'}</td>
                                            <td><span class="badge ${s.hasSibling || s.has_sibling ? 'bg-success' : 'bg-danger'}">${s.hasSibling || s.has_sibling ? 'ÙŠØ³ØªÙÙŠØ¯ Ù…Ù† Ø®ØµÙ…' : 'Ù„Ø§ ÙŠØ³ØªÙÙŠØ¯'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${student.name || student.student_name || '---'}</p>
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø£Ù…:</strong> ${student.motherName || student.mother_name || '---'}</p>
                        <p><strong>Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</strong> ${student.guardian || '---'}</p>
                        <p><strong>Ø§Ù„ØµÙ:</strong> ${student.grade || '---'}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„:</strong> ${student.receiptNumber || student.receipt_number || '---'}</p>
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${student.phone || '---'}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> ${student.registrationDate || student.registration_date || '---'}</p>
                        <p><strong>Ø¥Ø®ÙˆØ© (Ø®ØµÙ… 5%):</strong> ${student.hasSibling || student.has_sibling ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ:</strong> ${annualFee.toLocaleString('en-US')} Ø¯.Ø¹</p>
                        <p><strong>Ø§Ù„Ø®ØµÙ…:</strong> ${discount.toLocaleString('en-US')} Ø¯.Ø¹</p>
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</strong> ${finalFee.toLocaleString('en-US')} Ø¯.Ø¹</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹</p>
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${remaining.toLocaleString('en-US')} Ø¯.Ø¹</p>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${installments.map((inst, i) => {
                                const paid = inst.amount_paid || inst.amount || 0;
                                const required = installmentAmount;
                                const remainingInst = required - paid;
                                let statusBadge = '';
                                
                                if (paid >= required) {
                                    statusBadge = '<span class="badge bg-success">Ù…ÙƒØªÙ…Ù„Ø©</span>';
                                } else if (paid > 0) {
                                    statusBadge = '<span class="badge bg-warning">Ø¬Ø²Ø¦ÙŠØ©</span>';
                                } else {
                                    statusBadge = '<span class="badge bg-danger">ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${required.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                        <td>${paid.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                        <td>${remainingInst.toLocaleString('en-US')} Ø¯.Ø¹</td>
                                        <td>${statusBadge}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${siblingsHTML}
                ${student.notes ? `<hr><p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${student.notes}</p>` : ''}
            `;
            
            document.getElementById('studentDetailsContent').innerHTML = detailsHTML;
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }

        // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editMotherName').value = student.motherName || student.mother_name || '';
            document.getElementById('editGuardianName').value = student.guardian;
            document.getElementById('editGrade').value = student.grade;
            document.getElementById('editAnnualFee').value = student.annualFee || student.annual_fee || 1200000;
            document.getElementById('editHasSibling').value = (student.hasSibling || student.has_sibling) ? 'yes' : 'no';
            document.getElementById('editPhone').value = student.phone || '';
            document.getElementById('editNotes').value = student.notes || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }

        // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        async function saveEditedStudent() {
            try {
                const studentId = document.getElementById('editStudentId').value;
                console.log('Saving student ID:', studentId);
                const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
                console.log('Found student:', student);
                if (!student) {
                    console.error('Student not found');
                    return;
                }
                
                const annualFeeInput = document.getElementById('editAnnualFee').value;
                const annualFee = parseFloat(annualFeeInput) || ANNUAL_FEE;
                const hasSibling = document.getElementById('editHasSibling').value === 'yes';
                
                if (isNaN(annualFee) || annualFee <= 0) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ ØµØ­ÙŠØ­Ø§Ù‹');
                    return;
                }
                
                console.log('Annual Fee:', annualFee);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                let finalFee = annualFee;
                let discountAmount = 0;
                
                if (hasSibling) {
                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®ÙˆØ©
                        const motherName = document.getElementById('editMotherName').value.trim();
                        const guardian = document.getElementById('editGuardianName').value.trim();
                        let siblingsCount = 1; // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                        
                        if (motherName && guardian) {
                            const siblings = allStudents.filter(s => 
                                s.id !== studentId && 
                                (s.motherName || s.mother_name) === motherName && 
                                s.guardian === guardian
                            );
                            siblingsCount = siblings.length + 1;
                        }
                        
                        const discountRate = calculateSiblingDiscount(siblingsCount);
                        discountAmount = annualFee * discountRate;
                    finalFee = annualFee - discountAmount;
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const updateData = {
                    name: document.getElementById('editStudentName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    mother_name: document.getElementById('editMotherName').value || '',
                    guardian: document.getElementById('editGuardianName').value || '',
                    grade: document.getElementById('editGrade').value || '',
                    annual_fee: annualFee,
                    final_fee: finalFee,
                    has_sibling: hasSibling,
                    discount: discountAmount
                };
                
                // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
                const phoneValue = document.getElementById('editPhone').value;
                const notesValue = document.getElementById('editNotes').value;
                
                if (phoneValue) updateData.phone = phoneValue;
                if (notesValue) updateData.notes = notesValue;
                
                console.log('Update data:', updateData);
                
                const { error } = await window.supabaseClient
                    .from('students')
                    .update(updateData)
                    .eq('id', studentId);
                
                if (error) throw error;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                student.name = document.getElementById('editStudentName').value;
                student.motherName = document.getElementById('editMotherName').value;
                student.mother_name = document.getElementById('editMotherName').value;
                student.guardian = document.getElementById('editGuardianName').value;
                student.grade = document.getElementById('editGrade').value;
                student.annualFee = annualFee;
                student.annual_fee = annualFee;
                student.finalFee = finalFee;
                student.final_fee = finalFee;
                student.hasSibling = hasSibling;
                student.has_sibling = hasSibling;
                student.discount = discountAmount;
                student.phone = document.getElementById('editPhone').value;
                student.notes = document.getElementById('editNotes').value;
                
            // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙÙˆÙ
            updateGradeFilter();
                
            renderTable();
            updateStats();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                modal.hide();
                
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + error.message);
            }
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ
        function printList() {
            const printWindow = window.open('', '_blank');
            
            let tableHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - ${students.length} Ø·Ø§Ù„Ø¨</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        @page { 
                            size: A4; 
                            margin: 0.5cm; 
                        }
                        @media print {
                            body { margin: 0; padding: 0; }
                        }
                        body { font-family: Arial, sans-serif; direction: rtl; background: white; }
                        .report-container { width: 100%; padding: 10px; font-size: 9px; }
                        .header { text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #0f766e; }
                        .header h1 { color: #0f766e; font-size: 18px; margin-bottom: 5px; }
                        .header p { color: #666; font-size: 12px; }
                        .stats { display: flex; justify-content: space-around; margin: 10px 0; padding: 10px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; border-radius: 5px; }
                        .stat-item { text-align: center; font-size: 9px; }
                        .stat-item strong { display: block; font-size: 16px; margin-top: 3px; }
                        table { width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 7px; }
                        th, td { padding: 4px; text-align: right; border: 1px solid #ddd; }
                        th { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; font-weight: bold; font-size: 8px; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .badge { padding: 3px 6px; border-radius: 3px; font-size: 8px; font-weight: bold; }
                        .badge-success { background: #10b981; color: white; }
                        .badge-warning { background: #f59e0b; color: white; }
                        .badge-danger { background: #ef4444; color: white; }
                        .print-date { text-align: left; color: #666; margin-top: 10px; font-size: 8px; }
                        .school-col { display: none; }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="header">
                            <h1>Ù…Ø¯Ø±Ø³Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©</h1>
                            <p>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ </p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-item">
                                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                                <strong>${students.length}</strong>
                            </div>
                            <div class="stat-item">
                                <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
                                <strong id="statsTotal">0 Ø¯.Ø¹</strong>
                            </div>
                            <div class="stat-item">
                                <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                                <strong id="statsPaid">0 Ø¯.Ø¹</strong>
                            </div>
                            <div class="stat-item">
                                <div>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                <strong id="statsRemaining">0 Ø¯.Ø¹</strong>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Ù…</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    ${isAdmin ? '<th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>' : ''}
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</th>
                                    <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th>Ø§Ù„ØµÙ</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                                    <th>Ø§Ù„Ø¯ÙÙØ¹Ø© 1</th>
                                    <th>Ø§Ù„Ø¯ÙÙØ¹Ø© 2</th>
                                    <th>Ø§Ù„Ø¯ÙÙØ¹Ø© 3</th>
                                    <th>Ø§Ù„Ø¯ÙÙØ¹Ø© 4</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th>Ø§Ù„Ø®ØµÙ…</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            let totalFees = 0, totalPaid = 0;
            
            students.forEach((student, index) => {
                const installments = student.installments || [];
                const studentTotalPaid = installments.reduce((sum, inst) => sum + (inst.amount || 0), 0);
                const finalFee = student.finalFee || student.annualFee || student.final_fee || student.annual_fee || 1200000;
                const studentRemaining = finalFee - studentTotalPaid;
                const statusInfo = getFinancialStatus(student);
                
                totalFees += finalFee;
                totalPaid += studentTotalPaid;
                
                let statusBadge = '';
                if (studentRemaining <= 0) {
                    statusBadge = '<span class="badge badge-success">Ù…Ø³Ø¯Ø¯</span>';
                } else if (studentTotalPaid > 0) {
                    statusBadge = '<span class="badge badge-warning">Ø¬Ø²Ø¦ÙŠ</span>';
                } else {
                    statusBadge = '<span class="badge badge-danger">ØºÙŠØ± Ù…Ø³Ø¯Ø¯</span>';
                }
                
                const installmentAmount = calculateInstallmentAmount(student);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                const installmentColumns = installments.map(inst => {
                    const paid = inst.amount || 0;
                    if (paid >= installmentAmount) {
                        return '<td style="background: #d4edda; color: #155724;">' + paid.toLocaleString('en-US') + '</td>';
                    } else if (paid > 0) {
                        return '<td style="background: #fff3cd; color: #856404;">' + paid.toLocaleString('en-US') + '</td>';
                    } else {
                        return '<td>0</td>';
                    }
                }).join('');
                
                const schoolNameCell = isAdmin && student.schoolName ? `<td>${student.schoolName}</td>` : '';
                const annualFee = student.annualFee || student.annual_fee || 1200000;
                const discount = student.discount || 0;
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.receiptNumber || student.receipt_number || '---'}</td>
                        <td>${student.name || student.student_name || '---'}</td>
                        ${schoolNameCell}
                        <td>${student.motherName || student.mother_name || '---'}</td>
                        <td>${student.guardian || student.guardian_name || '---'}</td>
                        <td>${student.grade || '---'}</td>
                        <td>${annualFee.toLocaleString('en-US')} Ø¯.Ø¹</td>
                        ${installmentColumns}
                        <td><strong>${studentTotalPaid.toLocaleString('en-US')}</strong></td>
                        <td><strong>${studentRemaining.toLocaleString('en-US')}</strong></td>
                        <td>${discount.toLocaleString('en-US')}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            const remaining = totalFees - totalPaid;
            const totalFeesStr = totalFees.toLocaleString('en-US');
            const totalPaidStr = totalPaid.toLocaleString('en-US');
            const remainingStr = remaining.toLocaleString('en-US');
            
            tableHTML += `
                            </tbody>
                        </table>
                        
                        <div class="print-date">
                            ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-IQ')}
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(tableHTML);
            printWindow.document.close();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            const statsTotal = printWindow.document.getElementById('statsTotal');
            const statsPaid = printWindow.document.getElementById('statsPaid');
            const statsRemaining = printWindow.document.getElementById('statsRemaining');
            
            if (statsTotal) statsTotal.textContent = totalFeesStr + ' Ø¯.Ø¹';
            if (statsPaid) statsPaid.textContent = totalPaidStr + ' Ø¯.Ø¹';
            if (statsRemaining) statsRemaining.textContent = remainingStr + ' Ø¯.Ø¹';
            
            printWindow.print();
        }

        // ============ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ============
        let notificationsInterval;
        let chatInterval;
        let unreadNotifications = 0;
        let unreadMessages = 0;

        // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        async function initChatSystem() {
            if (!window.supabaseClient || !currentSchoolId) return;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('notificationBtn').style.display = 'block';
            document.getElementById('chatBtn').style.display = 'block';
            
            // Ø¥Ø¶Ø§ÙØ© event listeners
            document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
            document.getElementById('chatBtn').addEventListener('click', toggleChat);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            await loadNotifications();
            await loadMessages();
            
            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†
            notificationsInterval = setInterval(loadNotifications, 5000);
            chatInterval = setInterval(loadMessages, 5000);
        }

        // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('show')) {
                closeNotifications();
            } else {
                panel.classList.add('show');
                document.getElementById('chatPanel').classList.remove('show');
            }
        }

        function closeNotifications() {
            document.getElementById('notificationPanel').classList.remove('show');
        }

        // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            if (panel.classList.contains('show')) {
                closeChat();
            } else {
                panel.classList.add('show');
                document.getElementById('notificationPanel').classList.remove('show');
                loadChatReceivers();
            }
        }

        function closeChat() {
            document.getElementById('chatPanel').classList.remove('show');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        async function loadNotifications() {
            if (!window.supabaseClient || !currentSchoolId) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('school_id', currentSchoolId)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                unreadNotifications = data.filter(n => !n.is_read).length;
                updateNotificationBadge();
                displayNotifications(data);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function displayNotifications(notifications) {
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<p class="text-center text-muted p-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>';
                return;
            }
            
            notifications.forEach(notif => {
                const div = document.createElement('div');
                div.className = `notification-item ${notif.is_read ? 'read' : 'unread'}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong style="color: #1f2937;">${notif.title}</strong>
                            <p style="margin: 5px 0; color: #6b7280; font-size: 13px;">${notif.message}</p>
                            <small style="color: #9ca3af; font-size: 11px;">${formatDate(notif.created_at)}</small>
                        </div>
                        ${!notif.is_read ? '<span class="badge bg-danger" style="width: 8px; height: 8px; border-radius: 50%;"></span>' : ''}
                    </div>
                `;
                div.addEventListener('click', () => markNotificationAsRead(notif.id));
                list.appendChild(div);
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadNotifications > 0) {
                badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
        async function markNotificationAsRead(id) {
            try {
                await window.supabaseClient
                    .from('notifications')
                    .update({ is_read: true })
                    .eq('id', id);
                loadNotifications();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        async function loadMessages() {
            if (!window.supabaseClient || !currentSchoolId) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('messages')
                    .select('*')
                    .or(`receiver_id.eq.${currentSchoolId},sender_id.eq.${currentSchoolId}`)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                unreadMessages = data.filter(m => 
                    m.receiver_id === currentSchoolId && !m.is_read
                ).length;
                updateChatBadge();
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                if (document.getElementById('chatPanel').classList.contains('show')) {
                    displayMessages(data);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            messages.forEach(msg => {
                const isSent = msg.sender_id === currentSchoolId;
                const div = document.createElement('div');
                div.className = `chat-message ${isSent ? 'sent' : 'received'}`;
                
                const time = formatTime(msg.created_at);
                div.innerHTML = `
                    ${!isSent ? `<div class="message-sender">${msg.sender_name}</div>` : ''}
                    <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                        ${msg.message}
                    </div>
                    <div class="message-time">${time}</div>
                `;
                container.appendChild(div);
                
                // ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
                if (!isSent && !msg.is_read) {
                    markMessageAsRead(msg.id);
                }
            });
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            container.scrollTop = container.scrollHeight;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
        async function loadChatReceivers() {
            if (!window.supabaseClient) return;
            
            const select = document.getElementById('chatReceiver');
            select.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</option>';
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('schools')
                    .select('id, name')
                    .neq('id', currentSchoolId);
                
                if (error) throw error;
                
                data.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', error);
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const receiverId = document.getElementById('chatReceiver').value;
            const message = input.value.trim();
            
            if (!message || !currentSchoolId) return;
            
            if (receiverId === 'all') {
                // Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
                await sendBroadcastMessage(message);
            } else {
                // Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ø¯Ø¯Ø©
                try {
                    const { error } = await window.supabaseClient
                        .from('messages')
                        .insert({
                            sender_id: currentSchoolId,
                            sender_name: currentSchoolName,
                            receiver_id: receiverId,
                            message: message
                        });
                    
                    if (error) throw error;
                    
                    input.value = '';
                    loadMessages();
                    
                    // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                    createNotification(receiverId, 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', `${currentSchoolName}: ${message}`, 'info');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                    alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
                }
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
        async function sendBroadcastMessage(message) {
            try {
                const { data: schools } = await window.supabaseClient
                    .from('schools')
                    .select('id')
                    .neq('id', currentSchoolId);
                
                if (!schools) return;
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø©
                for (const school of schools) {
                    await window.supabaseClient
                        .from('messages')
                        .insert({
                            sender_id: currentSchoolId,
                            sender_name: currentSchoolName,
                            receiver_id: school.id,
                            message: message,
                            is_broadcast: true
                        });
                }
                
                document.getElementById('chatInput').value = '';
                loadMessages();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©:', error);
            }
        }

        // ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        async function markMessageAsRead(messageId) {
            try {
                await window.supabaseClient
                    .from('messages')
                    .update({ is_read: true })
                    .eq('id', messageId);
                loadMessages();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
        async function createNotification(schoolId, title, message, type = 'info') {
            try {
                await window.supabaseClient
                    .from('notifications')
                    .insert({
                        school_id: schoolId,
                        title: title,
                        message: message,
                        type: type
                    });
                loadNotifications();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
            }
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
        function formatTime(dateString) {
            const date = new Date(dateString);
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // ØªÙ…ÙƒÙŠÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'chatInput' && e.key === 'Enter') {
                sendMessage();
            }
        });

        // ============ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ============
        

        // ÙØªØ­ Modal Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
        function openAddUserModal() {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addUserModal'));
            modal.show();
        }

        // Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        async function saveNewUser() {
            try {
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value.trim();
                const schoolCode = document.getElementById('userSchool').value;
                const userType = document.getElementById('userType').value;

                if (!username || !password || !schoolCode) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                    return;
                }

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù† ÙƒÙˆØ¯Ù‡Ø§
                const { data: schoolData, error: schoolError } = await window.supabaseClient
                    .from('schools')
                    .select('id')
                    .eq('code', schoolCode)
                    .single();

                if (schoolError || !schoolData) {
                    throw new Error('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { data: existingUsers, error: checkError } = await window.supabaseClient
                    .from('users')
                    .select('id')
                    .eq('username', username);

                if (checkError || (existingUsers && existingUsers.length > 0)) {
                    throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                }

                // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const schoolName = document.getElementById('userSchool').selectedOptions[0].text;
                const { error } = await window.supabaseClient
                    .from('users')
                    .insert({
                        username: username,
                        password: password,
                        password_hash: password,
                        school_id: schoolData.id,
                        user_type: userType,
                        is_active: true,
                        full_name: `Ù…Ø³ØªØ®Ø¯Ù… ${schoolName}`
                    });

                if (error) throw error;

                alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                document.getElementById('addUserForm').reset();
                loadUsers();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        async function loadUsers() {
            if (!isAdmin) return;

            try {
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                const { data, error } = await window.supabaseClient
                    .from('users')
                    .select('*, schools(name, code)')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
                    return;
                }

                // ÙÙ„ØªØ±Ø©: Ø¥Ø¸Ù‡Ø§Ø± ÙÙ‚Ø· Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… school_id)
                const schoolUsers = data.filter(user => user.school_id !== null && user.schools);

                if (schoolUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø¯Ø§Ø±Ø³</td></tr>';
                    return;
                }

                schoolUsers.forEach((user, index) => {
                    const schoolName = user.schools.name;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.username}</td>
                        <td><strong style="color: #0f766e;">${user.password || '---'}</strong></td>
                        <td>${schoolName}</td>
                        <td>${getUserTypeLabel(user.user_type)}</td>
                        <td>
                            <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                ${user.is_active ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}
                            </span>
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <button onclick="toggleUserStatus('${user.id}', ${user.is_active})" class="btn btn-sm btn-${user.is_active ? 'warning' : 'success'}">
                                <i class="bi bi-${user.is_active ? 'x-circle' : 'check-circle'}"></i>
                                ${user.is_active ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„)
        async function toggleUserStatus(userId, currentStatus) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${currentStatus ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;

            try {
                const { error } = await window.supabaseClient
                    .from('users')
                    .update({ is_active: !currentStatus })
                    .eq('id', userId);

                if (error) throw error;

                loadUsers();
                alert(`ØªÙ… ${currentStatus ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        // Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
        async function deleteUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;

            try {
                const { error } = await window.supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                loadUsers();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        function getUserTypeLabel(type) {
            const types = {
                'user': 'Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ',
                'school_admin': 'Ù…Ø¯ÙŠØ± Ù…Ø¯Ø±Ø³Ø©',
                'admin': 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…'
            };
            return types[type] || type;
        }

        // ============ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ============
        
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function switchMainTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† Ø¬Ù…ÙŠØ¹ nav-item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
            
            // ØªÙØ¹ÙŠÙ„ nav-item Ø§Ù„Ù…Ø­Ø¯Ø¯
            const navItems = document.querySelectorAll('.nav-item');
            if (tabName === 'students') navItems[0]?.classList.add('active');
            else if (tabName === 'schools') navItems[1]?.classList.add('active');
            else if (tabName === 'users') navItems[2]?.classList.add('active');
            else if (tabName === 'settings') navItems[3]?.classList.add('active');
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            if (tabName === 'schools') {
                loadSchoolsStats();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Sidebar
        function updateSidebarInfo() {
            const userInfo = document.getElementById('sidebarUserInfo');
            const schoolName = document.getElementById('sidebarSchoolName');
            
            if (isAdmin) {
                userInfo.textContent = 'Ø±Ø¦ÙŠØ³ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                schoolName.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³';
            } else if (currentSchoolName) {
                userInfo.textContent = currentSchoolName;
                schoolName.textContent = currentSchoolName;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Sidebar
        function startDateTimeUpdate() {
            function updateDateTime() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ar-IQ', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeStr = now.toLocaleTimeString('ar-IQ', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateTimeEl = document.getElementById('sidebarDateTime');
                if (dateTimeEl) {
                    dateTimeEl.textContent = `${dateStr} - ${timeStr}`;
                }
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }
        
        // ============ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ============
        
        let schoolsDataGlobal = [];
        let chartsInstances = {};
        
        async function loadSchoolsStats() {
            if (!isAdmin || !window.supabaseClient) return;
            
            try {
                const statsContainer = document.getElementById('schoolsStatsContainer');
                const listContainer = document.getElementById('schoolsListContainer');
                
                statsContainer.innerHTML = '';
                listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                
                let html = '';
                let totalStudents = 0;
                let totalFees = 0;
                let totalPaid = 0;
                let totalUnpaid = 0;
                let totalPartial = 0;
                let totalPaidStudents = 0;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù„Ù„ØªØ±ØªÙŠØ¨
                const schoolsData = [];
                
                for (const [schoolId, school] of Object.entries(schools)) {
                    const { data: schoolData } = await window.supabaseClient
                        .from('schools')
                        .select('id')
                        .eq('code', schoolId)
                        .single();
                    
                    if (!schoolData) continue;
                    
                    const { data: studentsData } = await window.supabaseClient
                        .from('students')
                        .select('id, final_fee, annual_fee')
                        .eq('school_id', schoolData.id);
                    
                    if (!studentsData || studentsData.length === 0) continue;
                    
                    let schoolStudents = 0;
                    let schoolFees = 0;
                    let schoolPaid = 0;
                    let schoolUnpaid = 0;
                    let schoolPartial = 0;
                    let schoolPaidCount = 0;
                    
                    for (const student of studentsData) {
                        schoolStudents++;
                        const finalFee = student.final_fee || student.annual_fee || 1200000;
                        schoolFees += finalFee;
                        
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø¬Ø¯ÙˆÙ„ installments
                        const { data: installmentsData } = await window.supabaseClient
                            .from('installments')
                            .select('amount_paid')
                            .eq('student_id', student.id);
                        
                        let studentPaid = 0;
                        if (installmentsData) {
                            studentPaid = installmentsData.reduce((sum, inst) => sum + (inst.amount_paid || 0), 0);
                            schoolPaid += studentPaid;
                        }
                        
                        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
                        const remaining = finalFee - studentPaid;
                        if (remaining <= 0) {
                            schoolPaidCount++;
                        } else if (studentPaid > 0) {
                            schoolPartial++;
                        } else {
                            schoolUnpaid++;
                        }
                    }
                    
                    totalStudents += schoolStudents;
                    totalFees += schoolFees;
                    totalPaid += schoolPaid;
                    totalUnpaid += schoolUnpaid;
                    totalPartial += schoolPartial;
                    totalPaidStudents += schoolPaidCount;
                    
                    const paymentRate = schoolFees > 0 ? (schoolPaid / schoolFees) * 100 : 0;
                    
                    schoolsData.push({
                        id: schoolId,
                        name: school.name,
                        students: schoolStudents,
                        fees: schoolFees,
                        paid: schoolPaid,
                        remaining: schoolFees - schoolPaid,
                        paymentRate: paymentRate,
                        unpaid: schoolUnpaid,
                        partial: schoolPartial,
                        paidCount: schoolPaidCount
                    });
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
                schoolsDataGlobal = schoolsData;
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: Ø£ÙˆÙ„Ø§Ù‹ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ø£ÙƒØ«Ø± Ø£ÙˆÙ„Ø§Ù‹)ØŒ Ø«Ù… Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
                schoolsData.sort((a, b) => {
                    if (b.students !== a.students) {
                        return b.students - a.students; // Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø§Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
                    }
                    return b.paymentRate - a.paymentRate; // Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹
                });
                
                // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                renderSchoolsList(schoolsData);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø§Ù…
                const totalHtml = '<div class="col-12 mb-4">' +
                    '<div class="stats-box" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">' +
                        '<div class="row text-center">' +
                            '<div class="col-md-3">' +
                                '<h3><i class="bi bi-people"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>' +
                                '<p style="font-size: 2rem;">' + totalStudents + '</p>' +
                            '</div>' +
                            '<div class="col-md-3">' +
                                '<h3><i class="bi bi-cash-stack"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h3>' +
                                '<p style="font-size: 2rem;">' + totalFees.toLocaleString('en-US') + ' Ø¯.Ø¹</p>' +
                            '</div>' +
                            '<div class="col-md-3">' +
                                '<h3><i class="bi bi-check-circle"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h3>' +
                                '<p style="font-size: 2rem;">' + totalPaid.toLocaleString('en-US') + ' Ø¯.Ø¹</p>' +
                            '</div>' +
                            '<div class="col-md-3">' +
                                '<h3><i class="bi bi-clock"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>' +
                                '<p style="font-size: 2rem;">' + (totalFees - totalPaid).toLocaleString('en-US') + ' Ø¯.Ø¹</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="row text-center mt-3">' +
                            '<div class="col-md-4">' +
                                '<small class="text-white-50">Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: <strong>' + totalPaidStudents + '</strong></small>' +
                            '</div>' +
                            '<div class="col-md-4">' +
                                '<small class="text-white-50">Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ: <strong>' + totalPartial + '</strong></small>' +
                            '</div>' +
                            '<div class="col-md-4">' +
                                '<small class="text-white-50">ØºÙŠØ± Ù…Ø³Ø¯Ø¯: <strong>' + totalUnpaid + '</strong></small>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                
                statsContainer.innerHTML = totalHtml;
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                setTimeout(() => {
                    updateDashboardStats(totalStudents, totalFees, totalPaid, schoolsData);
                }, 100);
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ø¨Ø§Ø´Ø±Ø©
                const totalSchoolsEl = document.getElementById('totalSchoolsCount');
                if (totalSchoolsEl && schools) {
                    totalSchoolsEl.textContent = Object.keys(schools).length;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
                setTimeout(() => {
                    createCharts(schoolsData);
                }, 200);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', error);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function updateDashboardStats(totalStudents, totalFees, totalPaid, schoolsData) {
            const totalSchoolsEl = document.getElementById('totalSchoolsCount');
            const totalStudentsEl = document.getElementById('totalStudentsCount');
            const totalFeesEl = document.getElementById('totalFeesAmount');
            const overallRateEl = document.getElementById('overallPaymentRate');
            
            if (totalSchoolsEl) {
                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ù† ÙƒØ§Ø¦Ù† schools ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ø·Ù„Ø§Ø¨
                const totalSchoolsCount = schools ? Object.keys(schools).length : (schoolsData ? schoolsData.length : 0);
                totalSchoolsEl.textContent = totalSchoolsCount;
            }
            if (totalStudentsEl) {
                totalStudentsEl.textContent = totalStudents ? totalStudents.toLocaleString('en-US') : '0';
            }
            if (totalFeesEl) {
                totalFeesEl.textContent = totalFees ? (totalFees / 1000000).toFixed(1) + 'M' : '0M';
            }
            if (overallRateEl) {
                const overallRate = totalFees > 0 ? (totalPaid / totalFees) * 100 : 0;
                overallRateEl.textContent = overallRate.toFixed(1) + '%';
            }
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        function createCharts(schoolsData) {
            if (!schoolsData || schoolsData.length === 0) {
                console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©');
                return;
            }
            
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
            if (chartsInstances.studentsChart) {
                chartsInstances.studentsChart.destroy();
            }
            if (chartsInstances.paymentChart) {
                chartsInstances.paymentChart.destroy();
            }
            
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
            const studentsCtx = document.getElementById('studentsDistributionChart');
            if (studentsCtx && typeof Chart !== 'undefined') {
                chartsInstances.studentsChart = new Chart(studentsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: schoolsData.map(s => s.name),
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
                            data: schoolsData.map(s => s.students),
                            backgroundColor: [
                                'rgba(15, 118, 110, 0.8)',
                                'rgba(139, 69, 19, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(231, 76, 60, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                rtl: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': ' + context.parsed + ' Ø·Ø§Ù„Ø¨ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
            const paymentCtx = document.getElementById('paymentRateChart');
            if (paymentCtx && typeof Chart !== 'undefined') {
                chartsInstances.paymentChart = new Chart(paymentCtx, {
                    type: 'bar',
                    data: {
                        labels: schoolsData.map(s => s.name),
                        datasets: [{
                            label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ (%)',
                            data: schoolsData.map(s => parseFloat(s.paymentRate.toFixed(1))),
                            backgroundColor: schoolsData.map(s => {
                                if (s.paymentRate >= 80) return 'rgba(67, 233, 123, 0.8)';
                                if (s.paymentRate >= 50) return 'rgba(255, 193, 7, 0.8)';
                                return 'rgba(231, 76, 60, 0.8)';
                            }),
                            borderColor: schoolsData.map(s => {
                                if (s.paymentRate >= 80) return 'rgba(67, 233, 123, 1)';
                                if (s.paymentRate >= 50) return 'rgba(255, 193, 7, 1)';
                                return 'rgba(231, 76, 60, 1)';
                            }),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
        let currentSortBy = 'students';
        function sortSchoolsBy(sortType) {
            currentSortBy = sortType;
            const schoolsData = [...schoolsDataGlobal];
            
            schoolsData.sort((a, b) => {
                if (sortType === 'students') {
                    return b.students - a.students;
                } else if (sortType === 'payment') {
                    return b.paymentRate - a.paymentRate;
                } else if (sortType === 'fees') {
                    return b.fees - a.fees;
                }
                return 0;
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨
            renderSchoolsList(schoolsData);
        }
        
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
        function renderSchoolsList(schoolsData) {
            const listContainer = document.getElementById('schoolsListContainer');
            let html = '';
            
            schoolsData.forEach((schoolData, index) => {
                const schoolColor = {
                    'rawda': '#8B4513',
                    'rasoul': '#0f766e',
                    'noor': '#f59e0b',
                    'nabi': '#3498db',
                    'thanawiya': '#e74c3c'
                }[schoolData.id] || '#0f766e';
                
                const paymentPercent = schoolData.paymentRate.toFixed(1);
                const progressColor = schoolData.paymentRate >= 80 ? 'success' : schoolData.paymentRate >= 50 ? 'warning' : 'danger';
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡
                const rank = index + 1;
                const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card-custom" style="border-top: 4px solid ${schoolColor}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div class="card-header-custom" style="background: linear-gradient(135deg, ${schoolColor} 0%, ${schoolColor}dd 100%);">
                                <i class="bi bi-building"></i> ${schoolData.name} ${rankIcon}
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-people"></i> Ø§Ù„Ø·Ù„Ø§Ø¨</h6>
                                        <h4 class="mb-0" style="color: ${schoolColor}; font-weight: 700;">${schoolData.students}</h4>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-cash-stack"></i> Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h6>
                                        <h6 class="mb-0" style="color: ${schoolColor}; font-weight: 600;">${schoolData.fees.toLocaleString('en-US')} Ø¯.Ø¹</h6>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-check-circle"></i> Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h6>
                                        <h6 class="mb-0" style="color: ${schoolColor}; font-weight: 600;">${schoolData.paid.toLocaleString('en-US')} Ø¯.Ø¹</h6>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹</small>
                                        <small class="text-muted"><strong>${paymentPercent}%</strong></small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${paymentPercent}%"></div>
                                    </div>
                                </div>
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <small class="text-muted d-block">Ù…Ø³Ø¯Ø¯</small>
                                        <strong style="color: #28a745;">${schoolData.paidCount || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">Ø¬Ø²Ø¦ÙŠ</small>
                                        <strong style="color: #ffc107;">${schoolData.partial || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">ØºÙŠØ± Ù…Ø³Ø¯Ø¯</small>
                                        <strong style="color: #dc3545;">${schoolData.unpaid || 0}</strong>
                                    </div>
                                </div>
                                <div class="text-center mb-2">
                                    <small class="text-muted"><i class="bi bi-clock"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <strong>${schoolData.remaining.toLocaleString('en-US')} Ø¯.Ø¹</strong></small>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <button onclick="filterBySchool('${schoolData.id}'); switchMainTab('students');" class="btn btn-sm btn-primary-custom w-100 mb-2">
                                        <i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ ${schoolData.name}
                                    </button>
                                    <button onclick="showSchoolDetails('${schoolData.id}')" class="btn btn-sm btn-info-custom w-100">
                                        <i class="bi bi-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        function showSchoolDetails(schoolId) {
            const school = schoolsDataGlobal.find(s => s.id === schoolId);
            if (!school) return;
            
            const details = `
                <div class="modal fade" id="schoolDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-building"></i> ØªÙØ§ØµÙŠÙ„ ${school.name}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6><i class="bi bi-people"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨:</span>
                                                <strong>${school.students}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:</span>
                                                <strong class="text-success">${school.paidCount || 0}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ:</span>
                                                <strong class="text-warning">${school.partial || 0}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>ØºÙŠØ± Ù…Ø³Ø¯Ø¯:</span>
                                                <strong class="text-danger">${school.unpaid || 0}</strong>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6><i class="bi bi-cash-stack"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
                                                <strong>${school.fees.toLocaleString('en-US')} Ø¯.Ø¹</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                                                <strong class="text-success">${school.paid.toLocaleString('en-US')} Ø¯.Ø¹</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                                                <strong class="text-danger">${school.remaining.toLocaleString('en-US')} Ø¯.Ø¹</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                                                <strong>${school.paymentRate.toFixed(1)}%</strong>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                                <button type="button" class="btn btn-primary" onclick="filterBySchool('${schoolId}'); switchMainTab('students'); bootstrap.Modal.getInstance(document.getElementById('schoolDetailsModal')).hide();">
                                    <i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ø¥Ø²Ø§Ù„Ø© Modal Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
            const existingModal = document.getElementById('schoolDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Modal Ø¬Ø¯ÙŠØ¯
            document.body.insertAdjacentHTML('beforeend', details);
            const modal = new bootstrap.Modal(document.getElementById('schoolDetailsModal'));
            modal.show();
        }
        
        // ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
        function exportSchoolsReport() {
            if (schoolsDataGlobal.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            let csv = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©,Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨,Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨,Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹,Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ,Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹,Ù…Ø³Ø¯Ø¯,Ø¬Ø²Ø¦ÙŠ,ØºÙŠØ± Ù…Ø³Ø¯Ø¯\n';
            
            schoolsDataGlobal.forEach(school => {
                csv += `${school.name},${school.students},${school.fees},${school.paid},${school.remaining},${school.paymentRate.toFixed(1)}%,${school.paidCount || 0},${school.partial || 0},${school.unpaid || 0}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¯Ø§Ø±Ø³_${new Date().getTime()}.csv`;
            link.click();
            
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ============
        
        function saveFeeSettings() {
            const elementaryFee = document.getElementById('elementaryFee').value;
            const middleFee = document.getElementById('middleFee').value;
            const installmentCount = document.getElementById('installmentCount').value;
            
            localStorage.setItem('elementaryFee', elementaryFee);
            localStorage.setItem('middleFee', middleFee);
            localStorage.setItem('installmentCount', installmentCount);
            
            alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©: ' + parseInt(elementaryFee).toLocaleString('en-US') + ' Ø¯.Ø¹\nØ§Ù„Ù…ØªÙˆØ³Ø·Ø©: ' + parseInt(middleFee).toLocaleString('en-US') + ' Ø¯.Ø¹');
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        function getAnnualFeeByGrade(grade) {
            const elementaryFee = parseInt(localStorage.getItem('elementaryFee')) || 1100000;
            const middleFee = parseInt(localStorage.getItem('middleFee')) || 1300000;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ
            const gradeNum = parseInt(grade?.replace(/[^0-9]/g, '')) || 0;
            
            if (gradeNum >= 1 && gradeNum <= 6) {
                return elementaryFee; // Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
            } else if (gradeNum >= 7 && gradeNum <= 9) {
                return middleFee; // Ù…ØªÙˆØ³Ø·Ø©
            } else if (gradeNum >= 10 && gradeNum <= 12) {
                return middleFee; // Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©
            }
            
            // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
            return elementaryFee;
        }
        
        function saveWhatsAppSettings() {
            const autoWhatsApp = document.getElementById('autoWhatsApp').checked;
            const reminderWhatsApp = document.getElementById('reminderWhatsApp').checked;
            const reminderDays = document.getElementById('reminderDays').value;
            
            localStorage.setItem('autoWhatsApp', autoWhatsApp);
            localStorage.setItem('reminderWhatsApp', reminderWhatsApp);
            localStorage.setItem('reminderDays', reminderDays);
            
            alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // ============ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ============
        
        // ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ
        async function generateMonthlyReport() {
            const monthInput = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø± (1-12):');
            if (!monthInput) return;
            
            const month = parseInt(monthInput);
            if (month < 1 || month > 12) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 12');
                return;
            }
            
            const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                              'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            const monthName = monthNames[month - 1];
            const currentYear = new Date().getFullYear();
            
            try {
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                let monthlyData = [];
                let totalPaid = 0;
                let totalStudents = 0;
                
                for (const student of students) {
                    const installments = student.installments || [];
                    for (const inst of installments) {
                        if (inst.payment_date) {
                            const paymentDate = new Date(inst.payment_date);
                            if (paymentDate.getMonth() + 1 === month && paymentDate.getFullYear() === currentYear) {
                                const paidAmount = inst.amount_paid || inst.amount || 0;
                                if (paidAmount > 0) {
                                    monthlyData.push({
                                        'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': student.name,
                                        'ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': student.guardian,
                                        'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©': student.schoolName || currentSchoolName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                                        'Ø§Ù„ØµÙ': student.grade,
                                        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹': paidAmount,
                                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹': inst.payment_date,
                                        'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': inst.payment_method || 'Ù†Ù‚Ø¯'
                                    });
                                    totalPaid += paidAmount;
                                    totalStudents++;
                                }
                            }
                        }
                    }
                }
                
                if (monthlyData.length === 0) {
                    alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ø´Ù‡Ø± ${monthName} ${currentYear}`);
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(monthlyData);
                XLSX.utils.book_append_sheet(wb, ws, `ØªÙ‚Ø±ÙŠØ± ${monthName}`);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ
                const summaryData = [
                    ['Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ'],
                    ['Ø§Ù„Ø´Ù‡Ø±', monthName],
                    ['Ø§Ù„Ø³Ù†Ø©', currentYear],
                    ['Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª', monthlyData.length],
                    ['Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', totalStudents],
                    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', totalPaid]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Ù…Ù„Ø®Øµ');
                
                XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±ÙŠ_${monthName}_${currentYear}.xlsx`);
                alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª: ${monthlyData.length}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        }
        
        // ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ
        async function generateYearlyReport() {
            const yearInput = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© (Ù…Ø«Ø§Ù„: 2024):', new Date().getFullYear());
            if (!yearInput) return;
            
            const year = parseInt(yearInput);
            if (isNaN(year) || year < 2000 || year > 2100) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ù†Ø© ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            try {
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©
                let yearlyData = [];
                let totalPaid = 0;
                let totalStudents = new Set();
                let monthlyTotals = {};
                
                for (const student of students) {
                    const installments = student.installments || [];
                    for (const inst of installments) {
                        if (inst.payment_date) {
                            const paymentDate = new Date(inst.payment_date);
                            if (paymentDate.getFullYear() === year) {
                                const paidAmount = inst.amount_paid || inst.amount || 0;
                                if (paidAmount > 0) {
                                    const month = paymentDate.getMonth() + 1;
                                    if (!monthlyTotals[month]) {
                                        monthlyTotals[month] = 0;
                                    }
                                    monthlyTotals[month] += paidAmount;
                                    
                                    yearlyData.push({
                                        'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': student.name,
                                        'ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': student.guardian,
                                        'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©': student.schoolName || currentSchoolName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                                        'Ø§Ù„ØµÙ': student.grade,
                                        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹': paidAmount,
                                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹': inst.payment_date,
                                        'Ø§Ù„Ø´Ù‡Ø±': paymentDate.getMonth() + 1,
                                        'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': inst.payment_method || 'Ù†Ù‚Ø¯'
                                    });
                                    totalPaid += paidAmount;
                                    totalStudents.add(student.id);
                                }
                            }
                        }
                    }
                }
                
                if (yearlyData.length === 0) {
                    alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ø³Ù†Ø© ${year}`);
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(yearlyData);
                XLSX.utils.book_append_sheet(wb, ws, `Ø¯ÙØ¹Ø§Øª ${year}`);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ
                const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                                  'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                const monthlySummary = [['Ø§Ù„Ø´Ù‡Ø±', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹']];
                for (let m = 1; m <= 12; m++) {
                    monthlySummary.push([monthNames[m - 1], monthlyTotals[m] || 0]);
                }
                const monthlyWs = XLSX.utils.aoa_to_sheet(monthlySummary);
                XLSX.utils.book_append_sheet(wb, monthlyWs, 'Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ');
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø¹Ø§Ù…
                const summaryData = [
                    ['Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ'],
                    ['Ø§Ù„Ø³Ù†Ø©', year],
                    ['Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª', yearlyData.length],
                    ['Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', totalStudents.size],
                    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', totalPaid],
                    ['Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯ÙØ¹Ø©', Math.round(totalPaid / yearlyData.length)]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Ù…Ù„Ø®Øµ Ø¹Ø§Ù…');
                
                XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø³Ù†ÙˆÙŠ_${year}.xlsx`);
                alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª: ${yearlyData.length}\nØ¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${totalStudents.size}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
        function exportToExcel() {
            try {
                if (!students || students.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }
                
                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const excelData = students.map((student, index) => {
                    const installments = student.installments || [];
                    const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                    const annualFee = student.annualFee || student.annual_fee || 1200000;
                    const finalFee = student.finalFee || student.final_fee || annualFee;
                    const remaining = finalFee - totalPaid;
                    const statusInfo = getFinancialStatus(student);
                    
                    return {
                        'Ù…': index + 1,
                        'Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„': student.receiptNumber || '---',
                        'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': student.name,
                        'ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': student.guardian,
                        'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©': student.schoolName || currentSchoolName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        'Ø§Ù„ØµÙ': student.grade,
                        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ': annualFee,
                        'Ø§Ù„Ø®ØµÙ…': student.discount || 0,
                        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ': finalFee,
                        'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': totalPaid,
                        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                        'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©': statusInfo.status,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„': student.registrationDate || student.registration_date || ''
                    };
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨');
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ
                const totalFees = students.reduce((sum, s) => sum + (s.finalFee || s.annualFee || 1200000), 0);
                const totalPaid = students.reduce((sum, s) => {
                    const insts = s.installments || [];
                    return sum + insts.reduce((s, i) => s + (i.amount_paid || i.amount || 0), 0);
                }, 0);
                
                const summaryData = [
                    ['Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'],
                    ['Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', students.length],
                    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨', totalFees],
                    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', totalPaid],
                    ['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', totalFees - totalPaid]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Ù…Ù„Ø®Øµ');
                
                XLSX.writeFile(wb, `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().getTime()}.xlsx`);
                alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© XLSX.');
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
        function exportToPDF() {
            try {
                if (typeof window.jsPDF === 'undefined') {
                    alert('Ù…ÙƒØªØ¨Ø© jsPDF ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©.');
                    printList();
                    return;
                }
                
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                doc.setFontSize(18);
                doc.setTextColor(15, 118, 110);
                doc.text('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø©', 105, 15, { align: 'center' });
                
                // Ø§Ù„ØªØ§Ø±ÙŠØ®
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const now = new Date();
                doc.text(`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${now.toLocaleDateString('ar-IQ')}`, 105, 22, { align: 'center' });
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„
                const tableData = students.map((student, index) => {
                    const installments = student.installments || [];
                    const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                    const annualFee = student.annualFee || student.annual_fee || 1200000;
                    const finalFee = student.finalFee || student.final_fee || annualFee;
                    const remaining = finalFee - totalPaid;
                    const statusInfo = getFinancialStatus(student);
                    
                    return [
                        index + 1,
                        student.receiptNumber || '---',
                        student.name,
                        student.guardian,
                        student.grade,
                        annualFee.toLocaleString('en-US'),
                        totalPaid.toLocaleString('en-US'),
                        remaining.toLocaleString('en-US'),
                        statusInfo.status
                    ];
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„
                doc.autoTable({
                    head: [['Ù…', 'Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„', 'Ø§Ù„Ø§Ø³Ù…', 'ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ù†ÙˆÙŠ', 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©']],
                    body: tableData,
                    startY: 30,
                    styles: { fontSize: 8, font: 'Arial' },
                    headStyles: { fillColor: [15, 118, 110], textColor: 255 },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { top: 30, right: 10, left: 10 }
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
                const totalFees = students.reduce((sum, s) => sum + (s.finalFee || s.annualFee || 1200000), 0);
                const totalPaid = students.reduce((sum, s) => {
                    const insts = s.installments || [];
                    return sum + insts.reduce((s, i) => s + (i.amount_paid || i.amount || 0), 0);
                }, 0);
                
                doc.addPage();
                doc.setFontSize(16);
                doc.setTextColor(15, 118, 110);
                doc.text('Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}`, 20, 40);
                doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${totalFees.toLocaleString('en-US')} Ø¯.Ø¹`, 20, 50);
                doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹`, 20, 60);
                doc.text(`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${(totalFees - totalPaid).toLocaleString('en-US')} Ø¯.Ø¹`, 20, 70);
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                doc.save(`Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().getTime()}.pdf`);
                alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ PDF Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©.');
                printList();
            }
        }
        
        function backupData() {
            const data = {
                students: allStudents,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${new Date().getTime()}.json`;
            link.click();
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                        } catch (error) {
                            alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function clearCache() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©ØŸ')) {
                localStorage.clear();
                alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
                location.reload();
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        window.addEventListener('DOMContentLoaded', function() {
            const elementaryFee = localStorage.getItem('elementaryFee');
            const middleFee = localStorage.getItem('middleFee');
            const installmentCount = localStorage.getItem('installmentCount');
            const autoWhatsApp = localStorage.getItem('autoWhatsApp') === 'true';
            const reminderWhatsApp = localStorage.getItem('reminderWhatsApp') === 'true';
            const reminderDays = localStorage.getItem('reminderDays');
            
            if (elementaryFee) document.getElementById('elementaryFee').value = elementaryFee;
            if (middleFee) document.getElementById('middleFee').value = middleFee;
            if (installmentCount) document.getElementById('installmentCount').value = installmentCount;
            if (autoWhatsApp !== null) document.getElementById('autoWhatsApp').checked = autoWhatsApp;
            if (reminderWhatsApp !== null) document.getElementById('reminderWhatsApp').checked = reminderWhatsApp;
            if (reminderDays) document.getElementById('reminderDays').value = reminderDays;
        });

        // ============ Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ============
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨
        function sendWhatsAppMessage(studentId, messageType, paymentData = null) {
            const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
            if (!student) {
                alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            const phone = student.phone || '';
            if (!phone) {
                alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù„Ø·Ø§Ù„Ø¨');
                return;
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²)
            let cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (964 Ù„Ù„Ø¹Ø±Ø§Ù‚)
            if (!cleanPhone.startsWith('964') && !cleanPhone.startsWith('+964')) {
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = '964' + cleanPhone.substring(1);
                } else {
                    cleanPhone = '964' + cleanPhone;
                }
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© + Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            cleanPhone = cleanPhone.replace(/^\+/, '');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            let message = '';
            const schoolName = currentSchoolName || 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ø³ÙˆÙ„ Ø§Ù„Ø±Ø­Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©';
            
            if (messageType === 'payment' && paymentData) {
                // Ø±Ø³Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹
                const installmentNames = ['Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø±Ø§Ø¨Ø¹'];
                const installmentName = installmentNames[paymentData.installmentNumber - 1] || 'Ø§Ù„Ø£ÙˆÙ„';
                
                const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                
                message = `*${schoolName}*\n\n` +
                    `*Ø¥Ø´Ø¹Ø§Ø± Ø§Ø³ØªÙ„Ø§Ù… Ø¯ÙØ¹Ø©*\n\n` +
                    `Ø§Ù„Ø³ÙŠØ¯/Ø§Ù„Ø³ÙŠØ¯Ø© ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.guardian}*\n` +
                    `Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.name}*\n` +
                    `Ø§Ù„ØµÙ: *${student.grade}*\n` +
                    `Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: *${getStudentField(student, 'receiptNumber') || '---'}*\n\n` +
                    `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº: *${paymentData.amount.toLocaleString('en-US')} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n` +
                    `ÙˆÙ‡Ùˆ Ø§Ù„Ù‚Ø³Ø·: *${installmentName}*\n` +
                    `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹: *${formatDateArabic(paymentData.paymentDate)}*\n\n` +
                    `*Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨:*\n` +
                    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${finalFee.toLocaleString('en-US')} Ø¯.Ø¹\n` +
                    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹\n` +
                    `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toLocaleString('en-US')} Ø¯.Ø¹\n\n` +
                    `Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ… Ø¹Ù„Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·.\n` +
                    `*${schoolName}*`;
                    
            } else if (messageType === 'reminder') {
                // Ø±Ø³Ø§Ù„Ø© ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¯ÙØ¹
                const installments = student.installments || [];
                const installmentAmount = calculateInstallmentAmount(student);
                const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                
                // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                const unpaidInstallments = [];
                installments.forEach((inst, index) => {
                    const paid = inst.amount_paid || inst.amount || 0;
                    if (paid < installmentAmount) {
                        const installmentNames = ['Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø±Ø§Ø¨Ø¹'];
                        unpaidInstallments.push({
                            number: index + 1,
                            name: installmentNames[index],
                            paid: paid,
                            required: installmentAmount,
                            remaining: installmentAmount - paid
                        });
                    }
                });
                
                message = `*${schoolName}*\n\n` +
                    `*ØªØ°ÙƒÙŠØ± Ø¨Ø¯ÙØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©*\n\n` +
                    `Ø§Ù„Ø³ÙŠØ¯/Ø§Ù„Ø³ÙŠØ¯Ø© ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.guardian}*\n` +
                    `Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.name}*\n` +
                    `Ø§Ù„ØµÙ: *${student.grade}*\n` +
                    `Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: *${getStudentField(student, 'receiptNumber') || '---'}*\n\n`;
                
                if (unpaidInstallments.length > 0) {
                    message += `*Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:*\n`;
                    unpaidInstallments.forEach(inst => {
                        message += `- Ø§Ù„Ù‚Ø³Ø· ${inst.name}: ${inst.remaining.toLocaleString('en-US')} Ø¯.Ø¹ (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${inst.required.toLocaleString('en-US')} Ø¯.Ø¹)\n`;
                    });
                    message += `\n`;
                }
                
                message += `*Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨:*\n` +
                    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${finalFee.toLocaleString('en-US')} Ø¯.Ø¹\n` +
                    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid.toLocaleString('en-US')} Ø¯.Ø¹\n` +
                    `*Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toLocaleString('en-US')} Ø¯.Ø¹*\n\n` +
                    `Ù†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ø§Ù„ØªÙƒØ±Ù… Ø¨ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.\n\n` +
                    `Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ…\n` +
                    `*${schoolName}*`;
                    
            } else {
                // Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
                message = `*${schoolName}*\n\n` +
                    `Ø§Ù„Ø³ÙŠØ¯/Ø§Ù„Ø³ÙŠØ¯Ø© ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.guardian}*\n` +
                    `Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: *${student.name}*\n` +
                    `Ø§Ù„ØµÙ: *${student.grade}*\n\n` +
                    `Ù†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.\n\n` +
                    `*${schoolName}*`;
            }
            
            // ØªØ±Ù…ÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø§Ø¨Ø·
            const encodedMessage = encodeURIComponent(message);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
            window.open(whatsappUrl, '_blank');
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†
        function sendBulkWhatsAppReminders() {
            const unpaidStudents = students.filter(student => {
                const installments = student.installments || [];
                const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                return remaining > 0 && student.phone;
            });
            
            if (unpaidStudents.length === 0) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…ØªØ£Ø®Ø±ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆØ§ØªÙ');
                return;
            }
            
            const confirmMessage = `Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¥Ù„Ù‰ ${unpaidStudents.length} ÙˆÙ„ÙŠ Ø£Ù…Ø±.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
            let index = 0;
            const sendNext = () => {
                if (index < unpaidStudents.length) {
                    const student = unpaidStudents[index];
                    sendWhatsAppMessage(student.id, 'reminder');
                    index++;
                    if (index < unpaidStudents.length) {
                        setTimeout(sendNext, 2000); // ØªØ£Ø®ÙŠØ± Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©
                    } else {
                        alert(`ØªÙ… ÙØªØ­ ${unpaidStudents.length} Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰.`);
                    }
                }
            };
            
            sendNext();
        }
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        function formatDateArabic(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            
            const monthNames = [
                'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            return `${day} ${monthNames[month - 1]} ${year}`;
        }

    </script>
</body>
</html>
